<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lintoria Hub V4.02 - Ultimate Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #60a5fa;
            --primary-glow: #3b82f6;
            
            --gold: #fbbf24;
            --gold-dark: #f59e0b;
            --gold-light: #fcd34d;
            --gold-glow: #facc15;
            
            --accent: #0ea5e9;
            --accent-dark: #0284c7;
            --accent-light: #38bdf8;
            
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            
            --bg-primary: #050817;
            --bg-secondary: #0f172a;
            --bg-tertiary: #1e293b;
            --bg-card: rgba(15, 23, 42, 0.8);
            
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            
            --border: rgba(148, 163, 184, 0.1);
            --border-light: rgba(148, 163, 184, 0.2);
            
            --rarity-common: #ffffff;
            --rarity-uncommon: #22c55e;
            --rarity-rare: #3b82f6;
            --rarity-epic: #a855f7;
            --rarity-legendary: #fbbf24;
            --rarity-mythic: #ec4899;
            --rarity-divine: #06b6d4;
            
            --gradient-blue-gold: linear-gradient(135deg, #2563eb 0%, #fbbf24 100%);
            --gradient-gold-blue: linear-gradient(135deg, #fbbf24 0%, #2563eb 100%);
            --gradient-blue: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
            --gradient-gold: linear-gradient(135deg, #f59e0b 0%, #fbbf24 50%, #fcd34d 100%);
            --gradient-premium: linear-gradient(135deg, #1e40af 0%, #fbbf24 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        .interactive-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .grid-layer {
            position: absolute;
            top: 0;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: 
                linear-gradient(rgba(37, 99, 235, 0.08) 2px, transparent 2px),
                linear-gradient(90deg, rgba(37, 99, 235, 0.08) 2px, transparent 2px);
            background-size: 80px 80px;
            transform: perspective(500px) rotateX(60deg) translateY(-50%);
            transform-origin: center center;
            animation: gridScroll 20s linear infinite;
        }

        @keyframes gridScroll {
            0% { transform: perspective(500px) rotateX(60deg) translateY(-50%); }
            100% { transform: perspective(500px) rotateX(60deg) translateY(calc(-50% + 80px)); }
        }

        .particle-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #fbbf24 0%, rgba(251, 191, 36, 0.6) 40%, transparent 70%);
            border-radius: 50%;
            animation: floatUp linear infinite;
            opacity: 0;
            box-shadow: 0 0 10px 3px rgba(251, 191, 36, 0.6);
        }

        .particle.blue {
            background: radial-gradient(circle, #3b82f6 0%, rgba(59, 130, 246, 0.6) 40%, transparent 70%);
            box-shadow: 0 0 10px 3px rgba(59, 130, 246, 0.6);
        }

        @keyframes floatUp {
            0% { transform: translateY(100vh) scale(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-20vh) scale(1); opacity: 0; }
        }

        .glow-system {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .glow-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            mix-blend-mode: screen;
            pointer-events: none;
        }

        .orb-primary {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(37, 99, 235, 0.5) 0%, transparent 70%);
        }

        .orb-secondary {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(251, 191, 36, 0.4) 0%, transparent 70%);
        }

        .app-container {
            position: relative;
            z-index: 10;
            min-height: 100vh;
            padding: 2rem;
            animation: fadeInUp 0.8s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .glass-card {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(251, 191, 36, 0.05) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 30px 40px -5px rgba(37, 99, 235, 0.3);
        }

        .logo-container {
            display: inline-flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .logo-icon {
            width: 70px;
            height: 70px;
            background: var(--gradient-blue-gold);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
            box-shadow: 0 10px 40px rgba(37, 99, 235, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .logo-text {
            font-family: 'Poppins', sans-serif;
            font-size: 3rem;
            font-weight: 800;
            background: var(--gradient-blue-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--gradient-gold);
            color: var(--bg-primary);
            font-size: 0.75rem;
            font-weight: 800;
            border-radius: 20px;
            margin-left: 1rem;
        }

        .disclaimer-banner {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(251, 191, 36, 0.2) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }

        .disclaimer-banner strong {
            color: var(--danger);
        }

        .tab-container {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(251, 191, 36, 0.1) 100%);
            border: 1px solid var(--border);
            border-radius: 24px;
            margin-bottom: 2rem;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .tab-section {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            position: relative;
        }

        .tab-section::before {
            content: attr(data-label);
            position: absolute;
            top: -10px;
            left: 16px;
            font-size: 10px;
            font-weight: 700;
            color: var(--gold);
            background: var(--bg-secondary);
            padding: 0 10px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .tab-btn {
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);
            color: var(--text-secondary);
            border: 1px solid transparent;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            transform: translateY(-2px);
            border-color: rgba(251, 191, 36, 0.3);
        }

        .tab-btn.active {
            background: var(--gradient-blue-gold);
            color: white;
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4);
        }

        .tab-icon {
            margin-right: 0.5rem;
            font-size: 1.125rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-input, select, textarea {
            width: 100%;
            padding: 1rem 1.5rem;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid var(--border);
            border-radius: 14px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--gold);
            background: rgba(15, 23, 42, 0.8);
            box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.1);
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 14px;
            font-weight: 700;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: var(--gradient-blue);
            color: white;
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(37, 99, 235, 0.5);
        }

        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-success {
            background: var(--gradient-gold);
            color: var(--bg-primary);
            box-shadow: 0 10px 25px rgba(251, 191, 36, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .balance-card {
            background: var(--gradient-premium);
            padding: 3rem;
            border-radius: 28px;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 30px 60px rgba(37, 99, 235, 0.4);
        }

        .balance-label {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .balance-amount {
            font-size: 4rem;
            font-weight: 900;
            color: white;
            text-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            font-family: 'Space Grotesk', sans-serif;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(251, 191, 36, 0.05) 100%);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .transaction-item:hover {
            transform: translateX(8px);
            box-shadow: 0 10px 30px rgba(37, 99, 235, 0.2);
        }

        .stock-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .stock-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(37, 99, 235, 0.2);
            border-color: var(--gold);
        }

        .service-card {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08) 0%, rgba(251, 191, 36, 0.08) 100%);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(37, 99, 235, 0.2);
        }

        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .toast {
            position: fixed;
            top: 2rem;
            right: -400px;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.95) 0%, rgba(251, 191, 36, 0.95) 100%);
            border-radius: 14px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transition: right 0.5s ease;
            z-index: 2000;
            color: white;
            font-weight: 600;
            min-width: 300px;
        }

        .toast.show { right: 2rem; }
        .toast.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .toast.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }

        .hidden { display: none !important; }

        .tab-content {
            animation: contentFade 0.5s ease-out;
        }

        @keyframes contentFade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .section-header h2 {
            font-weight: 700;
            color: var(--gold);
        }

        .section-header .badge {
            padding: 0.25rem 0.75rem;
            background: rgba(251, 191, 36, 0.2);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--gold);
        }

        /* Chat Styles */
        .chat-container {
            height: 400px;
            overflow-y: auto;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .chat-message {
            margin-bottom: 0.75rem;
            padding: 0.75rem 1rem;
            background: rgba(37, 99, 235, 0.1);
            border-radius: 12px;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .chat-username {
            font-weight: 700;
            color: var(--gold);
            font-size: 0.875rem;
        }

        .chat-text {
            color: var(--text-primary);
            margin-top: 0.25rem;
        }

        .chat-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
        }

        /* Emoji/Pack Styles */
        .pack-card {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(251, 191, 36, 0.1) 100%);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .pack-card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: var(--gold);
            box-shadow: 0 20px 40px rgba(251, 191, 36, 0.3);
        }

        .pack-emojis {
            font-size: 1.5rem;
            margin: 1rem 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.25rem;
        }

        .emoji-card {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            border-radius: 12px;
            min-width: 80px;
            margin: 0.25rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .emoji-card:hover {
            transform: scale(1.1);
        }

        .emoji-card .emoji {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .emoji-card.common { background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%); border: 1px solid var(--rarity-common); }
        .emoji-card.uncommon { background: linear-gradient(135deg, rgba(34,197,94,0.2) 0%, rgba(34,197,94,0.1) 100%); border: 1px solid var(--rarity-uncommon); }
        .emoji-card.rare { background: linear-gradient(135deg, rgba(59,130,246,0.2) 0%, rgba(59,130,246,0.1) 100%); border: 1px solid var(--rarity-rare); }
        .emoji-card.epic { background: linear-gradient(135deg, rgba(168,85,247,0.2) 0%, rgba(168,85,247,0.1) 100%); border: 1px solid var(--rarity-epic); }
        .emoji-card.legendary { background: linear-gradient(135deg, rgba(251,191,36,0.2) 0%, rgba(251,191,36,0.1) 100%); border: 1px solid var(--rarity-legendary); animation: legendaryGlow 2s ease-in-out infinite; }
        .emoji-card.mythic { background: linear-gradient(135deg, rgba(236,72,153,0.2) 0%, rgba(236,72,153,0.1) 100%); border: 1px solid var(--rarity-mythic); animation: mythicGlow 1.5s ease-in-out infinite; }
        .emoji-card.divine { background: linear-gradient(135deg, rgba(6,182,212,0.3) 0%, rgba(6,182,212,0.1) 100%); border: 2px solid var(--rarity-divine); animation: divineGlow 1s ease-in-out infinite; }

        @keyframes legendaryGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(251,191,36,0.3); }
            50% { box-shadow: 0 0 20px rgba(251,191,36,0.6); }
        }

        @keyframes mythicGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(236,72,153,0.4); }
            50% { box-shadow: 0 0 30px rgba(236,72,153,0.7); }
        }

        @keyframes divineGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(6,182,212,0.5), 0 0 40px rgba(6,182,212,0.3); }
            50% { box-shadow: 0 0 40px rgba(6,182,212,0.8), 0 0 60px rgba(6,182,212,0.5); }
        }

        .rarity-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .rarity-badge.common { background: var(--rarity-common); color: #000; }
        .rarity-badge.uncommon { background: var(--rarity-uncommon); color: #000; }
        .rarity-badge.rare { background: var(--rarity-rare); color: #fff; }
        .rarity-badge.epic { background: var(--rarity-epic); color: #fff; }
        .rarity-badge.legendary { background: var(--rarity-legendary); color: #000; }
        .rarity-badge.mythic { background: var(--rarity-mythic); color: #fff; }
        .rarity-badge.divine { background: var(--rarity-divine); color: #000; }

        /* Casino Games */
        .casino-game {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(251, 191, 36, 0.08) 100%);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        /* PLINKO */
        .plinko-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 1rem auto;
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.9) 100%);
            border-radius: 16px;
            padding: 1rem;
            overflow: hidden;
        }

        .plinko-board {
            position: relative;
            width: 100%;
            height: 350px;
        }

        .plinko-peg {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--gold);
            border-radius: 50%;
            box-shadow: 0 0 6px var(--gold);
        }

        .plinko-ball {
            position: absolute;
            width: 16px;
            height: 16px;
            background: radial-gradient(circle at 30% 30%, #ff6b6b, #ee5a5a);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.8), inset 0 -2px 4px rgba(0,0,0,0.3);
            z-index: 10;
            display: none;
        }

        .plinko-slots {
            display: flex;
            justify-content: space-between;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
        }

        .plinko-slot {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 700;
            border-radius: 4px 4px 0 0;
            margin: 0 1px;
            transition: all 0.3s ease;
        }

        .plinko-slot.x100 { background: linear-gradient(180deg, #ef4444, #dc2626); }
        .plinko-slot.x50 { background: linear-gradient(180deg, #f97316, #ea580c); }
        .plinko-slot.x25 { background: linear-gradient(180deg, #eab308, #ca8a04); }
        .plinko-slot.x10 { background: linear-gradient(180deg, #84cc16, #65a30d); }
        .plinko-slot.x5 { background: linear-gradient(180deg, #22c55e, #16a34a); }
        .plinko-slot.x2 { background: linear-gradient(180deg, #06b6d4, #0891b2); }
        .plinko-slot.x1 { background: linear-gradient(180deg, #3b82f6, #2563eb); }
        .plinko-slot.x05 { background: linear-gradient(180deg, #8b5cf6, #7c3aed); }
        .plinko-slot.x03 { background: linear-gradient(180deg, #a855f7, #9333ea); }
        .plinko-slot.x01 { background: linear-gradient(180deg, #6b7280, #4b5563); }

        .plinko-slot.active {
            transform: scale(1.1);
            box-shadow: 0 0 20px currentColor;
        }

        /* ROULETTE */
        .roulette-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 1rem auto;
        }

        .roulette-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            border: 6px solid var(--gold);
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.5), inset 0 0 30px rgba(0,0,0,0.5);
            transition: transform 0s;
        }

        .roulette-wheel.spinning {
            transition: transform 5s cubic-bezier(0.17, 0.67, 0.12, 0.99);
        }

        .roulette-number {
            position: absolute;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            border-radius: 50%;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .roulette-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: var(--gradient-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
        }

        .roulette-pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid var(--gold);
            z-index: 10;
            filter: drop-shadow(0 0 10px var(--gold));
        }

        /* FORTUNE WHEEL */
        .wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 1rem auto;
        }

        .fortune-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            border: 8px solid var(--gold);
            box-shadow: 0 0 40px rgba(251, 191, 36, 0.6);
            overflow: hidden;
            transition: transform 0s;
        }

        .fortune-wheel.spinning {
            transition: transform 6s cubic-bezier(0.17, 0.67, 0.05, 0.99);
        }

        .wheel-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            left: 50%;
            top: 50%;
            transform-origin: 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .wheel-segment span {
            transform: rotate(70deg) translateY(-60px);
            display: block;
        }

        .wheel-pointer-top {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 35px solid var(--gold);
            z-index: 10;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
        }

        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: var(--gradient-gold);
            border-radius: 50%;
            z-index: 5;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
        }

        /* DICE */
        .dice-container {
            perspective: 600px;
            width: 100px;
            height: 100px;
            margin: 1rem auto;
        }

        .dice {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1s ease-out;
        }

        .dice.rolling {
            animation: rollDice 1s ease-out;
        }

        @keyframes rollDice {
            0% { transform: rotateX(0) rotateY(0) rotateZ(0); }
            25% { transform: rotateX(180deg) rotateY(90deg) rotateZ(45deg); }
            50% { transform: rotateX(360deg) rotateY(180deg) rotateZ(90deg); }
            75% { transform: rotateX(540deg) rotateY(270deg) rotateZ(135deg); }
            100% { transform: rotateX(720deg) rotateY(360deg) rotateZ(180deg); }
        }

        .dice-face {
            position: absolute;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #ffffff, #e0e0e0);
            border: 3px solid #333;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
            color: #000000;
        }

        .dice-face.front { transform: translateZ(50px); }
        .dice-face.back { transform: rotateY(180deg) translateZ(50px); }
        .dice-face.right { transform: rotateY(90deg) translateZ(50px); }
        .dice-face.left { transform: rotateY(-90deg) translateZ(50px); }
        .dice-face.top { transform: rotateX(90deg) translateZ(50px); }
        .dice-face.bottom { transform: rotateX(-90deg) translateZ(50px); }

        /* SLOTS */
        .slots-machine {
            background: linear-gradient(180deg, #1a1a2e, #16213e);
            border-radius: 20px;
            padding: 2rem;
            max-width: 350px;
            margin: 1rem auto;
            border: 4px solid var(--gold);
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
        }

        .slots-display {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            background: #0a0a0a;
            padding: 1rem;
            border-radius: 12px;
            border: 3px solid #333;
        }

        .slot-reel {
            width: 70px;
            height: 80px;
            background: linear-gradient(180deg, #1a1a1a, #2a2a2a);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            overflow: hidden;
            position: relative;
            border: 2px solid #444;
        }

        .slot-reel.spinning .slot-symbol {
            animation: slotSpin 0.1s linear infinite;
        }

        @keyframes slotSpin {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        .slot-reel .slot-symbol {
            transition: transform 0.3s ease-out;
        }

        /* BLACKJACK */
        .blackjack-table {
            background: linear-gradient(135deg, #0f5132, #198754);
            border-radius: 100px 100px 20px 20px;
            padding: 2rem;
            max-width: 400px;
            margin: 1rem auto;
            border: 8px solid #5c4033;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.3);
        }

        .card-hand {
            display: flex;
            justify-content: center;
            gap: -20px;
            min-height: 100px;
            margin: 1rem 0;
        }

        .playing-card {
            width: 60px;
            height: 84px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            margin-left: -15px;
            transition: all 0.3s ease;
            animation: dealCard 0.3s ease-out;
        }

        .playing-card:first-child {
            margin-left: 0;
        }

        .playing-card.red { color: #dc2626; }
        .playing-card.black { color: #1f2937; }

        @keyframes dealCard {
            from { transform: translateY(-50px) rotate(-10deg); opacity: 0; }
            to { transform: translateY(0) rotate(0); opacity: 1; }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 8, 23, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content { transform: scale(1); }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-close:hover { color: var(--danger); }

        .tax-info {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        /* Pack Opening Animation */
        .pack-opening {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 8, 23, 0.95);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: packFadeIn 0.5s ease-out;
        }

        @keyframes packFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .pack-reveal {
            font-size: 8rem;
            animation: packReveal 1s ease-out;
        }

        @keyframes packReveal {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .pack-rarity-text {
            font-size: 2rem;
            font-weight: 800;
            margin-top: 1rem;
            animation: rarityPop 0.5s ease-out 0.5s both;
        }

        @keyframes rarityPop {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Chances Table */
        .chances-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .chances-table th, .chances-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .chances-table th {
            color: var(--gold);
            font-weight: 700;
        }

        /* Verification */
        .verification-code-input {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin: 1.5rem 0;
        }

        .verification-code-input input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
        }

        .verification-code-input input:focus {
            border-color: var(--gold);
            outline: none;
        }

        /* ========== NEW V4.02: LOANS SYSTEM ========== */
        .credit-score-container {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(251, 191, 36, 0.1) 100%);
            border-radius: 20px;
            margin-bottom: 2rem;
        }

        .credit-gauge {
            position: relative;
            width: 200px;
            height: 100px;
            margin: 0 auto 1rem;
            overflow: hidden;
        }

        .credit-gauge-bg {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: conic-gradient(
                #ef4444 0deg 60deg,
                #f97316 60deg 90deg,
                #fbbf24 90deg 120deg,
                #84cc16 120deg 150deg,
                #22c55e 150deg 180deg,
                transparent 180deg 360deg
            );
            clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%);
        }

        .credit-gauge-needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 4px;
            height: 80px;
            background: white;
            transform-origin: bottom center;
            transition: transform 1s ease-out;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        .credit-gauge-center {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: var(--gold);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--gold);
        }

        .credit-score-value {
            font-size: 3rem;
            font-weight: 900;
            font-family: 'Space Grotesk', sans-serif;
        }

        .credit-score-label {
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .credit-excellent { color: #22c55e; }
        .credit-good { color: #84cc16; }
        .credit-fair { color: #fbbf24; }
        .credit-poor { color: #f97316; }
        .credit-bad { color: #ef4444; }

        .loan-type-card {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .loan-type-card:hover {
            border-color: var(--gold);
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(251, 191, 36, 0.2);
        }

        .loan-type-card.selected {
            border-color: var(--gold);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(37, 99, 235, 0.1) 100%);
        }

        .loan-type-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .loan-active-card {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(251, 191, 36, 0.1) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .loan-progress {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .loan-progress-bar {
            height: 100%;
            background: var(--gradient-gold);
            transition: width 0.5s ease;
        }

        .loan-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .loan-status.active { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .loan-status.overdue { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .loan-status.paid { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .loan-status.defaulted { background: rgba(239, 68, 68, 0.3); color: #ef4444; }

        /* Reset Account */
        .reset-warning {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(251, 191, 36, 0.1) 100%);
            border: 2px solid rgba(239, 68, 68, 0.5);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .reset-calculation {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: 'Space Grotesk', monospace;
        }

        .reset-calculation-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .reset-calculation-row:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--gold);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--gold);
            font-family: 'Space Grotesk', sans-serif;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0.5rem;
        }

        @media (max-width: 768px) {
            .logo-text { font-size: 2rem; }
            .balance-amount { font-size: 3rem; }
            .tab-container { flex-direction: column; }
            .tab-section { width: 100%; }
            .plinko-container { max-width: 100%; }
            .roulette-container, .wheel-container { width: 250px; height: 250px; }
            .credit-score-value { font-size: 2rem; }
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold); }
    </style>
</head>
<body>
    <div class="interactive-bg">
        <div class="grid-layer"></div>
        <div class="particle-container" id="particleContainer"></div>
    </div>

    <div class="glow-system" id="glowSystem">
        <div class="glow-orb orb-primary" id="glowOrb1"></div>
        <div class="glow-orb orb-secondary" id="glowOrb2"></div>
    </div>

    <div class="app-container">
        <!-- Auth Screen -->
        <div id="authScreen">
            <div style="max-width: 500px; margin: 0 auto;">
                <div class="logo-container">
                    <div class="logo-icon">üèõÔ∏è</div>
                    <span class="logo-text">Lintoria</span>
                    <span class="logo-badge">V4.02</span>
                </div>

                <div class="disclaimer-banner">
                    <strong>‚ö†Ô∏è DISCLAIMER:</strong> Lintoria Hub is a <strong>virtual economy simulation game</strong> using fictional currency only. 
                    No real money is involved. This application holds <strong>no responsibility</strong> for any misuse, including but not limited to 
                    playing during school, work, or other inappropriate times. By using this application, you acknowledge that this is purely for 
                    entertainment purposes. <strong>Gamble responsibly - even with fake money!</strong>
                </div>

                <div class="glass-card">
                    <div id="authTabs">
                        <div class="tab-container" style="margin-bottom: 2rem;">
                            <button class="tab-btn active" onclick="switchAuthTab('login')">
                                <span class="tab-icon">üîê</span>Login
                            </button>
                            <button class="tab-btn" onclick="switchAuthTab('register')">
                                <span class="tab-icon">‚ú®</span>Register
                            </button>
                        </div>

                        <div id="loginTab">
                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password">
                            </div>
                            <button class="btn" onclick="login()" style="width: 100%;">Sign In</button>
                        </div>

                        <div id="registerTab" class="hidden">
                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" id="registerEmail" class="form-input" placeholder="Your email">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" id="registerName" class="form-input" placeholder="Your full name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" id="registerPassword" class="form-input" placeholder="Choose a password">
                            </div>
                            <button class="btn btn-success" onclick="register()" style="width: 100%;">Create Account</button>
                        </div>
                    </div>

                    <div id="verificationScreen" class="hidden">
                        <div style="text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üìß</div>
                            <h2 style="color: var(--gold); margin-bottom: 0.5rem;">Verify Your Email</h2>
                            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                                We sent a 6-digit code to <strong id="verifyEmailDisplay"></strong>
                            </p>
                            
                            <div class="verification-code-input">
                                <input type="text" maxlength="1" id="code1" oninput="handleCodeInput(1)">
                                <input type="text" maxlength="1" id="code2" oninput="handleCodeInput(2)">
                                <input type="text" maxlength="1" id="code3" oninput="handleCodeInput(3)">
                                <input type="text" maxlength="1" id="code4" oninput="handleCodeInput(4)">
                                <input type="text" maxlength="1" id="code5" oninput="handleCodeInput(5)">
                                <input type="text" maxlength="1" id="code6" oninput="handleCodeInput(6)">
                            </div>
                            
                            <button class="btn btn-success" onclick="verifyCode()" style="width: 100%; margin-bottom: 1rem;">Verify Email</button>
                            <button class="btn btn-sm" onclick="resendCode()" style="opacity: 0.7;">Resend Code</button>
                            <br><br>
                            <button class="btn btn-sm btn-danger" onclick="backToLogin()">Back to Login</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main App -->
        <div id="appScreen" class="hidden">
            <div class="disclaimer-banner">
                <strong>‚ö†Ô∏è REMINDER:</strong> This is a <strong>virtual simulation</strong> with <strong>no real money</strong>. 
                For entertainment only. Play responsibly!
            </div>

            <!-- Header -->
            <div class="glass-card" style="margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div class="logo-container" style="margin-bottom: 0;">
                        <div class="logo-icon">üèõÔ∏è</div>
                        <div>
                            <div class="logo-text">Lintoria Hub</div>
                            <div style="color: var(--text-muted); font-size: 0.875rem;">
                                Welcome, <span id="userName" style="color: var(--gold); font-weight: 700;"></span>
                                <span id="masterBadge" class="hidden" style="margin-left: 0.5rem; color: var(--gold);">‚ö° Admin</span>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-sm" onclick="showSettingsModal()">‚öôÔ∏è Settings</button>
                        <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="tab-container">
                <div class="tab-section" data-label="Core">
                    <button class="tab-btn active" onclick="switchTab('dashboard')"><span class="tab-icon">üè¶</span>Bank</button>
                    <button class="tab-btn" onclick="switchTab('transfer')"><span class="tab-icon">üí∏</span>Transfer</button>
                    <button class="tab-btn" onclick="switchTab('loans')"><span class="tab-icon">üèß</span>Loans</button>
                    <button class="tab-btn" onclick="switchTab('stocks')"><span class="tab-icon">üìà</span>Stocks</button>
                    <button class="tab-btn" onclick="switchTab('portfolio')"><span class="tab-icon">üíº</span>Portfolio</button>
                </div>

                <div class="tab-section" data-label="Collection">
                    <button class="tab-btn" onclick="switchTab('packs')"><span class="tab-icon">üéÅ</span>Packs</button>
                    <button class="tab-btn" onclick="switchTab('collection')"><span class="tab-icon">üéí</span>Collection</button>
                </div>

                <div class="tab-section" data-label="Services">
                    <button class="tab-btn" onclick="switchTab('passport')"><span class="tab-icon">üõÇ</span>Passport</button>
                    <button class="tab-btn" onclick="switchTab('travel')"><span class="tab-icon">‚úàÔ∏è</span>Travel</button>
                </div>

                <div class="tab-section" data-label="Entertainment">
                    <button class="tab-btn" onclick="switchTab('casino')"><span class="tab-icon">üé∞</span>Casino</button>
                    <button class="tab-btn" onclick="switchTab('chat')"><span class="tab-icon">üí¨</span>Chat</button>
                    <button class="tab-btn" onclick="switchTab('leaderboard')"><span class="tab-icon">üèÜ</span>Leaders</button>
                </div>

                <div class="tab-section hidden" id="adminSection" data-label="Admin">
                    <button class="tab-btn" onclick="switchTab('admin')"><span class="tab-icon">üëë</span>Control</button>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboardContent" class="tab-content">
                <div class="balance-card">
                    <div class="balance-label">Total Balance</div>
                    <div class="balance-amount">$<span id="balanceAmount">0.00</span></div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="creditScoreDisplay">650</div>
                        <div class="stat-label">Credit Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeLoansDisplay">0</div>
                        <div class="stat-label">Active Loans</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalDebtDisplay">$0</div>
                        <div class="stat-label">Total Debt</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="emojiScoreDisplay">0</div>
                        <div class="stat-label">Emoji Score</div>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="section-header">
                        <h2>üìä Recent Transactions</h2>
                        <span class="badge" id="transactionCount">0 transactions</span>
                    </div>
                    <div id="transactionList">
                        <div class="empty-state">
                            <div class="empty-icon">üí∞</div>
                            <p>No transactions yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transfer -->
            <div id="transferContent" class="tab-content hidden">
                <div class="glass-card">
                    <h2 style="margin-bottom: 1.5rem; font-weight: 700; color: var(--gold);">üí∏ Send Money</h2>
                    <div class="form-group">
                        <label class="form-label">Recipient Email</label>
                        <input type="email" id="recipientEmail" class="form-input" placeholder="recipient@example.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount ($)</label>
                        <input type="number" id="transferAmount" class="form-input" placeholder="0.00" step="0.01" min="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Note (Optional)</label>
                        <input type="text" id="transferNote" class="form-input" placeholder="What's this for?">
                    </div>
                    <button class="btn btn-success" onclick="transferMoney()" style="width: 100%;">Send Money</button>
                </div>
            </div>

            <!-- LOANS SECTION (NEW V4.02) -->
            <div id="loansContent" class="tab-content hidden">
                <div class="credit-score-container">
                    <div class="credit-gauge">
                        <div class="credit-gauge-bg"></div>
                        <div class="credit-gauge-needle" id="creditNeedle"></div>
                        <div class="credit-gauge-center"></div>
                    </div>
                    <div class="credit-score-value" id="creditScoreMain">650</div>
                    <div class="credit-score-label" id="creditScoreLabel">Fair</div>
                    <p style="color: var(--text-muted); margin-top: 0.5rem; font-size: 0.875rem;">
                        Your credit score affects loan approval and interest rates
                    </p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="loansTaken">0</div>
                        <div class="stat-label">Loans Taken</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="loansPaid">0</div>
                        <div class="stat-label">Loans Paid</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="loansDefaulted">0</div>
                        <div class="stat-label">Defaults</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="onTimePayments">100%</div>
                        <div class="stat-label">On-Time Rate</div>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="section-header">
                        <h2>üìù Apply for a Loan</h2>
                    </div>

                    <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                        Select a loan type below. Interest rates depend on your credit score.
                    </p>

                    <div class="service-grid" id="loanTypes">
                        <div class="loan-type-card" onclick="selectLoanType('personal')" id="loanType_personal">
                            <div class="loan-type-icon">üíº</div>
                            <h3 style="color: var(--gold);">Personal Loan</h3>
                            <p style="color: var(--text-muted); font-size: 0.875rem;">$1,000 - $50,000</p>
                            <p style="color: var(--text-muted); font-size: 0.75rem;">30-90 day terms</p>
                            <p style="color: var(--success); font-size: 0.875rem; margin-top: 0.5rem;">Best rates!</p>
                        </div>

                        <div class="loan-type-card" onclick="selectLoanType('emergency')" id="loanType_emergency">
                            <div class="loan-type-icon">üö®</div>
                            <h3 style="color: var(--gold);">Emergency Loan</h3>
                            <p style="color: var(--text-muted); font-size: 0.875rem;">$500 - $10,000</p>
                            <p style="color: var(--text-muted); font-size: 0.75rem;">7-30 day terms</p>
                            <p style="color: var(--warning); font-size: 0.875rem; margin-top: 0.5rem;">Quick approval</p>
                        </div>

                        <div class="loan-type-card" onclick="selectLoanType('payday')" id="loanType_payday">
                            <div class="loan-type-icon">üíµ</div>
                            <h3 style="color: var(--gold);">Payday Loan</h3>
                            <p style="color: var(--text-muted); font-size: 0.875rem;">$100 - $2,000</p>
                            <p style="color: var(--text-muted); font-size: 0.75rem;">7-14 day terms</p>
                            <p style="color: var(--danger); font-size: 0.875rem; margin-top: 0.5rem;">High interest!</p>
                        </div>

                        <div class="loan-type-card" onclick="selectLoanType('business')" id="loanType_business">
                            <div class="loan-type-icon">üè¢</div>
                            <h3 style="color: var(--gold);">Business Loan</h3>
                            <p style="color: var(--text-muted); font-size: 0.875rem;">$10,000 - $200,000</p>
                            <p style="color: var(--text-muted); font-size: 0.75rem;">60-180 day terms</p>
                            <p style="color: var(--primary-light); font-size: 0.875rem; margin-top: 0.5rem;">700+ score req.</p>
                        </div>
                    </div>

                    <div id="loanApplicationForm" class="hidden" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                        <h3 style="color: var(--gold); margin-bottom: 1rem;">Loan Application - <span id="selectedLoanType">Personal</span></h3>
                        
                        <div class="form-group">
                            <label class="form-label">Loan Amount ($)</label>
                            <input type="number" id="loanAmount" class="form-input" placeholder="Enter amount" min="100" oninput="updateLoanPreview()">
                            <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.25rem;">
                                Range: $<span id="loanMinAmount">1,000</span> - $<span id="loanMaxAmount">50,000</span>
                            </p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Repayment Term</label>
                            <select id="loanTerm" class="form-input" onchange="updateLoanPreview()">
                                <option value="7">7 Days</option>
                                <option value="14">14 Days</option>
                                <option value="30" selected>30 Days</option>
                                <option value="60">60 Days</option>
                                <option value="90">90 Days</option>
                            </select>
                        </div>

                        <div style="background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem;">
                            <h4 style="color: var(--gold); margin-bottom: 0.5rem;">Loan Preview</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.875rem;">
                                <span style="color: var(--text-muted);">Interest Rate:</span>
                                <span id="previewInterestRate" style="color: var(--gold);">12%</span>
                                <span style="color: var(--text-muted);">Interest Amount:</span>
                                <span id="previewInterestAmount">$0</span>
                                <span style="color: var(--text-muted);">Total Repayment:</span>
                                <span id="previewTotalRepayment" style="color: var(--danger); font-weight: 700;">$0</span>
                                <span style="color: var(--text-muted);">Due Date:</span>
                                <span id="previewDueDate">-</span>
                            </div>
                        </div>

                        <button class="btn btn-success" onclick="applyForLoan()" style="width: 100%;">Apply for Loan</button>
                    </div>
                </div>

                <div class="glass-card" style="margin-top: 2rem;">
                    <div class="section-header">
                        <h2>üìã Your Active Loans</h2>
                        <button class="btn btn-sm" onclick="loadLoans()">Refresh</button>
                    </div>
                    <div id="activeLoans">
                        <div class="empty-state">
                            <div class="empty-icon">üí∏</div>
                            <p>No active loans</p>
                        </div>
                    </div>
                </div>

                <div class="glass-card" style="margin-top: 2rem;">
                    <div class="section-header">
                        <h2>üìú Loan History</h2>
                    </div>
                    <div id="loanHistory">
                        <div class="empty-state">
                            <div class="empty-icon">üìú</div>
                            <p>No loan history</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stocks -->
            <div id="stocksContent" class="tab-content hidden">
                <div class="tax-info">
                    ‚ö†Ô∏è <strong>Stock Market Tax:</strong> 5% tax on all buy/sell transactions.
                </div>
                
                <div class="glass-card">
                    <div class="section-header">
                        <h2>üìà Available Stocks</h2>
                        <button class="btn btn-sm" onclick="loadStocks()">Refresh</button>
                    </div>
                    <div id="stocksList">
                        <div class="empty-state"><div class="empty-icon">üìà</div><p>Loading...</p></div>
                    </div>
                </div>
            </div>

            <!-- Portfolio -->
            <div id="portfolioContent" class="tab-content hidden">
                <div class="glass-card">
                    <div class="section-header"><h2>üíº Your Portfolio</h2></div>
                    <div id="portfolioList">
                        <div class="empty-state"><div class="empty-icon">üíº</div><p>No stocks owned</p></div>
                    </div>
                </div>
            </div>

            <!-- Emoji Packs -->
            <div id="packsContent" class="tab-content hidden">
                <div class="glass-card">
                    <div class="section-header">
                        <h2>üéÅ Emoji Packs</h2>
                        <button class="btn btn-sm" onclick="showChancesModal()">üìä View Chances</button>
                    </div>
                    
                    <div style="background: rgba(37, 99, 235, 0.1); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem;">
                        <p style="font-size: 1.25rem; color: var(--gold); font-weight: 700;">$7,500 per pack</p>
                        <p style="font-size: 0.875rem; color: var(--text-muted);">Click "View Chances" to see drop rates for each rarity!</p>
                    </div>

                    <div class="service-grid" id="packsList">
                        <div class="empty-state"><div class="empty-icon">üéÅ</div><p>Loading...</p></div>
                    </div>
                </div>
            </div>

            <!-- Collection -->
            <div id="collectionContent" class="tab-content hidden">
                <div class="glass-card">
                    <div class="section-header">
                        <h2>üéí Your Emoji Collection</h2>
                        <span class="badge" id="emojiScore">0 pts</span>
                    </div>
                    <div id="emojiCollection">
                        <div class="empty-state"><div class="empty-icon">üéí</div><p>No emojis yet</p></div>
                    </div>
                </div>
            </div>

            <!-- Passport -->
            <div id="passportContent" class="tab-content hidden">
                <div class="glass-card">
                    <div class="section-header"><h2>üõÇ Passport Services</h2></div>
                    <div id="passportInfo"></div>
                    <button class="btn" onclick="applyPassport()" style="margin-top: 1rem;" id="applyPassportBtn">Apply for Passport ($500)</button>
                    
                    <h3 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--gold);">üåç Your Visas</h3>
                    <div id="visasList"><p style="color: var(--text-muted);">No visas yet</p></div>
                </div>
            </div>

            <!-- Travel -->
            <div id="travelContent" class="tab-content hidden">
                <div class="glass-card">
                    <div class="section-header"><h2>üåç Destinations</h2></div>
                    <div class="service-grid" id="citiesList">
                        <div class="empty-state"><p>No cities available</p></div>
                    </div>
                </div>

                <div class="glass-card" style="margin-top: 2rem;">
                    <div class="section-header"><h2>‚úàÔ∏è Flights</h2></div>
                    <div id="flightsList"><div class="empty-state"><p>No flights</p></div></div>
                </div>
            </div>

            <!-- CASINO -->
            <div id="casinoContent" class="tab-content hidden">
                <div class="glass-card">
                    <h2 style="margin-bottom: 0.5rem; font-weight: 700; color: var(--gold);">üé∞ Lintoria Casino</h2>
                    <p style="color: var(--danger); margin-bottom: 1rem; font-weight: 600;">‚ö†Ô∏è House always wins! 40-60 odds in favor of the house.</p>
                    <p style="color: var(--text-muted); margin-bottom: 2rem; font-size: 0.875rem;">
                        <strong>REMINDER:</strong> This is a virtual simulation with NO real money. For entertainment only!
                    </p>

                    <div class="reset-warning" style="margin-bottom: 2rem;">
                        <strong>‚ö†Ô∏è NEW:</strong> Gambling losses now affect your account reset penalty! 
                        The more you gamble away, the less you'll start with if you reset.
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem;">
                        
                        <!-- PLINKO -->
                        <div class="casino-game">
                            <h3 style="color: var(--gold); margin-bottom: 0.5rem;">üìç Plinko</h3>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 1rem;">Watch the ball bounce! ~90% return rate. Max 100x!</p>
                            
                            <div class="plinko-container">
                                <div class="plinko-board" id="plinkoBoard">
                                    <div class="plinko-ball" id="plinkoBall"></div>
                                </div>
                                <div class="plinko-slots" id="plinkoSlots"></div>
                            </div>
                            
                            <input type="number" id="plinkoBet" class="form-input" placeholder="Bet amount" min="1" style="margin: 1rem 0;">
                            <button class="btn btn-success" onclick="playPlinko()" id="plinkoBtn" style="width: 100%;">Drop Ball</button>
                            <div id="plinkoResult" style="margin-top: 1rem; font-weight: 700; text-align: center; min-height: 30px;"></div>
                        </div>

                        <!-- ROULETTE -->
                        <div class="casino-game">
                            <h3 style="color: var(--gold); margin-bottom: 0.5rem;">üé° Roulette</h3>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 1rem;">Spin the wheel! Red/Black ~1.9x, Green ~10x</p>
                            
                            <div class="roulette-container">
                                <div class="roulette-pointer"></div>
                                <div class="roulette-wheel" id="rouletteWheel"></div>
                                <div class="roulette-center">üé±</div>
                            </div>
                            
                            <input type="number" id="rouletteBet" class="form-input" placeholder="Bet amount" min="1" style="margin: 1rem 0;">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                                <button class="btn" onclick="playRoulette('red')" id="rouletteRedBtn" style="background: linear-gradient(135deg, #ef4444, #dc2626);">Red</button>
                                <button class="btn" onclick="playRoulette('black')" id="rouletteBlackBtn" style="background: linear-gradient(135deg, #1f2937, #111827);">Black</button>
                                <button class="btn btn-success" onclick="playRoulette('green')" id="rouletteGreenBtn">Green</button>
                            </div>
                            <div id="rouletteResult" style="margin-top: 1rem; font-weight: 700; text-align: center; min-height: 30px;"></div>
                        </div>

                        <!-- FORTUNE WHEEL -->
                        <div class="casino-game">
                            <h3 style="color: var(--gold); margin-bottom: 0.5rem;">üé° Fortune Wheel</h3>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 1rem;">Spin for multipliers up to 100x!</p>
                            
                            <div class="wheel-container">
                                <div class="wheel-pointer-top"></div>
                                <div class="fortune-wheel" id="fortuneWheel"></div>
                                <div class="wheel-center"></div>
                            </div>
                            
                            <input type="number" id="wheelBet" class="form-input" placeholder="Bet amount" min="1" style="margin: 1rem 0;">
                            <button class="btn btn-success" onclick="playWheel()" id="wheelBtn" style="width: 100%;">Spin Wheel</button>
                            <div id="wheelResult" style="margin-top: 1rem; font-weight: 700; text-align: center; min-height: 30px;"></div>
                        </div>

                        <!-- DICE -->
                        <div class="casino-game">
                            <h3 style="color: var(--gold); margin-bottom: 0.5rem;">üé≤ Dice Roll</h3>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 1rem;">40% chance to win 1.9x</p>
                            
                            <div class="dice-container">
                                <div class="dice" id="dice">
                                    <div class="dice-face front">‚öÄ</div>
                                    <div class="dice-face back">‚öÖ</div>
                                    <div class="dice-face right">‚öÇ</div>
                                    <div class="dice-face left">‚öÉ</div>
                                    <div class="dice-face top">‚öÅ</div>
                                    <div class="dice-face bottom">‚öÑ</div>
                                </div>
                            </div>
                            
                            <input type="number" id="diceBet" class="form-input" placeholder="Bet amount" min="1" style="margin: 1rem 0;">
                            <button class="btn" onclick="playDice()" id="diceBtn" style="width: 100%;">Roll Dice</button>
                            <div id="diceResult" style="margin-top: 1rem; font-weight: 700; text-align: center; min-height: 30px;"></div>
                        </div>

                        <!-- SLOTS -->
                        <div class="casino-game">
                            <h3 style="color: var(--gold); margin-bottom: 0.5rem;">üé∞ Slot Machine</h3>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 1rem;">Match symbols! Up to 25x jackpot!</p>
                            
                            <div class="slots-machine">
                                <div class="slots-display">
                                    <div class="slot-reel" id="reel1"><span class="slot-symbol">üé∞</span></div>
                                    <div class="slot-reel" id="reel2"><span class="slot-symbol">üé∞</span></div>
                                    <div class="slot-reel" id="reel3"><span class="slot-symbol">üé∞</span></div>
                                </div>
                            </div>
                            
                            <input type="number" id="slotsBet" class="form-input" placeholder="Bet amount" min="1" style="margin: 1rem 0;">
                            <button class="btn btn-success" onclick="playSlots()" id="slotsBtn" style="width: 100%;">Spin!</button>
                            <div id="slotsResult" style="margin-top: 1rem; font-weight: 700; text-align: center; min-height: 30px;"></div>
                        </div>

                        <!-- BLACKJACK -->
                        <div class="casino-game">
                            <h3 style="color: var(--gold); margin-bottom: 0.5rem;">üÉè Blackjack</h3>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 1rem;">Hit or Stand! Get 21!</p>
                            
                            <div class="blackjack-table">
                                <div style="text-align: center; color: rgba(255,255,255,0.7); font-size: 0.8rem;">DEALER <span id="dealerTotal"></span></div>
                                <div class="card-hand" id="dealerHand"></div>
                                <div style="border-top: 2px dashed rgba(255,255,255,0.3); margin: 1rem 0;"></div>
                                <div class="card-hand" id="playerHand"></div>
                                <div style="text-align: center; color: rgba(255,255,255,0.7); font-size: 0.8rem;">YOU <span id="playerTotal"></span></div>
                            </div>
                            
                            <input type="number" id="blackjackBet" class="form-input" placeholder="Bet amount" min="1" style="margin: 1rem 0;">
                            <button class="btn" onclick="startBlackjack()" id="blackjackDealBtn" style="width: 100%;">Deal Cards</button>
                            <div id="blackjackActions" class="hidden" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                                <button class="btn btn-success" onclick="blackjackHit()" id="hitBtn">üëÜ Hit</button>
                                <button class="btn btn-danger" onclick="blackjackStand()" id="standBtn">‚úã Stand</button>
                            </div>
                            <div id="blackjackResult" style="margin-top: 1rem; font-weight: 700; text-align: center; min-height: 30px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat -->
            <div id="chatContent" class="tab-content hidden">
                <div class="glass-card">
                    <div class="section-header">
                        <h2>üí¨ Public Chat</h2>
                        <button class="btn btn-sm" onclick="loadChat()">Refresh</button>
                    </div>
                    
                    <div class="chat-container" id="chatMessages">
                        <div class="empty-state"><p>Loading...</p></div>
                    </div>
                    
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="form-input" placeholder="Type a message..." maxlength="500" style="flex: 1;" onkeypress="if(event.key==='Enter')sendChat()">
                        <button class="btn btn-success" onclick="sendChat()">Send</button>
                    </div>
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">‚ö†Ô∏è Be respectful. Swearing is filtered.</p>
                </div>
            </div>

            <!-- Leaderboard -->
            <div id="leaderboardContent" class="tab-content hidden">
                <div class="glass-card" style="margin-bottom: 2rem;">
                    <div class="section-header"><h2>üí∞ Wealth Leaderboard</h2></div>
                    <div id="wealthLeaderboard"><div class="empty-state"><p>Loading...</p></div></div>
                </div>

                <div class="glass-card" style="margin-bottom: 2rem;">
                    <div class="section-header"><h2>üìä Credit Score Leaderboard</h2></div>
                    <div id="creditLeaderboard"><div class="empty-state"><p>Loading...</p></div></div>
                </div>

                <div class="glass-card">
                    <div class="section-header"><h2>üéØ Emoji Score Leaderboard</h2></div>
                    <div id="emojiLeaderboard"><div class="empty-state"><p>Loading...</p></div></div>
                </div>
            </div>

            <!-- Admin -->
            <div id="adminContent" class="tab-content hidden">
                <div class="glass-card">
                    <div class="section-header">
                        <h2>üëë Admin Panel</h2>
                        <span class="badge" id="userCount">0 users</span>
                    </div>
                    <div id="adminUsersList"><div class="empty-state"><p>Loading...</p></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"><div id="toastMessage"></div></div>

    <!-- Chances Modal -->
    <div class="modal-overlay" id="chancesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: var(--gold);">üìä Emoji Drop Chances</h2>
                <button class="modal-close" onclick="closeChancesModal()">&times;</button>
            </div>
            
            <table class="chances-table">
                <thead>
                    <tr>
                        <th>Rarity</th>
                        <th>Chance</th>
                        <th>Points</th>
                        <th>Sell Price</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="rarity-badge common">Common</span></td>
                        <td>50%</td>
                        <td>10 pts</td>
                        <td style="color: var(--danger);">$500</td>
                    </tr>
                    <tr>
                        <td><span class="rarity-badge uncommon">Uncommon</span></td>
                        <td>30%</td>
                        <td>25 pts</td>
                        <td style="color: var(--danger);">$2,000</td>
                    </tr>
                    <tr>
                        <td><span class="rarity-badge rare">Rare</span></td>
                        <td>12%</td>
                        <td>100 pts</td>
                        <td style="color: var(--success);">$10,000</td>
                    </tr>
                    <tr>
                        <td><span class="rarity-badge epic">Epic</span></td>
                        <td>5%</td>
                        <td>500 pts</td>
                        <td style="color: var(--success);">$25,000</td>
                    </tr>
                    <tr>
                        <td><span class="rarity-badge legendary">Legendary</span></td>
                        <td>2%</td>
                        <td>2,500 pts</td>
                        <td style="color: var(--success);">$75,000</td>
                    </tr>
                    <tr>
                        <td><span class="rarity-badge mythic">Mythic</span></td>
                        <td>0.8%</td>
                        <td>10,000 pts</td>
                        <td style="color: var(--success);">$200,000</td>
                    </tr>
                    <tr>
                        <td><span class="rarity-badge divine">Divine</span></td>
                        <td>0.2%</td>
                        <td>50,000 pts</td>
                        <td style="color: var(--success);">$500,000</td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(251, 191, 36, 0.1); border-radius: 12px;">
                <p style="color: var(--gold); font-weight: 700;">üí° Tips:</p>
                <ul style="color: var(--text-secondary); font-size: 0.875rem; margin-left: 1rem; margin-top: 0.5rem;">
                    <li>Pack cost: $7,500</li>
                    <li>Only Rare and above give profit when sold!</li>
                    <li>Duplicates give 0 points (no double-counting)</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Settings Modal (NEW V4.02) -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: var(--gold);">‚öôÔ∏è Account Settings</h2>
                <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            
            <div class="service-card" style="margin-bottom: 1rem;">
                <h3 style="color: var(--text-primary); margin-bottom: 0.5rem;">üìä Account Statistics</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.875rem;">
                    <span style="color: var(--text-muted);">Account Created:</span>
                    <span id="settingsCreatedAt">-</span>
                    <span style="color: var(--text-muted);">Total Earned:</span>
                    <span id="settingsTotalEarned">$0</span>
                    <span style="color: var(--text-muted);">Total Gambled:</span>
                    <span id="settingsTotalGambled">$0</span>
                    <span style="color: var(--text-muted);">Gambling Losses:</span>
                    <span id="settingsGamblingLosses" style="color: var(--danger);">$0</span>
                </div>
            </div>

            <div class="reset-warning">
                <h3 style="color: var(--danger); margin-bottom: 0.5rem;">üîÑ Reset Account</h3>
                <p style="font-size: 0.875rem; margin-bottom: 1rem;">
                    Start fresh with a new balance. Your gambling history affects your new starting amount!
                </p>
                
                <div class="reset-calculation" id="resetCalculation">
                    <div class="reset-calculation-row">
                        <span>Base Amount:</span>
                        <span>$100,000</span>
                    </div>
                    <div class="reset-calculation-row">
                        <span>Gambling Penalty:</span>
                        <span id="resetGamblingPenalty" style="color: var(--danger);">-$0</span>
                    </div>
                    <div class="reset-calculation-row">
                        <span>Loan Default Penalty:</span>
                        <span id="resetLoanPenalty" style="color: var(--danger);">-$0</span>
                    </div>
                    <div class="reset-calculation-row">
                        <span>Credit Score Adjustment:</span>
                        <span id="resetCreditAdjust">+$0</span>
                    </div>
                    <div class="reset-calculation-row">
                        <span>New Starting Balance:</span>
                        <span id="resetNewBalance">$100,000</span>
                    </div>
                </div>

                <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem;">
                    ‚ö†Ô∏è This will erase ALL your data: balance, loans, stocks, emojis, transactions. This cannot be undone!
                </p>

                <button class="btn btn-danger" onclick="confirmResetAccount()" style="width: 100%;">
                    Reset My Account
                </button>
            </div>
        </div>
    </div>

    <!-- Loan Payment Modal (NEW V4.02) -->
    <div class="modal-overlay" id="loanPaymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: var(--gold);">üí≥ Make Payment</h2>
                <button class="modal-close" onclick="closeLoanPaymentModal()">&times;</button>
            </div>
            
            <div id="loanPaymentDetails"></div>
            
            <div class="form-group">
                <label class="form-label">Payment Amount ($)</label>
                <input type="number" id="paymentAmount" class="form-input" placeholder="Enter amount">
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button class="btn btn-sm" onclick="setPaymentAmount('minimum')">Minimum</button>
                    <button class="btn btn-sm" onclick="setPaymentAmount('half')">Half</button>
                    <button class="btn btn-sm btn-success" onclick="setPaymentAmount('full')">Pay in Full</button>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="makePayment()" style="width: 100%; margin-top: 1rem;">
                Make Payment
            </button>
        </div>
    </div>

    <!-- Pack Opening Modal -->
    <div id="packOpeningModal" class="hidden"></div>

    <script>
        // ============ CONFIGURATION ============
        const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbz3CPKFWGqeAZYTdhe0FcVZgDB7HDrouu7PynSB_99BRvpyMzXjzr3DtRENmBIf7ppoFA/exec';
        const MASTER_ADMIN = 'sheepishlyroyal@gmail.com';
        
        // ============ STATE ============
        let currentUser = null;
        let pendingVerification = null;
        let currentLoanType = null;
        let currentPaymentLoanId = null;
        let currentPaymentLoanData = null;

        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', () => {
            initParticles();
            initGlowSystem();
            initPlinko();
            initRoulette();
            initFortuneWheel();
            
            const saved = localStorage.getItem('lintoriaUser');
            if (saved) {
                currentUser = JSON.parse(saved);
                showApp();
            }
        });

        // ============ PARTICLES ============
        function initParticles() {
            const container = document.getElementById('particleContainer');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle' + (Math.random() > 0.5 ? ' blue' : '');
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDuration = (8 + Math.random() * 12) + 's';
                particle.style.animationDelay = Math.random() * 10 + 's';
                container.appendChild(particle);
            }
        }

        // ============ GLOW SYSTEM ============
        function initGlowSystem() {
            const orb1 = document.getElementById('glowOrb1');
            const orb2 = document.getElementById('glowOrb2');
            
            document.addEventListener('mousemove', (e) => {
                const x = e.clientX;
                const y = e.clientY;
                
                orb1.style.left = (x - 150) + 'px';
                orb1.style.top = (y - 150) + 'px';
                
                orb2.style.left = (x - 125 + 100) + 'px';
                orb2.style.top = (y - 125 + 100) + 'px';
            });
        }

        // ============ TOAST ============
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.className = 'toast', 3000);
        }

        // ============ AUTH ============
        function switchAuthTab(tab) {
            document.querySelectorAll('#authTabs .tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('loginTab').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerTab').classList.toggle('hidden', tab !== 'register');
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            try {
                showToast('Logging in...');
                const response = await fetch(`${SHEETS_URL}?action=login&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('lintoriaUser', JSON.stringify(currentUser));
                    showToast('Welcome back!', 'success');
                    showApp();
                } else {
                    showToast(data.message || 'Login failed', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        async function register() {
            const email = document.getElementById('registerEmail').value.trim().toLowerCase();
            const name = document.getElementById('registerName').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            if (!email || !name || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            if (password.length < 4) {
                showToast('Password must be at least 4 characters', 'error');
                return;
            }
            
            try {
                showToast('Creating account...');
                const response = await fetch(`${SHEETS_URL}?action=register&email=${encodeURIComponent(email)}&name=${encodeURIComponent(name)}&password=${encodeURIComponent(password)}`);
                const data = await response.json();
                
                if (data.success) {
                    // Auto-login after registration
                    currentUser = data.user;
                    localStorage.setItem('lintoriaUser', JSON.stringify(currentUser));
                    showToast('Account created! Welcome to Lintoria!', 'success');
                    showApp();
                } else {
                    showToast(data.message || 'Registration failed', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        function handleCodeInput(index) {
            const input = document.getElementById('code' + index);
            if (input.value.length === 1 && index < 6) {
                document.getElementById('code' + (index + 1)).focus();
            }
        }

        async function verifyCode() {
            let code = '';
            for (let i = 1; i <= 6; i++) {
                code += document.getElementById('code' + i).value;
            }
            
            if (code.length !== 6) {
                showToast('Please enter the 6-digit code', 'error');
                return;
            }
            
            if (code === pendingVerification.code) {
                try {
                    showToast('Verifying...');
                    const response = await fetch(`${SHEETS_URL}?action=completeRegistration&email=${encodeURIComponent(pendingVerification.email)}&name=${encodeURIComponent(pendingVerification.name)}&password=${encodeURIComponent(pendingVerification.password)}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        currentUser = data.user;
                        localStorage.setItem('lintoriaUser', JSON.stringify(currentUser));
                        showToast('Account created! Welcome!', 'success');
                        showApp();
                    } else {
                        showToast(data.message || 'Verification failed', 'error');
                    }
                } catch (error) {
                    showToast('Connection error', 'error');
                }
            } else {
                showToast('Invalid code', 'error');
            }
        }

        function resendCode() {
            if (pendingVerification) {
                pendingVerification.code = Math.floor(100000 + Math.random() * 900000).toString();
                showToast('New code: ' + pendingVerification.code, 'success');
            }
        }

        function backToLogin() {
            document.getElementById('authTabs').classList.remove('hidden');
            document.getElementById('verificationScreen').classList.add('hidden');
            pendingVerification = null;
            for (let i = 1; i <= 6; i++) {
                document.getElementById('code' + i).value = '';
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('lintoriaUser');
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
            showToast('Logged out', 'success');
        }

        // ============ APP DISPLAY ============
        function showApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            
            document.getElementById('userName').textContent = currentUser.name;
            
            if (currentUser.email === MASTER_ADMIN) {
                document.getElementById('masterBadge').classList.remove('hidden');
                document.getElementById('adminSection').classList.remove('hidden');
            }
            
            loadDashboard();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(tab + 'Content').classList.remove('hidden');
            event.target.classList.add('active');
            
            switch(tab) {
                case 'dashboard': loadDashboard(); break;
                case 'loans': loadLoans(); break;
                case 'stocks': loadStocks(); break;
                case 'portfolio': loadPortfolio(); break;
                case 'packs': loadPacks(); break;
                case 'collection': loadCollection(); break;
                case 'passport': loadPassport(); break;
                case 'travel': loadTravel(); break;
                case 'chat': loadChat(); break;
                case 'leaderboard': loadLeaderboards(); break;
                case 'admin': loadAdmin(); break;
            }
        }

        // ============ DASHBOARD ============
        async function loadDashboard() {
            try {
                const response = await fetch(`${SHEETS_URL}?action=getDashboard&email=${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser.balance = data.balance;
                    document.getElementById('balanceAmount').textContent = formatNumber(data.balance);
                    document.getElementById('creditScoreDisplay').textContent = data.creditScore || 650;
                    document.getElementById('activeLoansDisplay').textContent = data.activeLoans || 0;
                    document.getElementById('totalDebtDisplay').textContent = '$' + formatNumber(data.totalDebt || 0);
                    document.getElementById('emojiScoreDisplay').textContent = data.emojiScore || 0;
                    
                    renderTransactions(data.transactions || []);
                }
            } catch (error) {
                showToast('Failed to load dashboard', 'error');
            }
        }

        function renderTransactions(transactions) {
            const container = document.getElementById('transactionList');
            document.getElementById('transactionCount').textContent = transactions.length + ' transactions';
            
            if (transactions.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üí∞</div><p>No transactions yet</p></div>';
                return;
            }
            
            container.innerHTML = transactions.slice(0, 20).map(t => `
                <div class="transaction-item">
                    <div>
                        <div style="font-weight: 600;">${t.type}</div>
                        <div style="color: var(--text-muted); font-size: 0.875rem;">${t.description || ''}</div>
                        <div style="color: var(--text-muted); font-size: 0.75rem;">${formatDate(t.timestamp)}</div>
                    </div>
                    <div style="font-weight: 700; color: ${t.amount >= 0 ? 'var(--success)' : 'var(--danger)'};">
                        ${t.amount >= 0 ? '+' : ''}$${formatNumber(Math.abs(t.amount))}
                    </div>
                </div>
            `).join('');
        }

        // ============ TRANSFER ============
        async function transferMoney() {
            const recipient = document.getElementById('recipientEmail').value.trim().toLowerCase();
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const note = document.getElementById('transferNote').value.trim();
            
            if (!recipient || !amount || amount <= 0) {
                showToast('Please enter valid details', 'error');
                return;
            }
            
            if (recipient === currentUser.email) {
                showToast('Cannot transfer to yourself', 'error');
                return;
            }
            
            if (amount > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            try {
                showToast('Processing...');
                const response = await fetch(`${SHEETS_URL}?action=transfer&from=${encodeURIComponent(currentUser.email)}&to=${encodeURIComponent(recipient)}&amount=${amount}&note=${encodeURIComponent(note)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser.balance = data.newBalance;
                    document.getElementById('balanceAmount').textContent = formatNumber(data.newBalance);
                    document.getElementById('recipientEmail').value = '';
                    document.getElementById('transferAmount').value = '';
                    document.getElementById('transferNote').value = '';
                    showToast('Transfer successful!', 'success');
                } else {
                    showToast(data.message || 'Transfer failed', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        // ============ LOANS (NEW V4.02) ============
        async function loadLoans() {
            try {
                const response = await fetch(`${SHEETS_URL}?action=getLoanData&email=${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                
                if (data.success) {
                    // Update credit score display
                    const score = data.creditScore || 650;
                    updateCreditScoreDisplay(score);
                    
                    // Update stats
                    document.getElementById('loansTaken').textContent = data.loansTaken || 0;
                    document.getElementById('loansPaid').textContent = data.loansPaid || 0;
                    document.getElementById('loansDefaulted').textContent = data.loansDefaulted || 0;
                    document.getElementById('onTimePayments').textContent = (data.onTimeRate || 100) + '%';
                    
                    // Render active loans
                    renderActiveLoans(data.activeLoans || []);
                    
                    // Render loan history
                    renderLoanHistory(data.loanHistory || []);
                }
            } catch (error) {
                showToast('Failed to load loan data', 'error');
            }
        }

        function updateCreditScoreDisplay(score) {
            // Update all credit score displays
            document.getElementById('creditScoreMain').textContent = score;
            document.getElementById('creditScoreDisplay').textContent = score;
            
            // Determine label and color
            let label, colorClass;
            if (score >= 750) { label = 'Excellent'; colorClass = 'credit-excellent'; }
            else if (score >= 700) { label = 'Good'; colorClass = 'credit-good'; }
            else if (score >= 650) { label = 'Fair'; colorClass = 'credit-fair'; }
            else if (score >= 550) { label = 'Poor'; colorClass = 'credit-poor'; }
            else { label = 'Bad'; colorClass = 'credit-bad'; }
            
            const labelEl = document.getElementById('creditScoreLabel');
            labelEl.textContent = label;
            labelEl.className = 'credit-score-label ' + colorClass;
            
            document.getElementById('creditScoreMain').className = 'credit-score-value ' + colorClass;
            
            // Update needle position (300-850 maps to -90deg to 90deg)
            const needle = document.getElementById('creditNeedle');
            const normalized = (score - 300) / 550; // 0 to 1
            const angle = -90 + (normalized * 180); // -90 to 90
            needle.style.transform = `translateX(-50%) rotate(${angle}deg)`;
        }

        function selectLoanType(type) {
            currentLoanType = type;
            
            // Highlight selected
            document.querySelectorAll('.loan-type-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('loanType_' + type).classList.add('selected');
            
            // Show form
            document.getElementById('loanApplicationForm').classList.remove('hidden');
            
            // Set limits based on type
            const limits = {
                personal: { min: 1000, max: 50000, terms: [30, 60, 90], name: 'Personal Loan' },
                emergency: { min: 500, max: 10000, terms: [7, 14, 30], name: 'Emergency Loan' },
                payday: { min: 100, max: 2000, terms: [7, 14], name: 'Payday Loan' },
                business: { min: 10000, max: 200000, terms: [60, 90, 180], name: 'Business Loan' }
            };
            
            const config = limits[type];
            document.getElementById('selectedLoanType').textContent = config.name;
            document.getElementById('loanMinAmount').textContent = formatNumber(config.min);
            document.getElementById('loanMaxAmount').textContent = formatNumber(config.max);
            
            const amountInput = document.getElementById('loanAmount');
            amountInput.min = config.min;
            amountInput.max = config.max;
            amountInput.value = config.min;
            
            // Update term options
            const termSelect = document.getElementById('loanTerm');
            termSelect.innerHTML = config.terms.map(t => `<option value="${t}">${t} Days</option>`).join('');
            
            updateLoanPreview();
        }

        function updateLoanPreview() {
            if (!currentLoanType) return;
            
            const amount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const term = parseInt(document.getElementById('loanTerm').value) || 30;
            const creditScore = parseInt(document.getElementById('creditScoreMain').textContent) || 650;
            
            // Base rates
            const baseRates = {
                personal: 0.08,
                emergency: 0.15,
                payday: 0.25,
                business: 0.06
            };
            
            // Credit multiplier
            let creditMultiplier = 1.0;
            if (creditScore >= 750) creditMultiplier = 0.6;
            else if (creditScore >= 700) creditMultiplier = 0.8;
            else if (creditScore >= 650) creditMultiplier = 1.0;
            else if (creditScore >= 550) creditMultiplier = 1.5;
            else creditMultiplier = 2.0;
            
            const baseRate = baseRates[currentLoanType] || 0.10;
            const termMultiplier = term / 30;
            const finalRate = baseRate * creditMultiplier * termMultiplier;
            const interest = amount * finalRate;
            const total = amount + interest;
            
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + term);
            
            document.getElementById('previewInterestRate').textContent = (finalRate * 100).toFixed(1) + '%';
            document.getElementById('previewInterestAmount').textContent = '$' + formatNumber(interest);
            document.getElementById('previewTotalRepayment').textContent = '$' + formatNumber(total);
            document.getElementById('previewDueDate').textContent = dueDate.toLocaleDateString();
        }

        async function applyForLoan() {
            if (!currentLoanType) {
                showToast('Please select a loan type', 'error');
                return;
            }
            
            const amount = parseFloat(document.getElementById('loanAmount').value);
            const term = parseInt(document.getElementById('loanTerm').value);
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            try {
                showToast('Processing application...');
                const response = await fetch(`${SHEETS_URL}?action=applyLoan&email=${encodeURIComponent(currentUser.email)}&type=${currentLoanType}&amount=${amount}&term=${term}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser.balance = data.newBalance;
                    document.getElementById('balanceAmount').textContent = formatNumber(data.newBalance);
                    showToast('Loan approved! $' + formatNumber(amount) + ' credited.', 'success');
                    loadLoans();
                    
                    // Reset form
                    document.getElementById('loanApplicationForm').classList.add('hidden');
                    document.querySelectorAll('.loan-type-card').forEach(c => c.classList.remove('selected'));
                    currentLoanType = null;
                } else {
                    showToast(data.message || 'Loan application failed', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        function renderActiveLoans(loans) {
            const container = document.getElementById('activeLoans');
            
            if (loans.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üí∏</div><p>No active loans</p></div>';
                return;
            }
            
            container.innerHTML = loans.map(loan => {
                const progress = ((loan.amountPaid / loan.totalOwed) * 100).toFixed(1);
                const remaining = loan.totalOwed - loan.amountPaid;
                const dueDate = new Date(loan.dueDate);
                const isOverdue = dueDate < new Date() && loan.status === 'active';
                
                return `
                    <div class="loan-active-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h4 style="color: var(--gold);">${loan.type} Loan</h4>
                                <p style="font-size: 0.875rem; color: var(--text-muted);">Principal: $${formatNumber(loan.principal)}</p>
                            </div>
                            <span class="loan-status ${isOverdue ? 'overdue' : loan.status}">${isOverdue ? 'OVERDUE' : loan.status.toUpperCase()}</span>
                        </div>
                        
                        <div class="loan-progress">
                            <div class="loan-progress-bar" style="width: ${progress}%;"></div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.875rem; margin-bottom: 1rem;">
                            <span style="color: var(--text-muted);">Paid:</span>
                            <span style="color: var(--success);">$${formatNumber(loan.amountPaid)} (${progress}%)</span>
                            <span style="color: var(--text-muted);">Remaining:</span>
                            <span style="color: var(--danger);">$${formatNumber(remaining)}</span>
                            <span style="color: var(--text-muted);">Due Date:</span>
                            <span style="color: ${isOverdue ? 'var(--danger)' : 'var(--text-primary)'};">${dueDate.toLocaleDateString()}</span>
                        </div>
                        
                        <button class="btn btn-success btn-sm" onclick="openPaymentModal('${loan.id}')" style="width: 100%;">
                            Make Payment
                        </button>
                    </div>
                `;
            }).join('');
        }

        function renderLoanHistory(history) {
            const container = document.getElementById('loanHistory');
            
            if (history.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìú</div><p>No loan history</p></div>';
                return;
            }
            
            container.innerHTML = history.map(loan => `
                <div class="transaction-item">
                    <div>
                        <div style="font-weight: 600;">${loan.type} Loan - $${formatNumber(loan.principal)}</div>
                        <div style="color: var(--text-muted); font-size: 0.75rem;">${formatDate(loan.createdAt)}</div>
                    </div>
                    <span class="loan-status ${loan.status}">${loan.status.toUpperCase()}</span>
                </div>
            `).join('');
        }

        async function openPaymentModal(loanId) {
            currentPaymentLoanId = loanId;
            document.getElementById('loanPaymentModal').classList.add('active');
            
            try {
                const response = await fetch(`${SHEETS_URL}?action=getLoanDetails&loanId=${loanId}`);
                const data = await response.json();
                
                if (data.success) {
                    currentPaymentLoanData = data.loan;
                    const remaining = data.loan.totalOwed - data.loan.amountPaid;
                    
                    document.getElementById('loanPaymentDetails').innerHTML = `
                        <div style="background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                            <h4 style="color: var(--gold); margin-bottom: 0.5rem;">${data.loan.type} Loan</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.875rem;">
                                <span style="color: var(--text-muted);">Total Owed:</span>
                                <span>$${formatNumber(data.loan.totalOwed)}</span>
                                <span style="color: var(--text-muted);">Already Paid:</span>
                                <span style="color: var(--success);">$${formatNumber(data.loan.amountPaid)}</span>
                                <span style="color: var(--text-muted);">Remaining:</span>
                                <span style="color: var(--danger); font-weight: 700;">$${formatNumber(remaining)}</span>
                                <span style="color: var(--text-muted);">Min Payment:</span>
                                <span>$${formatNumber(remaining * 0.1)}</span>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('paymentAmount').max = remaining;
                    document.getElementById('paymentAmount').value = '';
                }
            } catch (error) {
                showToast('Failed to load loan details', 'error');
            }
        }

        function closeLoanPaymentModal() {
            document.getElementById('loanPaymentModal').classList.remove('active');
            currentPaymentLoanId = null;
            currentPaymentLoanData = null;
        }

        function setPaymentAmount(type) {
            if (!currentPaymentLoanData) return;
            
            const remaining = currentPaymentLoanData.totalOwed - currentPaymentLoanData.amountPaid;
            let amount = 0;
            
            switch(type) {
                case 'minimum': amount = remaining * 0.1; break;
                case 'half': amount = remaining * 0.5; break;
                case 'full': amount = remaining; break;
            }
            
            document.getElementById('paymentAmount').value = amount.toFixed(2);
        }

        async function makePayment() {
            if (!currentPaymentLoanId) return;
            
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            
            if (!amount || amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            if (amount > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            try {
                showToast('Processing payment...');
                const response = await fetch(`${SHEETS_URL}?action=makeLoanPayment&email=${encodeURIComponent(currentUser.email)}&loanId=${currentPaymentLoanId}&amount=${amount}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser.balance = data.newBalance;
                    document.getElementById('balanceAmount').textContent = formatNumber(data.newBalance);
                    showToast(data.message || 'Payment successful!', 'success');
                    closeLoanPaymentModal();
                    loadLoans();
                } else {
                    showToast(data.message || 'Payment failed', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        // ============ SETTINGS & RESET (NEW V4.02) ============
        async function showSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
            
            try {
                const response = await fetch(`${SHEETS_URL}?action=getResetPreview&email=${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('settingsCreatedAt').textContent = data.createdAt || '-';
                    document.getElementById('settingsTotalEarned').textContent = '$' + formatNumber(data.totalEarned || 0);
                    document.getElementById('settingsTotalGambled').textContent = '$' + formatNumber(data.totalGambled || 0);
                    document.getElementById('settingsGamblingLosses').textContent = '$' + formatNumber(data.gamblingLosses || 0);
                    
                    document.getElementById('resetGamblingPenalty').textContent = '-$' + formatNumber(data.gamblingPenalty || 0);
                    document.getElementById('resetLoanPenalty').textContent = '-$' + formatNumber(data.loanPenalty || 0);
                    
                    const creditAdj = data.creditAdjustment || 0;
                    document.getElementById('resetCreditAdjust').textContent = (creditAdj >= 0 ? '+' : '') + '$' + formatNumber(creditAdj);
                    document.getElementById('resetCreditAdjust').style.color = creditAdj >= 0 ? 'var(--success)' : 'var(--danger)';
                    
                    document.getElementById('resetNewBalance').textContent = '$' + formatNumber(data.newBalance || 100000);
                }
            } catch (error) {
                console.error('Failed to load reset preview');
            }
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        async function confirmResetAccount() {
            const confirmation = prompt('This will PERMANENTLY delete all your data. Type "RESET" to confirm:');
            
            if (confirmation !== 'RESET') {
                showToast('Reset cancelled', 'info');
                return;
            }
            
            try {
                showToast('Resetting account...');
                const response = await fetch(`${SHEETS_URL}?action=resetAccount&email=${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser.balance = data.newBalance;
                    document.getElementById('balanceAmount').textContent = formatNumber(data.newBalance);
                    showToast('Account reset! New balance: $' + formatNumber(data.newBalance), 'success');
                    closeSettingsModal();
                    loadDashboard();
                } else {
                    showToast(data.message || 'Reset failed', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        // ============ STOCKS ============
        async function loadStocks() {
            try {
                const response = await fetch(`${SHEETS_URL}?action=getStocks`);
                const data = await response.json();
                
                if (data.success) {
                    renderStocks(data.stocks || []);
                }
            } catch (error) {
                showToast('Failed to load stocks', 'error');
            }
        }

        function renderStocks(stocks) {
            const container = document.getElementById('stocksList');
            
            if (stocks.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìà</div><p>No stocks available</p></div>';
                return;
            }
            
            container.innerHTML = stocks.map(stock => {
                const changeColor = stock.change >= 0 ? 'var(--success)' : 'var(--danger)';
                const changeIcon = stock.change >= 0 ? 'üìà' : 'üìâ';
                
                return `
                    <div class="stock-card" onclick="openStockModal('${stock.symbol}', '${stock.name}', ${stock.price})">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-weight: 800; color: var(--gold); font-size: 1.25rem;">${stock.symbol}</span>
                                <span style="color: var(--text-muted); margin-left: 0.5rem;">${stock.name}</span>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; font-size: 1.25rem;">$${formatNumber(stock.price)}</div>
                                <div style="color: ${changeColor}; font-size: 0.875rem;">
                                    ${changeIcon} ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        let selectedStock = null;

        function openStockModal(symbol, name, price) {
            selectedStock = { symbol, name, price };
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'stockModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 style="color: var(--gold);">${symbol} - ${name}</h2>
                        <button class="modal-close" onclick="closeStockModal()">&times;</button>
                    </div>
                    
                    <div class="tax-info">
                        ‚ö†Ô∏è <strong>5% Tax</strong> applies to all transactions
                    </div>
                    
                    <p style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem;">$${formatNumber(price)} per share</p>
                    
                    <div class="form-group">
                        <label class="form-label">Quantity</label>
                        <input type="number" id="stockQuantity" class="form-input" placeholder="Number of shares" min="1" oninput="updateStockPreview()">
                    </div>
                    
                    <div style="background: rgba(15, 23, 42, 0.6); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-muted);">Subtotal:</span>
                            <span id="stockSubtotal">$0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-muted);">Tax (5%):</span>
                            <span id="stockTax" style="color: var(--danger);">$0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-weight: 700;">
                            <span>Total:</span>
                            <span id="stockTotal">$0</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="buyStock()" style="width: 100%;">Buy Shares</button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeStockModal() {
            const modal = document.getElementById('stockModal');
            if (modal) modal.remove();
            selectedStock = null;
        }

        function updateStockPreview() {
            if (!selectedStock) return;
            
            const quantity = parseInt(document.getElementById('stockQuantity').value) || 0;
            const subtotal = quantity * selectedStock.price;
            const tax = subtotal * 0.05;
            const total = subtotal + tax;
            
            document.getElementById('stockSubtotal').textContent = '$' + formatNumber(subtotal);
            document.getElementById('stockTax').textContent = '$' + formatNumber(tax);
            document.getElementById('stockTotal').textContent = '$' + formatNumber(total);
        }

        async function buyStock() {
            if (!selectedStock) return;
            
            const quantity = parseInt(document.getElementById('stockQuantity').value);
            
            if (!quantity || quantity <= 0) {
                showToast('Please enter a valid quantity', 'error');
                return;
            }
            
            const total = quantity * selectedStock.price * 1.05;
            
            if (total > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            try {
                showToast('Processing...');
                const response = await fetch(`${SHEETS_URL}?action=buyStock&email=${encodeURIComponent(currentUser.email)}&symbol=${selectedStock.symbol}&quantity=${quantity}&price=${selectedStock.price}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser.balance = data.newBalance;
                    document.getElementById('balanceAmount').textContent = formatNumber(data.newBalance);
                    showToast(`Bought ${quantity} ${selectedStock.symbol} shares!`, 'success');
                    closeStockModal();
                } else {
                    showToast(data.message || 'Purchase failed', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        // ============ PORTFOLIO ============
        async function loadPortfolio() {
            try {
                const response = await fetch(`${SHEETS_URL}?action=getPortfolio&email=${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                
                if (data.success) {
                    renderPortfolio(data.holdings || []);
                }
            } catch (error) {
                showToast('Failed to load portfolio', 'error');
            }
        }

        function renderPortfolio(holdings) {
            const container = document.getElementById('portfolioList');
            
            if (holdings.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üíº</div><p>No stocks owned</p></div>';
                return;
            }
            
            container.innerHTML = holdings.map(h => {
                const currentValue = h.quantity * h.currentPrice;
                const purchaseValue = h.quantity * h.avgPrice;
                const profit = currentValue - purchaseValue;
                const profitPercent = ((profit / purchaseValue) * 100).toFixed(2);
                
                return `
                    <div class="stock-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <span style="font-weight: 800; color: var(--gold); font-size: 1.25rem;">${h.symbol}</span>
                                <span style="color: var(--text-muted); margin-left: 0.5rem;">${h.quantity} shares</span>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700;">$${formatNumber(currentValue)}</div>
                                <div style="color: ${profit >= 0 ? 'var(--success)' : 'var(--danger)'}; font-size: 0.875rem;">
                                    ${profit >= 0 ? '+' : ''}$${formatNumber(profit)} (${profit >= 0 ? '+' : ''}${profitPercent}%)
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm" onclick="sellStock('${h.symbol}', ${h.quantity}, ${h.currentPrice})">Sell All</button>
                            <button class="btn btn-sm btn-danger" onclick="sellStock('${h.symbol}', Math.floor(${h.quantity}/2), ${h.currentPrice})">Sell Half</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function sellStock(symbol, quantity, price) {
            if (!quantity || quantity <= 0) return;
            
            try {
                showToast('Selling...');
                const response = await fetch(`${SHEETS_URL}?action=sellStock&email=${encodeURIComponent(currentUser.email)}&symbol=${symbol}&quantity=${quantity}&price=${price}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser.balance = data.newBalance;
                    document.getElementById('balanceAmount').textContent = formatNumber(data.newBalance);
                    showToast(`Sold ${quantity} ${symbol} shares! (after 5% tax)`, 'success');
                    loadPortfolio();
                } else {
                    showToast(data.message || 'Sale failed', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        // ============ EMOJI PACKS ============
        const THEMED_PACKS = {
            nature: {
                name: 'üåø Nature Pack',
                emojis: {
                    common: ['üå±','üåø','üçÄ','üåæ','üåµ','üå¥','üå≥','üå≤','üçÉ','üçÇ','üçÅ','ü™¥','üåª','üåº','üå∏','üå∫','üå∑','üåπ','üíê','ü™ª'],
                    uncommon: ['üçÑ','ü™∏','ü™µ','ü™®','üåä','üíß','üî•','üå¨Ô∏è','‚òÄÔ∏è','üå§Ô∏è','‚õÖ','üå•Ô∏è','‚òÅÔ∏è','üå¶Ô∏è','üåßÔ∏è','‚õàÔ∏è','üå©Ô∏è','üå®Ô∏è','‚ùÑÔ∏è','‚òÉÔ∏è'],
                    rare: ['üåà','üåÖ','üåÑ','üåá','üåÜ','üèûÔ∏è','üèîÔ∏è','‚õ∞Ô∏è','üåã','üóª','üèùÔ∏è','üèñÔ∏è','üåå','ü™∑','ü™π','ü™∫'],
                    epic: ['ü¶ã','üêù','üêû','ü¶ó','ü™≤','ü™≥','ü¶ü','ü™∞','üêõ','üêå','üêö','üï∑Ô∏è','üï∏Ô∏è','ü¶Ç','ü¶é','üêç'],
                    legendary: ['üêâ','ü¶ï','ü¶ñ','ü¶§','ü¶©','ü¶ö','ü¶ú','ü¶¢','ü¶Ö','ü¶Ü','üê¶‚Äçüî•'],
                    mythic: ['üåç','üåé','üåè','ü™ê','üåô','‚≠ê','üåü','‚ú®'],
                    divine: ['üîÆ','üíé','üëë']
                }
            },
            space: {
                name: 'üöÄ Space Pack',
                emojis: {
                    common: ['‚≠ê','‚ú®','üí´','üåü','‚ú¥Ô∏è','üî∏','üîπ','üî∂','üî∑','‚ö™','‚ö´','üü§','üî¥','üü†','üü°','üü¢','üîµ','üü£','üü•','üüß'],
                    uncommon: ['üåë','üåí','üåì','üåî','üåï','üåñ','üåó','üåò','üåô','üåö','üåõ','üåú','üåù','üåû','‚òÄÔ∏è','üå§Ô∏è','‚õÖ','üå•Ô∏è','‚òÅÔ∏è','üå¶Ô∏è'],
                    rare: ['ü™ê','‚òÑÔ∏è','üí•','üåä','üåà','‚ö°','üî•','üíß','üå¨Ô∏è','üåÄ','üå™Ô∏è','üå´Ô∏è','üåÅ','üåÉ','üåâ','üéÜ'],
                    epic: ['üõ∏','üöÄ','üõ∞Ô∏è','üî≠','üì°','üõ©Ô∏è','‚úàÔ∏è','üöÅ','üõ∂','‚õµ','üö§','üõ•Ô∏è','üõ≥Ô∏è','‚õ¥Ô∏è','üö¢','üöÇ'],
                    legendary: ['üëΩ','üëæ','ü§ñ','üõ∏','üåå','üå†','‚òÑÔ∏è','ü™ê'],
                    mythic: ['üåç','üåé','üåè','üåê','üó∫Ô∏è','üß≠'],
                    divine: ['üî±','‚öúÔ∏è','üí†']
                }
            },
            diamonds: {
                name: 'üíé Diamonds Pack',
                emojis: {
                    common: ['üí†','üî∑','üîπ','üîµ','üü¶','üî∂','üî∏','üü†','üüß','üî¥','üü•','üü°','üü®','üü¢','üü©','üü£','üü™','‚ö™','‚¨ú','üîò'],
                    uncommon: ['üíç','üìø','üëë','üëí','üé©','üß¢','‚õëÔ∏è','ü™ñ','üíÑ','üíã','üëõ','üëú','üëù','üéí','üß≥','üëì','üï∂Ô∏è','ü•Ω','üåÇ','‚òÇÔ∏è'],
                    rare: ['üíé','üíç','üëë','üèÜ','ü•á','ü•à','ü•â','üèÖ','üéñÔ∏è','üéóÔ∏è','üé´','üéüÔ∏è','üé™','üé†','üé°','üé¢'],
                    epic: ['ü™ô','üí∞','üíµ','üí¥','üí∂','üí∑','üí∏','üí≥','üßæ','üíπ','üìà','üìâ','üìä','üè¶','üèß','üí±'],
                    legendary: ['üíé','üëë','üèÜ','ü•á','üíç','üìø','üîÆ','ü™¨'],
                    mythic: ['üåü','‚≠ê','‚ú®','üí´','‚òÑÔ∏è','üî•'],
                    divine: ['üëë','üíé','üî±']
                }
            },
            animals: {
                name: 'üêæ Animals Pack',
                emojis: {
                    common: ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üôà','üôâ','üôä','üêí','üêî'],
                    uncommon: ['üêß','üê¶','üê§','üê£','üê•','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó','üê¥','ü¶Ñ','üêù','üêõ','ü¶ã','üêå','üêû','üêú','ü¶ü'],
                    rare: ['ü¶ó','ü™≤','ü™≥','ü¶Ç','üê¢','üêç','ü¶é','ü¶ñ','ü¶ï','üêô','ü¶ë','ü¶ê','ü¶û','ü¶Ä','üê°','üê†'],
                    epic: ['üêü','üê¨','üê≥','üêã','ü¶à','üêä','üêÖ','üêÜ','ü¶ì','ü¶ç','ü¶ß','üêò','ü¶õ','ü¶è','üê™','üê´'],
                    legendary: ['ü¶í','ü¶ò','ü¶¨','üêÉ','üêÇ','üêÑ','üêé','üêñ','üêè','üêë','ü¶ô','üêê','ü¶å','üêï','üê©'],
                    mythic: ['ü¶Æ','üêï‚Äçü¶∫','üêà','üêà‚Äç‚¨õ','ü™∂','üêì','ü¶É','ü¶§','ü¶ö','ü¶ú','ü¶¢','ü¶©','üïäÔ∏è','üêá','ü¶ù'],
                    divine: ['üêâ','ü¶Ñ','üê¶‚Äçüî•']
                }
            },
            food: {
                name: 'üçï Food Pack',
                emojis: {
                    common: ['üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','ü´ê','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','üçÜ','ü•ë','ü•¶'],
                    uncommon: ['ü•¨','ü•í','üå∂Ô∏è','ü´ë','üåΩ','ü•ï','ü´í','üßÑ','üßÖ','ü•î','üç†','ü•ê','ü•Ø','üçû','ü•ñ','ü•®','üßÄ','ü•ö','üç≥','üßà'],
                    rare: ['ü•û','üßá','ü•ì','ü•©','üçó','üçñ','ü¶¥','üå≠','üçî','üçü','üçï','ü´ì','ü•™','ü•ô','üßÜ','üåÆ','üåØ','ü´î','ü•ó','ü•ò'],
                    epic: ['ü´ï','üçù','üçú','üç≤','üçõ','üç£','üç±','ü•ü','ü¶™','üç§','üçô','üçö','üçò','üç•','ü•†','ü•Æ','üç¢','üç°','üçß','üç®'],
                    legendary: ['üç¶','ü•ß','üßÅ','üç∞','üéÇ','üçÆ','üç≠','üç¨','üç´','üçø','üç©','üç™','üå∞','ü•ú','üçØ','ü•õ','üçº','ü´ñ','‚òï','üçµ'],
                    mythic: ['üßÉ','ü•§','üßã','üç∂','üç∫','üçª','ü•Ç','üç∑','ü•É','üç∏','üçπ','üßâ','üçæ','üßä'],
                    divine: ['üçæ','ü•Ç','üèÜ']
                }
            },
            sports: {
                name: '‚öΩ Sports Pack',
                emojis: {
                    common: ['‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','ü•è','üé±','ü™Ä','üèì','üè∏','üèí','üèë','ü•ç','üèè','ü™É','ü•Ö','‚õ≥'],
                    uncommon: ['ü™Å','üèπ','üé£','ü§ø','ü•ä','ü•ã','üéΩ','üõπ','üõº','üõ∑','‚õ∏Ô∏è','ü•å','üéø','‚õ∑Ô∏è','üèÇ','ü™Ç','üèãÔ∏è','ü§º','ü§∏','ü§∫'],
                    rare: ['‚õπÔ∏è','ü§æ','üèåÔ∏è','üèá','üßò','üèÑ','üèä','ü§Ω','üö£','üßó','üöµ','üö¥','üèÜ','ü•á','ü•à','ü•â'],
                    epic: ['üèÖ','üéñÔ∏è','üèµÔ∏è','üéóÔ∏è','üé´','üéüÔ∏è','üé™','üé†','üé°','üé¢','üéØ','üé≥','üéÆ','üïπÔ∏è','üé∞','üé≤'],
                    legendary: ['üèÜ','ü•á','üèÖ','üéñÔ∏è','üéóÔ∏è','üèµÔ∏è','‚öúÔ∏è','üî±'],
                    mythic: ['üëë','üíé','üåü','‚≠ê','‚ú®','üí´'],
                    divine: ['üèÜ','üëë','üî±']
                }
            },
            fantasy: {
                name: 'üßô Fantasy Pack',
                emojis: {
                    common: ['üó°Ô∏è','üõ°Ô∏è','‚öîÔ∏è','üèπ','ü™ì','üî®','‚õèÔ∏è','ü™ö','üîß','ü™õ','üî©','‚öôÔ∏è','üóúÔ∏è','‚öñÔ∏è','ü¶Ø','üîó','‚õìÔ∏è','ü™ù','üß∞','üß≤'],
                    uncommon: ['üß™','üß´','üß¨','üî¨','üî≠','üì°','üíâ','ü©∏','üíä','ü©π','ü©∫','üö™','üõó','ü™û','ü™ü','üõèÔ∏è','üõãÔ∏è','ü™ë','üöΩ','ü™†'],
                    rare: ['üè∞','üèØ','üóº','üóΩ','‚õ™','üïå','üõï','üïç','‚õ©Ô∏è','üïã','‚õ≤','‚õ∫','üåÅ','üåÉ','üèôÔ∏è','üåÑ'],
                    epic: ['üßô','üßô‚Äç‚ôÇÔ∏è','üßô‚Äç‚ôÄÔ∏è','üßö','üßö‚Äç‚ôÇÔ∏è','üßö‚Äç‚ôÄÔ∏è','üßõ','üßõ‚Äç‚ôÇÔ∏è','üßõ‚Äç‚ôÄÔ∏è','üßú','üßú‚Äç‚ôÇÔ∏è','üßú‚Äç‚ôÄÔ∏è','üßù','üßù‚Äç‚ôÇÔ∏è','üßù‚Äç‚ôÄÔ∏è','üßû'],
                    legendary: ['üßû‚Äç‚ôÇÔ∏è','üßû‚Äç‚ôÄÔ∏è','üßü','üßü‚Äç‚ôÇÔ∏è','üßü‚Äç‚ôÄÔ∏è','üëª','üíÄ','‚ò†Ô∏è','üëΩ','üëæ','ü§ñ','üéÉ'],
                    mythic: ['üîÆ','ü™Ñ','üìú','üìø','üßø','ü™¨','üíé','üëë'],
                    divine: ['üêâ','‚öúÔ∏è','üî±']
                }
            },
            tech: {
                name: 'üíª Tech Pack',
                emojis: {
                    common: ['üíª','üñ•Ô∏è','üñ®Ô∏è','‚å®Ô∏è','üñ±Ô∏è','üñ≤Ô∏è','üíΩ','üíæ','üíø','üìÄ','üßÆ','üì±','üì≤','‚òéÔ∏è','üìû','üìü','üì†','üì∫','üìª','üéôÔ∏è'],
                    uncommon: ['üéöÔ∏è','üéõÔ∏è','üß≠','‚è±Ô∏è','‚è≤Ô∏è','‚è∞','üï∞Ô∏è','‚åõ','‚è≥','üì°','üîã','üîå','üí°','üî¶','üïØÔ∏è','üßØ','üõ¢Ô∏è','üí∏','üíµ','üí¥'],
                    rare: ['üí∂','üí∑','üí∞','üí≥','üíé','‚öñÔ∏è','ü™ú','üß∞','ü™õ','üîß','üî®','‚öíÔ∏è','üõ†Ô∏è','‚õèÔ∏è','ü™ö','üî©','‚öôÔ∏è','üóúÔ∏è','‚õìÔ∏è','üîó'],
                    epic: ['ü™ù','üß≤','üî¨','üî≠','üì°','üíâ','ü©∏','üíä','ü©π','ü©º','ü©∫','ü©ª','üö™','üõó','ü™û','ü™ü'],
                    legendary: ['ü§ñ','üëæ','üõ∏','üöÄ','üõ∞Ô∏è','üì±','üíª','üñ•Ô∏è'],
                    mythic: ['üîÆ','üíé','‚ö°','üî•','üí´','‚ú®'],
                    divine: ['ü§ñ','üî±','üí†']
                }
            },
            ocean: {
                name: 'üåä Ocean Pack',
                emojis: {
                    common: ['üåä','üíß','üí¶','ü´ß','üßä','‚ùÑÔ∏è','‚òÉÔ∏è','‚õÑ','üå¨Ô∏è','üí®','üåÄ','üå™Ô∏è','üå´Ô∏è','üåÅ','üåÉ','üèôÔ∏è','üåÜ','üåá','üåâ','üåå'],
                    uncommon: ['üêö','ü¶™','üê†','üêü','üê°','ü¶ê','ü¶û','ü¶Ä','üêô','ü¶ë','üê≥','üêã','üê¨','ü¶≠','ü¶à','üêä','üê¢','ü¶é','üêç','üêâ'],
                    rare: ['‚õµ','üõ∂','üö§','üõ•Ô∏è','üõ≥Ô∏è','‚õ¥Ô∏è','üö¢','‚öì','ü™ù','‚õΩ','üöß','üõü','üèùÔ∏è','üèñÔ∏è','üêö','ü¶™'],
                    epic: ['üßú','üßú‚Äç‚ôÇÔ∏è','üßú‚Äç‚ôÄÔ∏è','üåä','üèÑ','üèÑ‚Äç‚ôÇÔ∏è','üèÑ‚Äç‚ôÄÔ∏è','üèä','üèä‚Äç‚ôÇÔ∏è','üèä‚Äç‚ôÄÔ∏è','ü§Ω','ü§Ω‚Äç‚ôÇÔ∏è','ü§Ω‚Äç‚ôÄÔ∏è','üö£','üö£‚Äç‚ôÇÔ∏è','üö£‚Äç‚ôÄÔ∏è'],
                    legendary: ['üê≥','üêã','ü¶à','üêô','ü¶ë','üê¨','ü¶≠','üêä'],
                    mythic: ['üßú','üåä','üî±','‚öì','üèùÔ∏è','ü™∏'],
                    divine: ['üî±','üßú‚Äç‚ôÄÔ∏è','üêâ']
                }
            },
            mystery: {
                name: 'üé≠ Mystery Pack',
                emojis: {
                    common: ['‚ùì','‚ùî','‚ùï','‚ùó','‚ÄºÔ∏è','‚ÅâÔ∏è','üîÖ','üîÜ','‚öúÔ∏è','üî±','üìõ','üî∞','‚≠ï','‚úÖ','‚òëÔ∏è','‚úîÔ∏è','‚ùå','‚ùé','‚ûï','‚ûñ'],
                    uncommon: ['‚ûó','‚úñÔ∏è','‚ôæÔ∏è','üí≤','üí±','‚Ñ¢Ô∏è','¬©Ô∏è','¬ÆÔ∏è','üëÅÔ∏è‚Äçüó®Ô∏è','üîö','üîô','üîõ','üîú','üîù','üîÉ','üîÑ','üîÄ','üîÅ','üîÇ','‚ñ∂Ô∏è'],
                    rare: ['‚è©','‚è≠Ô∏è','‚èØÔ∏è','‚óÄÔ∏è','‚è™','‚èÆÔ∏è','üîº','‚è´','üîΩ','‚è¨','‚è∏Ô∏è','‚èπÔ∏è','‚è∫Ô∏è','‚èèÔ∏è','üé¶','üîÖ','üîÜ','üì∂','üì≥','üì¥'],
                    epic: ['üé≠','üé™','üé®','üé¨','üé§','üéß','üéº','üéπ','ü•Å','ü™ò','üé∑','üé∫','üé∏','ü™ï','üéª','ü™ó'],
                    legendary: ['üëª','üíÄ','‚ò†Ô∏è','üëΩ','üëæ','ü§ñ','üéÉ','üîÆ','üßø','ü™¨'],
                    mythic: ['üîÆ','ü™Ñ','üìú','üóùÔ∏è','üîê','üîí','üîì','üîè'],
                    divine: ['üé≠','üîÆ','üëë']
                }
            }
        };

        const RARITY_CHANCES = { common: 50, uncommon: 30, rare: 12, epic: 5, legendary: 2, mythic: 0.8, divine: 0.2 };
        const RARITY_POINTS = { common: 10, uncommon: 25, rare: 100, epic: 500, legendary: 2500, mythic: 10000, divine: 50000 };
        const RARITY_SELL = { common: 500, uncommon: 2000, rare: 10000, epic: 25000, legendary: 75000, mythic: 200000, divine: 500000 };
        const PACK_PRICE = 7500;
        
        let selectedPack = null;

        function loadPacks() {
            const container = document.getElementById('packsList');
            
            container.innerHTML = Object.entries(THEMED_PACKS).map(([key, pack]) => `
                <div class="pack-card ${selectedPack === key ? 'selected' : ''}" onclick="selectPack('${key}')">
                    <h3 style="color: var(--gold); margin-bottom: 0.5rem;">${pack.name}</h3>
                    <div class="pack-emojis">
                        ${pack.emojis.common.slice(0,2).join('')}${pack.emojis.rare[0]}${pack.emojis.legendary[0]}${pack.emojis.divine[0]}
                    </div>
                    <p style="font-size: 1.25rem; font-weight: 700; color: var(--gold);">$${formatNumber(PACK_PRICE)}</p>
                    <p style="font-size: 0.75rem; color: var(--text-muted);">Click to select</p>
                </div>
            `).join('');
        }
        
        function selectPack(packKey) {
            selectedPack = packKey;
            loadPacks();
            document.getElementById('buyPackBtn').disabled = false;
            showToast(`Selected: ${THEMED_PACKS[packKey].name}`, 'success');
        }

        async function buyPack() {
            if (!selectedPack) {
                showToast('Select a pack first!', 'error');
                return;
            }
            
            if (currentUser.balance < PACK_PRICE) {
                showToast('Insufficient balance!', 'error');
                return;
            }
            
            const pack = THEMED_PACKS[selectedPack];
            
            // Determine rarity
            const roll = Math.random() * 100;
            let cumulative = 0;
            let rarity = 'common';
            
            for (const [r, chance] of Object.entries(RARITY_CHANCES)) {
                cumulative += chance;
                if (roll < cumulative) {
                    rarity = r;
                    break;
                }
            }
            
            // Pick emoji from this pack's rarity pool
            const pool = pack.emojis[rarity];
            const emoji = pool[Math.floor(Math.random() * pool.length)];
            
            try {
                const response = await fetch(`${SHEETS_URL}?action=buyPack&email=${encodeURIComponent(currentUser.email)}&emoji=${encodeURIComponent(emoji)}&rarity=${rarity}&price=${PACK_PRICE}&points=${RARITY_POINTS[rarity]}&pack=${selectedPack}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser.balance = data.newBalance;
                    document.getElementById('balanceAmount').textContent = formatNumber(data.newBalance);
                    showPackOpening(emoji, rarity, data.isDuplicate, pack.name);
                } else {
                    showToast(data.message || 'Failed to open pack', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        function showPackOpening(emoji, rarity, isDuplicate, packName) {
            const modal = document.getElementById('packOpeningModal');
            modal.className = 'pack-opening';
            
            const rarityColors = {
                common: '#ffffff',
                uncommon: '#22c55e',
                rare: '#3b82f6',
                epic: '#a855f7',
                legendary: '#fbbf24',
                mythic: '#ec4899',
                divine: '#06b6d4'
            };
            
            modal.innerHTML = `
                <div class="pack-reveal">${emoji}</div>
                <div class="pack-rarity-text" style="color: ${rarityColors[rarity]};">
                    ${rarity.toUpperCase()}!
                </div>
                <p style="margin-top: 1rem; color: var(--text-muted);">
                    ${isDuplicate ? '(Duplicate - 0 points)' : `+${RARITY_POINTS[rarity]} points!`}
                </p>
                <button class="btn" onclick="closePackOpening()" style="margin-top: 2rem;">Continue</button>
            `;
        }

        function closePackOpening() {
            document.getElementById('packOpeningModal').className = 'hidden';
        }

        function showChancesModal() {
            document.getElementById('chancesModal').classList.add('active');
        }

        function closeChancesModal() {
            document.getElementById('chancesModal').classList.remove('active');
        }

        // ============ COLLECTION ============
        async function loadCollection() {
            try {
                const response = await fetch(`${SHEETS_URL}?action=getCollection&email=${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('emojiScore').textContent = (data.totalPoints || 0) + ' pts';
                    renderCollection(data.emojis || []);
                }
            } catch (error) {
                showToast('Failed to load collection', 'error');
            }
        }

        function renderCollection(emojis) {
            const container = document.getElementById('emojiCollection');
            
            if (emojis.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üéí</div><p>No emojis yet. Buy some packs!</p></div>';
                return;
            }
            
            container.innerHTML = emojis.map(e => `
                <div class="emoji-card ${e.rarity}" onclick="sellEmoji('${e.emoji}', '${e.rarity}')">
                    <span class="emoji">${e.emoji}</span>
                    <span class="rarity-badge ${e.rarity}">${e.rarity}</span>
                    <span style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">
                        Sell: $${formatNumber(RARITY_SELL[e.rarity])}
                    </span>
                </div>
            `).join('');
        }

        async function sellEmoji(emoji, rarity) {
            if (!confirm(`Sell ${emoji} for $${formatNumber(RARITY_SELL[rarity])}?`)) return;
            
            try {
                const response = await fetch(`${SHEETS_URL}?action=sellEmoji&email=${encodeURIComponent(currentUser.email)}&emoji=${encodeURIComponent(emoji)}&rarity=${rarity}&price=${RARITY_SELL[rarity]}&points=${RARITY_POINTS[rarity]}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser.balance = data.newBalance;
                    document.getElementById('balanceAmount').textContent = formatNumber(data.newBalance);
                    showToast(`Sold ${emoji} for $${formatNumber(RARITY_SELL[rarity])}!`, 'success');
                    loadCollection();
                } else {
                    showToast(data.message || 'Sale failed', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        // ============ PASSPORT ============
        async function loadPassport() {
            try {
                const response = await fetch(`${SHEETS_URL}?action=getPassport&email=${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                
                if (data.success) {
                    const info = document.getElementById('passportInfo');
                    const btn = document.getElementById('applyPassportBtn');
                    
                    if (data.hasPassport) {
                        info.innerHTML = `
                            <div style="background: var(--gradient-gold); padding: 2rem; border-radius: 16px; color: var(--bg-primary); text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üõÇ</div>
                                <h3>LINTORIA PASSPORT</h3>
                                <p style="font-size: 1.25rem; margin-top: 0.5rem;">${currentUser.name}</p>
                                <p style="font-size: 0.875rem; margin-top: 0.5rem;">Issued: ${data.issueDate}</p>
                            </div>
                        `;
                        btn.textContent = '‚úì Passport Owned';
                        btn.disabled = true;
                    } else {
                        info.innerHTML = '<p style="color: var(--text-muted);">You don\'t have a passport yet. Apply to travel!</p>';
                        btn.disabled = false;
                    }
                    
                    renderVisas(data.visas || []);
                }
            } catch (error) {
                showToast('Failed to load passport', 'error');
            }
        }

        function renderVisas(visas) {
            const container = document.getElementById('visasList');
            
            if (visas.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted);">No visas yet. Travel to earn them!</p>';
                return;
            }
            
            container.innerHTML = visas.map(v => `
                <div style="display: inline-block; padding: 0.5rem 1rem; background: rgba(251, 191, 36, 0.2); border-radius: 8px; margin: 0.25rem;">
                    ${v.flag} ${v.country}
                </div>
            `).join('');
        }

        async function applyPassport() {
            if (currentUser.balance < 500) {
                showToast('Insufficient balance! Need $500', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${SHEETS_URL}?action=applyPassport&email=${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser.balance = data.newBalance;
                    document.getElementById('balanceAmount').textContent = formatNumber(data.newBalance);
                    showToast('Passport issued!', 'success');
                    loadPassport();
                } else {
                    showToast(data.message || 'Application failed', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        // ============ TRAVEL ============
        const CITIES = [
            { name: 'Paris', country: 'France', flag: 'üá´üá∑', cost: 2500, bonus: 500 },
            { name: 'Tokyo', country: 'Japan', flag: 'üáØüáµ', cost: 4000, bonus: 800 },
            { name: 'New York', country: 'USA', flag: 'üá∫üá∏', cost: 3000, bonus: 600 },
            { name: 'London', country: 'UK', flag: 'üá¨üáß', cost: 2800, bonus: 550 },
            { name: 'Dubai', country: 'UAE', flag: 'üá¶üá™', cost: 5000, bonus: 1000 },
            { name: 'Sydney', country: 'Australia', flag: 'üá¶üá∫', cost: 4500, bonus: 900 },
            { name: 'Rio', country: 'Brazil', flag: 'üáßüá∑', cost: 3500, bonus: 700 },
            { name: 'Cairo', country: 'Egypt', flag: 'üá™üá¨', cost: 2000, bonus: 400 }
        ];

        function loadTravel() {
            const container = document.getElementById('citiesList');
            
            container.innerHTML = CITIES.map(city => `
                <div class="service-card" style="text-align: center;">
                    <div style="font-size: 3rem;">${city.flag}</div>
                    <h3 style="color: var(--gold); margin: 0.5rem 0;">${city.name}</h3>
                    <p style="color: var(--text-muted);">${city.country}</p>
                    <p style="margin-top: 0.5rem;">Flight: <strong>$${formatNumber(city.cost)}</strong></p>
                    <p style="color: var(--success); font-size: 0.875rem;">Bonus: +$${formatNumber(city.bonus)}</p>
                    <button class="btn btn-sm" onclick="bookFlight('${city.name}', '${city.country}', '${city.flag}', ${city.cost}, ${city.bonus})" style="margin-top: 1rem;">
                        ‚úàÔ∏è Book Flight
                    </button>
                </div>
            `).join('');
            
            loadFlights();
        }

        async function bookFlight(name, country, flag, cost, bonus) {
            if (currentUser.balance < cost) {
                showToast('Insufficient balance!', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${SHEETS_URL}?action=bookFlight&email=${encodeURIComponent(currentUser.email)}&city=${encodeURIComponent(name)}&country=${encodeURIComponent(country)}&flag=${encodeURIComponent(flag)}&cost=${cost}&bonus=${bonus}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser.balance = data.newBalance;
                    document.getElementById('balanceAmount').textContent = formatNumber(data.newBalance);
                    showToast(`Flight booked to ${name}! Bonus: +$${formatNumber(bonus)}`, 'success');
                    loadFlights();
                } else {
                    showToast(data.message || 'Booking failed', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        async function loadFlights() {
            try {
                const response = await fetch(`${SHEETS_URL}?action=getFlights&email=${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('flightsList');
                    
                    if (!data.flights || data.flights.length === 0) {
                        container.innerHTML = '<div class="empty-state"><p>No flights booked</p></div>';
                        return;
                    }
                    
                    container.innerHTML = data.flights.map(f => `
                        <div class="transaction-item">
                            <div>
                                <span style="font-size: 1.5rem; margin-right: 0.5rem;">${f.flag}</span>
                                <strong>${f.city}, ${f.country}</strong>
                                <div style="color: var(--text-muted); font-size: 0.75rem;">${formatDate(f.date)}</div>
                            </div>
                            <span style="color: var(--success);">+$${formatNumber(f.bonus)}</span>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load flights');
            }
        }

        // ============ CASINO - PLINKO ============
        const PLINKO_SLOTS = [
            { mult: 100, class: 'x100' },
            { mult: 5, class: 'x5' },
            { mult: 1, class: 'x1' },
            { mult: 0.5, class: 'x05' },
            { mult: 0.1, class: 'x01' },
            { mult: 0.1, class: 'x01' },
            { mult: 0.1, class: 'x01' },
            { mult: 0.5, class: 'x05' },
            { mult: 1, class: 'x1' },
            { mult: 5, class: 'x5' },
            { mult: 100, class: 'x100' }
        ];
        
        let plinkoBallId = 0;

        function initPlinko() {
            const board = document.getElementById('plinkoBoard');
            const slotsContainer = document.getElementById('plinkoSlots');
            
            // Create pegs
            const rows = 10;
            const boardWidth = 360;
            const boardHeight = 300;
            
            for (let row = 0; row < rows; row++) {
                const pegsInRow = row + 3;
                const rowWidth = (pegsInRow - 1) * 35;
                const startX = (boardWidth - rowWidth) / 2;
                
                for (let peg = 0; peg < pegsInRow; peg++) {
                    const pegEl = document.createElement('div');
                    pegEl.className = 'plinko-peg';
                    pegEl.style.left = (startX + peg * 35) + 'px';
                    pegEl.style.top = (30 + row * 27) + 'px';
                    board.appendChild(pegEl);
                }
            }
            
            // Create slots
            slotsContainer.innerHTML = PLINKO_SLOTS.map(s => 
                `<div class="plinko-slot ${s.class}">${s.mult}x</div>`
            ).join('');
        }

        async function playPlinko() {
            const bet = parseFloat(document.getElementById('plinkoBet').value);
            
            if (!bet || bet <= 0) {
                showToast('Enter a valid bet', 'error');
                return;
            }
            
            if (bet > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            // Don't disable button - allow multiple balls
            
            // Determine outcome (house edge)
            const roll = Math.random() * 100;
            let slotIndex;
            
            if (roll < 45) {
                // 45% - center slots (0.1x)
                slotIndex = [4, 5, 6][Math.floor(Math.random() * 3)];
            } else if (roll < 70) {
                // 25% - medium-low slots (0.5x)
                slotIndex = Math.random() > 0.5 ? 3 : 7;
            } else if (roll < 85) {
                // 15% - medium slots (1x)
                slotIndex = Math.random() > 0.5 ? 2 : 8;
            } else if (roll < 95) {
                // 10% - good slots (5x)
                slotIndex = Math.random() > 0.5 ? 1 : 9;
            } else {
                // 5% - jackpot (100x)
                slotIndex = Math.random() > 0.5 ? 0 : 10;
            }
            
            const multiplier = PLINKO_SLOTS[slotIndex].mult;
            const winnings = bet * multiplier;
            const profit = winnings - bet;
            
            // Create new ball with unique ID
            const ballId = 'plinkoBall_' + (++plinkoBallId);
            const board = document.getElementById('plinkoBoard');
            
            const ball = document.createElement('div');
            ball.className = 'plinko-ball';
            ball.id = ballId;
            ball.style.position = 'absolute';
            ball.style.left = (board.offsetWidth / 2 - 8) + 'px';
            ball.style.top = '0px';
            ball.style.display = 'block';
            board.appendChild(ball);
            
            // Simple animation
            let currentY = 0;
            const targetX = 15 + slotIndex * 30;
            let currentX = board.offsetWidth / 2 - 8;
            
            const animateInterval = setInterval(() => {
                currentY += 8;
                currentX += (targetX - currentX) * 0.1 + (Math.random() - 0.5) * 10;
                
                ball.style.top = currentY + 'px';
                ball.style.left = Math.max(10, Math.min(350, currentX)) + 'px';
                
                if (currentY >= 260) {
                    clearInterval(animateInterval);
                    ball.remove();
                    
                    // Highlight slot
                    const slots = document.querySelectorAll('.plinko-slot');
                    slots[slotIndex].classList.add('active');
                    setTimeout(() => slots[slotIndex].classList.remove('active'), 2000);
                    
                    // Process result
                    processGambleResult('plinko', bet, winnings, profit, 'plinkoResult', null);
                }
            }, 30);
        }

        // ============ CASINO - ROULETTE ============
        const ROULETTE_NUMBERS = [
            { num: 0, color: 'green' },
            { num: 32, color: 'red' }, { num: 15, color: 'black' }, { num: 19, color: 'red' }, { num: 4, color: 'black' },
            { num: 21, color: 'red' }, { num: 2, color: 'black' }, { num: 25, color: 'red' }, { num: 17, color: 'black' },
            { num: 34, color: 'red' }, { num: 6, color: 'black' }, { num: 27, color: 'red' }, { num: 13, color: 'black' },
            { num: 36, color: 'red' }, { num: 11, color: 'black' }, { num: 30, color: 'red' }, { num: 8, color: 'black' },
            { num: 23, color: 'red' }, { num: 10, color: 'black' }, { num: 5, color: 'red' }, { num: 24, color: 'black' },
            { num: 16, color: 'red' }, { num: 33, color: 'black' }, { num: 1, color: 'red' }, { num: 20, color: 'black' },
            { num: 14, color: 'red' }, { num: 31, color: 'black' }, { num: 9, color: 'red' }, { num: 22, color: 'black' },
            { num: 18, color: 'red' }, { num: 29, color: 'black' }, { num: 7, color: 'red' }, { num: 28, color: 'black' },
            { num: 12, color: 'red' }, { num: 35, color: 'black' }, { num: 3, color: 'red' }, { num: 26, color: 'black' }
        ];

        function initRoulette() {
            const wheel = document.getElementById('rouletteWheel');
            const numCount = ROULETTE_NUMBERS.length;
            const anglePerNum = 360 / numCount;
            
            ROULETTE_NUMBERS.forEach((n, i) => {
                const angle = i * anglePerNum;
                const rad = (angle - 90) * (Math.PI / 180);
                const radius = 110;
                const x = 140 + radius * Math.cos(rad) - 15;
                const y = 140 + radius * Math.sin(rad) - 15;
                
                const numEl = document.createElement('div');
                numEl.className = 'roulette-number';
                numEl.style.left = x + 'px';
                numEl.style.top = y + 'px';
                numEl.style.background = n.color === 'red' ? '#dc2626' : n.color === 'green' ? '#16a34a' : '#1f2937';
                numEl.textContent = n.num;
                wheel.appendChild(numEl);
            });
        }

        async function playRoulette(betColor) {
            const bet = parseFloat(document.getElementById('rouletteBet').value);
            
            if (!bet || bet <= 0) {
                showToast('Enter a valid bet', 'error');
                return;
            }
            
            if (bet > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            // Disable buttons
            ['rouletteRedBtn', 'rouletteBlackBtn', 'rouletteGreenBtn'].forEach(id => {
                document.getElementById(id).disabled = true;
            });
            
            // Determine outcome (house edge ~60%)
            const roll = Math.random() * 100;
            let resultColor;
            
            if (roll < 2.7) {
                resultColor = 'green';
            } else if (roll < 51.35) {
                resultColor = 'red';
            } else {
                resultColor = 'black';
            }
            
            // Find a number with that color
            const possibleNums = ROULETTE_NUMBERS.filter(n => n.color === resultColor);
            const resultNum = possibleNums[Math.floor(Math.random() * possibleNums.length)];
            const resultIndex = ROULETTE_NUMBERS.indexOf(resultNum);
            
            // Spin animation
            const wheel = document.getElementById('rouletteWheel');
            const anglePerNum = 360 / ROULETTE_NUMBERS.length;
            const targetAngle = 360 * 5 + (360 - resultIndex * anglePerNum);
            
            wheel.style.transition = 'transform 5s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
            wheel.style.transform = `rotate(${targetAngle}deg)`;
            
            setTimeout(() => {
                wheel.style.transition = 'none';
                wheel.style.transform = `rotate(${targetAngle % 360}deg)`;
                
                const win = betColor === resultColor;
                let multiplier = 0;
                if (win) {
                    multiplier = betColor === 'green' ? 10 : 1.9;
                }
                
                const winnings = bet * multiplier;
                const profit = winnings - bet;
                
                document.getElementById('rouletteResult').innerHTML = `
                    <span style="color: ${resultColor === 'red' ? '#ef4444' : resultColor === 'green' ? '#22c55e' : '#fff'};">
                        ${resultNum.num} ${resultColor.toUpperCase()}
                    </span> - ${win ? `WIN! +$${formatNumber(profit)}` : `LOSE -$${formatNumber(bet)}`}
                `;
                
                processGambleResult('roulette', bet, winnings, profit, null, null);
                
                ['rouletteRedBtn', 'rouletteBlackBtn', 'rouletteGreenBtn'].forEach(id => {
                    document.getElementById(id).disabled = false;
                });
            }, 5000);
        }

        // ============ CASINO - FORTUNE WHEEL ============
        const WHEEL_SEGMENTS = [
            { mult: 0, color: '#ef4444', label: '0x' },
            { mult: 0.5, color: '#f97316', label: '0.5x' },
            { mult: 1, color: '#eab308', label: '1x' },
            { mult: 1.5, color: '#84cc16', label: '1.5x' },
            { mult: 2, color: '#22c55e', label: '2x' },
            { mult: 0.5, color: '#f97316', label: '0.5x' },
            { mult: 5, color: '#14b8a6', label: '5x' },
            { mult: 0, color: '#ef4444', label: '0x' },
            { mult: 1, color: '#eab308', label: '1x' },
            { mult: 10, color: '#06b6d4', label: '10x' },
            { mult: 0.5, color: '#f97316', label: '0.5x' },
            { mult: 100, color: '#8b5cf6', label: '100x' }
        ];

        function initFortuneWheel() {
            const wheel = document.getElementById('fortuneWheel');
            const segmentAngle = 360 / WHEEL_SEGMENTS.length;
            
            WHEEL_SEGMENTS.forEach((seg, i) => {
                const segEl = document.createElement('div');
                segEl.className = 'wheel-segment';
                segEl.style.background = seg.color;
                segEl.style.transform = `rotate(${i * segmentAngle - 90}deg) skewY(${90 - segmentAngle}deg)`;
                segEl.innerHTML = `<span>${seg.label}</span>`;
                wheel.appendChild(segEl);
            });
        }

        async function playWheel() {
            const bet = parseFloat(document.getElementById('wheelBet').value);
            
            if (!bet || bet <= 0) {
                showToast('Enter a valid bet', 'error');
                return;
            }
            
            if (bet > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            const btn = document.getElementById('wheelBtn');
            btn.disabled = true;
            
            // Weighted outcome (house edge)
            const roll = Math.random() * 100;
            let segIndex;
            
            if (roll < 25) segIndex = 0; // 0x
            else if (roll < 50) segIndex = 1; // 0.5x
            else if (roll < 70) segIndex = 2; // 1x
            else if (roll < 82) segIndex = 3; // 1.5x
            else if (roll < 90) segIndex = 4; // 2x
            else if (roll < 95) segIndex = 6; // 5x
            else if (roll < 98) segIndex = 9; // 10x
            else segIndex = 11; // 100x
            
            const multiplier = WHEEL_SEGMENTS[segIndex].mult;
            const winnings = bet * multiplier;
            const profit = winnings - bet;
            
            // Spin
            const wheel = document.getElementById('fortuneWheel');
            const segmentAngle = 360 / WHEEL_SEGMENTS.length;
            const targetAngle = 360 * 6 + (360 - segIndex * segmentAngle - segmentAngle / 2);
            
            wheel.style.transition = 'transform 6s cubic-bezier(0.17, 0.67, 0.05, 0.99)';
            wheel.style.transform = `rotate(${targetAngle}deg)`;
            
            setTimeout(() => {
                wheel.style.transition = 'none';
                wheel.style.transform = `rotate(${targetAngle % 360}deg)`;
                
                processGambleResult('wheel', bet, winnings, profit, 'wheelResult', 'wheelBtn');
            }, 6000);
        }

        // ============ CASINO - DICE ============
        async function playDice() {
            const bet = parseFloat(document.getElementById('diceBet').value);
            
            if (!bet || bet <= 0) {
                showToast('Enter a valid bet', 'error');
                return;
            }
            
            if (bet > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            const btn = document.getElementById('diceBtn');
            btn.disabled = true;
            
            const dice = document.getElementById('dice');
            dice.classList.add('rolling');
            
            // 40% win chance
            const win = Math.random() < 0.4;
            const multiplier = win ? 1.9 : 0;
            const winnings = bet * multiplier;
            const profit = winnings - bet;
            
            const faces = ['‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
            const resultFace = win ? faces[Math.floor(Math.random() * 3) + 3] : faces[Math.floor(Math.random() * 3)];
            
            setTimeout(() => {
                dice.classList.remove('rolling');
                dice.querySelector('.front').textContent = resultFace;
                
                processGambleResult('dice', bet, winnings, profit, 'diceResult', 'diceBtn');
            }, 1000);
        }

        // ============ CASINO - SLOTS ============
        const SLOT_SYMBOLS = ['üçí', 'üçã', 'üçä', 'üçá', '‚≠ê', 'üíé', '7Ô∏è‚É£'];

        async function playSlots() {
            const bet = parseFloat(document.getElementById('slotsBet').value);
            
            if (!bet || bet <= 0) {
                showToast('Enter a valid bet', 'error');
                return;
            }
            
            if (bet > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            const btn = document.getElementById('slotsBtn');
            btn.disabled = true;
            
            // Start spinning
            const reels = [
                document.getElementById('reel1'),
                document.getElementById('reel2'),
                document.getElementById('reel3')
            ];
            
            reels.forEach(r => r.classList.add('spinning'));
            
            // Determine outcome (house edge)
            const roll = Math.random() * 100;
            let result;
            
            if (roll < 60) {
                // No match
                result = [
                    SLOT_SYMBOLS[Math.floor(Math.random() * 4)],
                    SLOT_SYMBOLS[Math.floor(Math.random() * 4) + 1],
                    SLOT_SYMBOLS[Math.floor(Math.random() * 4) + 2]
                ];
            } else if (roll < 85) {
                // Two match
                const sym = SLOT_SYMBOLS[Math.floor(Math.random() * 5)];
                result = [sym, sym, SLOT_SYMBOLS[(SLOT_SYMBOLS.indexOf(sym) + 1) % SLOT_SYMBOLS.length]];
            } else if (roll < 98) {
                // Three match (normal)
                const sym = SLOT_SYMBOLS[Math.floor(Math.random() * 5)];
                result = [sym, sym, sym];
            } else {
                // Jackpot
                result = ['7Ô∏è‚É£', '7Ô∏è‚É£', '7Ô∏è‚É£'];
            }
            
            // Calculate winnings
            let multiplier = 0;
            if (result[0] === result[1] && result[1] === result[2]) {
                if (result[0] === '7Ô∏è‚É£') multiplier = 25;
                else if (result[0] === 'üíé') multiplier = 15;
                else if (result[0] === '‚≠ê') multiplier = 10;
                else multiplier = 5;
            } else if (result[0] === result[1] || result[1] === result[2]) {
                multiplier = 1.5;
            }
            
            const winnings = bet * multiplier;
            const profit = winnings - bet;
            
            // Stop reels sequentially
            reels.forEach((reel, i) => {
                setTimeout(() => {
                    reel.classList.remove('spinning');
                    reel.querySelector('.slot-symbol').textContent = result[i];
                    
                    if (i === 2) {
                        processGambleResult('slots', bet, winnings, profit, 'slotsResult', 'slotsBtn');
                    }
                }, 500 + i * 500);
            });
        }

        // ============ CASINO - BLACKJACK ============
        const CARD_SUITS = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
        const CARD_VALUES = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

        function createCard() {
            const suit = CARD_SUITS[Math.floor(Math.random() * 4)];
            const value = CARD_VALUES[Math.floor(Math.random() * 13)];
            const isRed = suit === '‚ô•' || suit === '‚ô¶';
            
            let numValue = parseInt(value);
            if (isNaN(numValue)) {
                numValue = value === 'A' ? 11 : 10;
            }
            
            return { suit, value, numValue, isRed };
        }

        function calculateHand(cards) {
            let total = cards.reduce((sum, c) => sum + c.numValue, 0);
            let aces = cards.filter(c => c.value === 'A').length;
            
            while (total > 21 && aces > 0) {
                total -= 10;
                aces--;
            }
            
            return total;
        }

        function renderCard(card) {
            return `<div class="playing-card ${card.isRed ? 'red' : 'black'}">${card.value}${card.suit}</div>`;
        }

        // Interactive Blackjack State
        let blackjackState = {
            bet: 0,
            playerHand: [],
            dealerHand: [],
            gameOver: false
        };

        async function startBlackjack() {
            const bet = parseFloat(document.getElementById('blackjackBet').value);
            
            if (!bet || bet <= 0) {
                showToast('Enter a valid bet', 'error');
                return;
            }
            
            if (bet > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            blackjackState = {
                bet: bet,
                playerHand: [],
                dealerHand: [],
                gameOver: false
            };
            
            const dealBtn = document.getElementById('blackjackDealBtn');
            const actionsDiv = document.getElementById('blackjackActions');
            const playerHand = document.getElementById('playerHand');
            const dealerHand = document.getElementById('dealerHand');
            const result = document.getElementById('blackjackResult');
            
            dealBtn.disabled = true;
            actionsDiv.classList.remove('hidden');
            actionsDiv.style.display = 'grid';
            playerHand.innerHTML = '';
            dealerHand.innerHTML = '';
            result.textContent = '';
            
            // Deal initial cards
            blackjackState.playerHand = [createCard(), createCard()];
            blackjackState.dealerHand = [createCard(), createCard()];
            
            // Animate dealing
            await delay(300);
            playerHand.innerHTML += renderCard(blackjackState.playerHand[0]);
            await delay(300);
            dealerHand.innerHTML += renderCard(blackjackState.dealerHand[0]);
            await delay(300);
            playerHand.innerHTML += renderCard(blackjackState.playerHand[1]);
            await delay(300);
            dealerHand.innerHTML += `<div class="playing-card" style="background: linear-gradient(135deg, #1e40af, #3b82f6); color: white;">?</div>`;
            
            updateBlackjackTotals();
            
            // Check for natural blackjack
            const playerTotal = calculateHand(blackjackState.playerHand);
            if (playerTotal === 21) {
                blackjackStand();
            }
        }

        function updateBlackjackTotals() {
            const playerTotal = calculateHand(blackjackState.playerHand);
            document.getElementById('playerTotal').textContent = `(${playerTotal})`;
            
            if (blackjackState.gameOver) {
                const dealerTotal = calculateHand(blackjackState.dealerHand);
                document.getElementById('dealerTotal').textContent = `(${dealerTotal})`;
            } else {
                document.getElementById('dealerTotal').textContent = '';
            }
        }

        async function blackjackHit() {
            if (blackjackState.gameOver) return;
            
            const card = createCard();
            blackjackState.playerHand.push(card);
            
            const playerHand = document.getElementById('playerHand');
            playerHand.innerHTML += renderCard(card);
            
            updateBlackjackTotals();
            
            const playerTotal = calculateHand(blackjackState.playerHand);
            if (playerTotal > 21) {
                endBlackjack('bust');
            } else if (playerTotal === 21) {
                blackjackStand();
            }
        }

        async function blackjackStand() {
            if (blackjackState.gameOver) return;
            
            document.getElementById('hitBtn').disabled = true;
            document.getElementById('standBtn').disabled = true;
            
            // Reveal dealer card
            const dealerHand = document.getElementById('dealerHand');
            dealerHand.innerHTML = blackjackState.dealerHand.map(c => renderCard(c)).join('');
            
            // Dealer hits until 17+
            let dealerTotal = calculateHand(blackjackState.dealerHand);
            
            while (dealerTotal < 17) {
                await delay(600);
                const card = createCard();
                blackjackState.dealerHand.push(card);
                dealerHand.innerHTML += renderCard(card);
                dealerTotal = calculateHand(blackjackState.dealerHand);
            }
            
            // Determine winner
            const playerTotal = calculateHand(blackjackState.playerHand);
            
            if (dealerTotal > 21) {
                endBlackjack('dealer_bust');
            } else if (playerTotal > dealerTotal) {
                endBlackjack('win');
            } else if (playerTotal < dealerTotal) {
                endBlackjack('lose');
            } else {
                endBlackjack('push');
            }
        }

        async function endBlackjack(outcome) {
            blackjackState.gameOver = true;
            updateBlackjackTotals();
            
            const bet = blackjackState.bet;
            const playerTotal = calculateHand(blackjackState.playerHand);
            const dealerTotal = calculateHand(blackjackState.dealerHand);
            const result = document.getElementById('blackjackResult');
            
            let multiplier = 0;
            let resultText = '';
            
            switch (outcome) {
                case 'bust':
                    resultText = `BUST! (${playerTotal}) -$${formatNumber(bet)}`;
                    break;
                case 'dealer_bust':
                    multiplier = 2;
                    resultText = `Dealer BUST! (${dealerTotal}) +$${formatNumber(bet)}`;
                    break;
                case 'win':
                    multiplier = playerTotal === 21 && blackjackState.playerHand.length === 2 ? 2.5 : 2;
                    resultText = `WIN! (${playerTotal} vs ${dealerTotal}) +$${formatNumber(bet * (multiplier - 1))}`;
                    break;
                case 'lose':
                    resultText = `LOSE (${playerTotal} vs ${dealerTotal}) -$${formatNumber(bet)}`;
                    break;
                case 'push':
                    multiplier = 1;
                    resultText = `PUSH (${playerTotal}) - Bet returned`;
                    break;
            }
            
            const winnings = bet * multiplier;
            const profit = winnings - bet;
            
            result.innerHTML = `<span style="color: ${profit >= 0 ? 'var(--success)' : 'var(--danger)'};">${resultText}</span>`;
            
            // Reset buttons
            document.getElementById('blackjackDealBtn').disabled = false;
            document.getElementById('blackjackActions').style.display = 'none';
            document.getElementById('hitBtn').disabled = false;
            document.getElementById('standBtn').disabled = false;
            
            processGambleResult('blackjack', bet, winnings, profit, null, null);
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ============ CASINO - PROCESS RESULT ============
        async function processGambleResult(game, bet, winnings, profit, resultElId, btnId) {
            try {
                const won = profit > 0 ? winnings : 0;
                const lost = profit < 0 ? bet : 0;
                const resultStr = profit > 0 ? 'win' : (profit < 0 ? 'lose' : 'push');
                
                const response = await fetch(`${SHEETS_URL}?action=recordGambling&email=${encodeURIComponent(currentUser.email)}&game=${game}&wagered=${bet}&won=${won}&lost=${lost}&result=${resultStr}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser.balance = data.newBalance;
                    document.getElementById('balanceAmount').textContent = formatNumber(data.newBalance);
                }
                
                if (resultElId) {
                    const resultEl = document.getElementById(resultElId);
                    if (profit > 0) {
                        resultEl.innerHTML = `<span style="color: var(--success);">WIN! +$${formatNumber(profit)}</span>`;
                    } else if (profit < 0) {
                        resultEl.innerHTML = `<span style="color: var(--danger);">LOSE -$${formatNumber(bet)}</span>`;
                    } else {
                        resultEl.innerHTML = `<span style="color: var(--warning);">PUSH - Bet returned</span>`;
                    }
                }
            } catch (error) {
                console.error('Failed to record gambling');
            }
            
            if (btnId) {
                document.getElementById(btnId).disabled = false;
            }
        }

        // ============ CHAT ============
        const PROFANITY_LIST = ['fuck', 'shit', 'ass', 'bitch', 'damn', 'crap', 'dick', 'cock', 'pussy', 'cunt', 'bastard', 'whore', 'slut', 'fag', 'nigger', 'retard'];

        function filterProfanity(text) {
            let filtered = text;
            PROFANITY_LIST.forEach(word => {
                const regex = new RegExp(word, 'gi');
                filtered = filtered.replace(regex, '*'.repeat(word.length));
            });
            return filtered;
        }

        async function loadChat() {
            try {
                const response = await fetch(`${SHEETS_URL}?action=getChat`);
                const data = await response.json();
                
                if (data.success) {
                    renderChat(data.messages || []);
                }
            } catch (error) {
                showToast('Failed to load chat', 'error');
            }
        }

        function renderChat(messages) {
            const container = document.getElementById('chatMessages');
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No messages yet. Be the first!</p></div>';
                return;
            }
            
            container.innerHTML = messages.map(m => `
                <div class="chat-message">
                    <span class="chat-username">${m.name}</span>
                    <span class="chat-time">${formatDate(m.timestamp)}</span>
                    <div class="chat-text">${filterProfanity(m.message)}</div>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        async function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            if (message.length > 500) {
                showToast('Message too long (max 500 chars)', 'error');
                return;
            }
            
            const filtered = filterProfanity(message);
            
            try {
                const response = await fetch(`${SHEETS_URL}?action=sendChat&email=${encodeURIComponent(currentUser.email)}&name=${encodeURIComponent(currentUser.name)}&message=${encodeURIComponent(filtered)}`);
                const data = await response.json();
                
                if (data.success) {
                    input.value = '';
                    loadChat();
                } else {
                    showToast('Failed to send message', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        // ============ LEADERBOARDS ============
        async function loadLeaderboards() {
            try {
                // Wealth leaderboard
                const wealthRes = await fetch(`${SHEETS_URL}?action=getLeaderboard&type=wealth`);
                const wealthData = await wealthRes.json();
                if (wealthData.success) {
                    renderLeaderboard('wealthLeaderboard', wealthData.users || [], 'balance', '$');
                }
                
                // Credit score leaderboard
                const creditRes = await fetch(`${SHEETS_URL}?action=getLeaderboard&type=credit`);
                const creditData = await creditRes.json();
                if (creditData.success) {
                    renderLeaderboard('creditLeaderboard', creditData.users || [], 'creditScore', '');
                }
                
                // Emoji leaderboard
                const emojiRes = await fetch(`${SHEETS_URL}?action=getLeaderboard&type=emoji`);
                const emojiData = await emojiRes.json();
                if (emojiData.success) {
                    renderLeaderboard('emojiLeaderboard', emojiData.users || [], 'emojiScore', '', ' pts');
                }
            } catch (error) {
                showToast('Failed to load leaderboards', 'error');
            }
        }

        function renderLeaderboard(containerId, users, field, prefix = '', suffix = '') {
            const container = document.getElementById(containerId);
            
            if (users.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No data yet</p></div>';
                return;
            }
            
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            
            container.innerHTML = users.slice(0, 50).map((user, i) => {
                const isCurrentUser = user.email === currentUser.email;
                const medal = i < 3 ? medals[i] : `#${i + 1}`;
                
                return `
                    <div class="transaction-item" style="${isCurrentUser ? 'border: 2px solid var(--gold);' : ''}">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span style="font-size: 1.5rem; min-width: 40px;">${medal}</span>
                            <div>
                                <div style="font-weight: 600; ${isCurrentUser ? 'color: var(--gold);' : ''}">${user.name}</div>
                                <div style="color: var(--text-muted); font-size: 0.75rem;">${user.email}</div>
                            </div>
                        </div>
                        <div style="font-weight: 700; color: var(--gold);">
                            ${prefix}${formatNumber(user[field] || 0)}${suffix}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============ ADMIN ============
        async function loadAdmin() {
            if (currentUser.email !== MASTER_ADMIN) {
                showToast('Access denied', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${SHEETS_URL}?action=getAllUsers`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('userCount').textContent = (data.users || []).length + ' users';
                    renderAdminUsers(data.users || []);
                }
            } catch (error) {
                showToast('Failed to load users', 'error');
            }
        }

        function renderAdminUsers(users) {
            const container = document.getElementById('adminUsersList');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No users</p></div>';
                return;
            }
            
            container.innerHTML = users.map(u => `
                <div class="transaction-item">
                    <div>
                        <div style="font-weight: 600;">${u.name}</div>
                        <div style="color: var(--text-muted); font-size: 0.75rem;">${u.email}</div>
                        <div style="font-size: 0.75rem;">Credit: ${u.creditScore || 650} | Joined: ${formatDate(u.createdAt)}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 700; color: var(--gold);">$${formatNumber(u.balance || 0)}</div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button class="btn btn-sm btn-success" onclick="adminAddMoney('${u.email}')">+$</button>
                            <button class="btn btn-sm btn-danger" onclick="adminRemoveMoney('${u.email}')">-$</button>
                            <button class="btn btn-sm" onclick="adminResetUser('${u.email}')">Reset</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function adminAddMoney(email) {
            const amount = prompt('Amount to add:');
            if (!amount || isNaN(amount) || amount <= 0) return;
            
            try {
                const response = await fetch(`${SHEETS_URL}?action=adminAdjustBalance&email=${encodeURIComponent(email)}&amount=${amount}&adminEmail=${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                
                if (data.success) {
                    showToast('Money added!', 'success');
                    loadAdmin();
                } else {
                    showToast(data.message || 'Failed', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        async function adminRemoveMoney(email) {
            const amount = prompt('Amount to remove:');
            if (!amount || isNaN(amount) || amount <= 0) return;
            
            try {
                const response = await fetch(`${SHEETS_URL}?action=adminAdjustBalance&email=${encodeURIComponent(email)}&amount=${-amount}&adminEmail=${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                
                if (data.success) {
                    showToast('Money removed!', 'success');
                    loadAdmin();
                } else {
                    showToast(data.message || 'Failed', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        async function adminResetUser(email) {
            if (!confirm(`Reset ${email}? This will delete all their data.`)) return;
            
            try {
                const response = await fetch(`${SHEETS_URL}?action=adminResetUser&email=${encodeURIComponent(email)}&adminEmail=${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                
                if (data.success) {
                    showToast('User reset!', 'success');
                    loadAdmin();
                } else {
                    showToast(data.message || 'Failed', 'error');
                }
            } catch (error) {
                showToast('Connection error', 'error');
            }
        }

        // ============ HELPER FUNCTIONS ============
        function formatNumber(num) {
            if (num === undefined || num === null) return '0';
            return parseFloat(num).toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateStr;
            }
        }

        // ============ AUTO-REFRESH ============
        setInterval(() => {
            if (currentUser && !document.hidden) {
                // Refresh balance periodically
                fetch(`${SHEETS_URL}?action=getBalance&email=${encodeURIComponent(currentUser.email)}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.success && data.balance !== undefined) {
                            currentUser.balance = data.balance;
                            document.getElementById('balanceAmount').textContent = formatNumber(data.balance);
                        }
                    })
                    .catch(() => {});
            }
        }, 30000);

        // Chat auto-refresh when on chat tab
        setInterval(() => {
            if (currentUser && !document.hidden && !document.getElementById('chatContent').classList.contains('hidden')) {
                loadChat();
            }
        }, 5000);
    </script>
</body>
</html>
