<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lintoria Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a25;
            --bg-hover: #252535;
            --gold: #fbbf24;
            --gold-dark: #d97706;
            --gold-glow: rgba(251, 191, 36, 0.3);
            --purple: #8b5cf6;
            --purple-glow: rgba(139, 92, 246, 0.3);
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #2a2a3a;
            --gradient-gold: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            --gradient-purple: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .particles {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        
        .particle {
            position: absolute;
            width: 4px; height: 4px;
            background: var(--gold);
            border-radius: 50%;
            opacity: 0.3;
            animation: float 15s infinite ease-in-out;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }
        
        .app-container {
            position: relative;
            z-index: 1;
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--bg-secondary);
            box-shadow: 0 0 100px rgba(0, 0, 0, 0.5);
        }
        
        .auth-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: radial-gradient(ellipse at top, rgba(251, 191, 36, 0.1) 0%, transparent 50%);
        }
        
        .auth-logo {
            font-size: 3rem;
            font-weight: 900;
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 60px var(--gold-glow);
        }
        
        .auth-subtitle {
            color: var(--text-muted);
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }
        
        .auth-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2rem;
            width: 100%;
            max-width: 360px;
            border: 1px solid var(--border);
        }
        
        .auth-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .auth-tab.active {
            background: var(--gradient-gold);
            color: #000;
        }
        
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        
        .form-group { margin-bottom: 1rem; }
        
        .form-label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 20px var(--gold-glow);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--gradient-gold);
            color: #000;
            width: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--gold-glow);
        }
        
        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-success { background: var(--success); color: #fff; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.8rem; }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .main-app { display: none; }
        .main-app.active { display: block; }
        
        .header {
            padding: 1rem 1.25rem;
            background: linear-gradient(180deg, var(--bg-card) 0%, transparent 100%);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .brand {
            font-size: 1.5rem;
            font-weight: 800;
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-actions { display: flex; gap: 0.5rem; }
        
        .icon-btn {
            width: 40px; height: 40px;
            border-radius: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.3s;
        }
        
        .icon-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }
        
        .balance-card {
            background: var(--gradient-gold);
            border-radius: 16px;
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
        }
        
        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%; right: -50%;
            width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
        }
        
        .balance-label {
            font-size: 0.75rem;
            color: rgba(0,0,0,0.6);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .balance-amount {
            font-size: 2rem;
            font-weight: 800;
            color: #000;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .balance-amount::before { content: '$'; font-size: 1.25rem; }
        
        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            background: var(--bg-secondary);
            position: sticky;
            top: 120px;
            z-index: 99;
        }
        
        .nav-tabs::-webkit-scrollbar { display: none; }
        
        .nav-tab {
            padding: 0.6rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 10px;
            white-space: nowrap;
            transition: all 0.3s;
        }
        
        .nav-tab.active {
            background: var(--bg-card);
            color: var(--gold);
        }
        
        .tab-content { display: none; padding: 1rem; }
        .tab-content.active { display: block; }
        
        .section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        
        .stat-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gold);
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .packs-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        
        .pack-card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .pack-card:hover { transform: translateY(-4px); }
        .pack-card.selected { border-color: var(--gold); box-shadow: 0 0 30px var(--gold-glow); }
        
        .pack-emojis { font-size: 2rem; margin-bottom: 0.5rem; }
        .pack-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem; }
        .pack-price { color: var(--gold); font-weight: 700; }
        
        .rarity-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .rarity-common { background: #6b7280; color: #fff; }
        .rarity-uncommon { background: #22c55e; color: #fff; }
        .rarity-rare { background: #3b82f6; color: #fff; }
        .rarity-epic { background: #8b5cf6; color: #fff; }
        .rarity-legendary { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
        .rarity-mythic { background: linear-gradient(135deg, #ec4899, #8b5cf6); color: #fff; }
        .rarity-divine { background: linear-gradient(135deg, #fbbf24, #fff, #fbbf24); color: #000; animation: divine-glow 2s infinite; }
        
        @keyframes divine-glow {
            0%, 100% { box-shadow: 0 0 20px #fbbf24; }
            50% { box-shadow: 0 0 40px #fbbf24, 0 0 60px #fff; }
        }
        
        .collection-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
        
        .emoji-item {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 0.5rem;
            text-align: center;
            position: relative;
        }
        
        .emoji-icon { font-size: 1.5rem; }
        .emoji-count {
            position: absolute;
            top: 2px; right: 4px;
            font-size: 0.6rem;
            background: var(--bg-card);
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .stock-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 3px solid var(--success);
        }
        
        .stock-card.down { border-left-color: var(--danger); }
        
        .stock-symbol { font-weight: 800; font-size: 1.1rem; color: var(--gold); }
        .stock-name { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .stock-price { font-size: 1.25rem; font-weight: 700; }
        .stock-change { font-size: 0.8rem; font-weight: 600; }
        .stock-change.up { color: var(--success); }
        .stock-change.down { color: var(--danger); }
        
        .stock-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            align-items: center;
        }
        
        .stock-actions input { flex: 1; padding: 0.5rem; }
        
        .stock-impact {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
            font-style: italic;
        }
        
        .market-sentiment {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-primary);
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        
        .sentiment-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .sentiment-bullish { background: var(--success); }
        .sentiment-bearish { background: var(--danger); }
        .sentiment-neutral { background: var(--warning); }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        
        .holding-card {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .chart-container {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .timeframe-btns {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 0.75rem;
        }
        
        .timeframe-btn {
            padding: 0.4rem 0.75rem;
            border: none;
            background: var(--bg-card);
            color: var(--text-muted);
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
        }
        
        .timeframe-btn.active { background: var(--gold); color: #000; }
        
        .game-section {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }
        
        .game-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .bet-input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .bet-input-group input { flex: 1; }
        
        .plinko-container { display: flex; flex-direction: column; align-items: center; }
        
        .plinko-board {
            width: 100%;
            max-width: 340px;
            height: 380px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .plinko-peg {
            position: absolute;
            width: 10px; height: 10px;
            background: var(--gold);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--gold-glow);
        }
        
        .plinko-ball {
            position: absolute;
            width: 18px; height: 18px;
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        
        .plinko-ball.ball-gold { background: radial-gradient(circle at 30% 30%, #fde047, #ca8a04); }
        .plinko-ball.ball-purple { background: radial-gradient(circle at 30% 30%, #c084fc, #7c3aed); }
        .plinko-ball.ball-blue { background: radial-gradient(circle at 30% 30%, #60a5fa, #2563eb); }
        .plinko-ball.ball-green { background: radial-gradient(circle at 30% 30%, #4ade80, #16a34a); }
        .plinko-ball.ball-red { background: radial-gradient(circle at 30% 30%, #f87171, #dc2626); }
        
        .plinko-slots {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            display: flex;
            height: 40px;
        }
        
        .plinko-slot {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 700;
            color: #fff;
            background: linear-gradient(180deg, #374151 0%, #1f2937 100%);
            border-left: 1px solid #4b5563;
        }
        
        .plinko-slot:first-child { border-left: none; border-radius: 0 0 0 12px; }
        .plinko-slot:last-child { border-radius: 0 0 12px 0; }
        .plinko-slot.active { background: var(--gold); color: #000; }
        
        .plinko-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            font-size: 0.85rem;
        }
        
        .roulette-container { text-align: center; }
        
        .roulette-wheel-container {
            position: relative;
            width: 200px; height: 200px;
            margin: 0 auto 1rem;
        }
        
        .roulette-wheel {
            width: 100%; height: 100%;
            border-radius: 50%;
            position: relative;
            transition: transform 5s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            overflow: hidden;
            border: 4px solid var(--gold);
        }
        
        .roulette-pointer {
            position: absolute;
            top: -10px; left: 50%;
            transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 20px solid var(--gold);
            z-index: 10;
        }
        
        .roulette-bets {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 1rem;
        }
        
        .roulette-bet-btn {
            padding: 0.75rem 1.25rem;
            border: 2px solid transparent;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .roulette-bet-btn.selected { border-color: var(--gold); transform: scale(1.05); }
        
        #betRed { background: #dc2626; color: #fff; }
        #betBlack { background: #1f2937; color: #fff; }
        #betGreen { background: #16a34a; color: #fff; }
        
        .slots-container { text-align: center; }
        
        .slots-display {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .slot-reel {
            width: 70px; height: 80px;
            background: var(--bg-card);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border);
        }
        
        .slot-reel.spinning { animation: slotSpin 0.2s infinite; }
        
        @keyframes slotSpin {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .slot-symbol { font-size: 2.5rem; }
        
        .coin-container { text-align: center; }
        
        .coin {
            width: 120px; height: 120px;
            margin: 0 auto 1rem;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1.5s ease-out;
        }
        
        .coin.flipping { animation: coinFlip 1.5s ease-out; }
        
        @keyframes coinFlip {
            0% { transform: rotateY(0); }
            100% { transform: rotateY(1800deg); }
        }
        
        .coin-side {
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: 800;
            backface-visibility: hidden;
        }
        
        .coin-heads { background: var(--gradient-gold); color: #000; }
        .coin-tails { background: linear-gradient(135deg, #6b7280 0%, #374151 100%); color: #fff; transform: rotateY(180deg); }
        
        .coin-btns { display: flex; gap: 0.5rem; justify-content: center; }
        
        .dice-container { text-align: center; }
        
        .dice {
            width: 80px; height: 80px;
            margin: 0 auto 1rem;
            perspective: 200px;
        }
        
        .dice-cube {
            width: 100%; height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1s ease-out;
        }
        
        .dice.rolling .dice-cube { animation: diceRoll 1s ease-out; }
        
        @keyframes diceRoll {
            0% { transform: rotateX(0) rotateY(0); }
            100% { transform: rotateX(720deg) rotateY(720deg); }
        }
        
        .dice-face {
            position: absolute;
            width: 80px; height: 80px;
            background: #fff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        
        .dice-face.front { transform: translateZ(40px); }
        
        .crash-container { text-align: center; }
        
        .crash-display {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1rem;
        }
        
        .crash-multiplier {
            font-size: 3rem;
            font-weight: 900;
            color: var(--success);
            transition: color 0.3s;
        }
        
        .crash-multiplier.crashed { color: var(--danger); animation: shake 0.5s; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .crash-status { color: var(--text-muted); margin-top: 0.5rem; }
        
        .crash-btns { display: flex; gap: 0.5rem; }
        .crash-btns .btn { flex: 1; }
        
        .bj-container { text-align: center; }
        
        .bj-hand {
            min-height: 100px;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-card);
            border-radius: 12px;
        }
        
        .bj-hand-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        
        .bj-cards { display: flex; justify-content: center; gap: 0.25rem; flex-wrap: wrap; }
        
        .bj-card {
            width: 50px; height: 70px;
            background: #fff;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .bj-card.red { color: #dc2626; }
        .bj-card.black { color: #1f2937; }
        .bj-card.hidden { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        
        .bj-score { font-weight: 700; color: var(--gold); margin-top: 0.5rem; }
        
        .bj-controls { display: none; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        
        .cheat-container { text-align: center; }
        
        .cheat-status {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .cheat-lobby {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .cheat-lobby-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--gold);
        }
        
        .cheat-player-list {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        
        .cheat-player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: var(--bg-primary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        
        .cheat-player-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .cheat-player-host {
            font-size: 0.65rem;
            background: var(--gold);
            color: #000;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
        }
        
        .cheat-player-vote { font-size: 0.75rem; color: var(--text-muted); }
        .cheat-player-vote.voted { color: var(--success); }
        
        .cheat-vote-section {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .cheat-vote-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .cheat-vote-btns {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .cheat-vote-btn {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .cheat-vote-btn:hover { border-color: var(--gold); }
        .cheat-vote-btn.selected { background: var(--gold); color: #000; border-color: var(--gold); }
        .cheat-vote-btn.locked { opacity: 0.5; cursor: not-allowed; }
        
        .cheat-waiting {
            padding: 1rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .cheat-waiting-dots::after { content: ''; animation: dots 1.5s infinite; }
        
        @keyframes dots {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        
        .cheat-cards-container { display: none; margin-bottom: 1rem; }
        .cheat-cards-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        
        .cheat-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            justify-content: center;
            padding: 0.5rem;
            background: var(--bg-card);
            border-radius: 12px;
            min-height: 80px;
        }
        
        .cheat-card {
            width: 45px;
            height: 65px;
            background: #fff;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .cheat-card:hover { transform: translateY(-4px); }
        .cheat-card.selected { border-color: var(--gold); box-shadow: 0 0 15px var(--gold-glow); transform: translateY(-6px); }
        .cheat-card.red { color: #dc2626; }
        .cheat-card.black { color: #1f2937; }
        
        .cheat-pile-area {
            display: none;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .cheat-pile-count { font-size: 2rem; font-weight: 800; color: var(--gold); }
        .cheat-pile-label { font-size: 0.75rem; color: var(--text-muted); }
        .cheat-current-claim { margin-top: 0.5rem; font-size: 0.9rem; color: var(--purple); }
        
        .cheat-last-play {
            display: none;
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }
        
        .cheat-game-controls { display: none; }
        
        .cheat-claim-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            align-items: center;
            justify-content: center;
        }
        
        .cheat-claim-row select, .cheat-claim-row input {
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .cheat-claim-row select { width: 80px; }
        .cheat-claim-row input { width: 60px; text-align: center; }
        
        .cheat-action-btns { display: flex; gap: 0.5rem; }
        .cheat-action-btns .btn { flex: 1; }
        
        .cheat-lobby-controls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .cheat-join-section {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .cheat-join-section input { flex: 1; }
        
        .chat-container {
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: var(--bg-primary);
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        
        .chat-message { margin-bottom: 0.75rem; }
        .chat-username { font-weight: 700; color: var(--gold); margin-right: 0.5rem; }
        .chat-time { font-size: 0.65rem; color: var(--text-muted); }
        .chat-text { margin-top: 0.25rem; color: var(--text-secondary); }
        
        .chat-input-row { display: flex; gap: 0.5rem; }
        .chat-input-row input { flex: 1; }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--bg-primary);
            border-radius: 10px;
            margin-bottom: 0.5rem;
        }
        
        .lb-rank {
            width: 30px; height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.85rem;
        }
        
        .lb-rank-1 { background: var(--gradient-gold); color: #000; }
        .lb-rank-2 { background: linear-gradient(135deg, #9ca3af, #6b7280); color: #fff; }
        .lb-rank-3 { background: linear-gradient(135deg, #d97706, #92400e); color: #fff; }
        
        .lb-info { flex: 1; }
        .lb-name { font-weight: 600; }
        .lb-value { color: var(--gold); font-weight: 700; }
        
        .admin-section { background: var(--bg-card); border-radius: 16px; padding: 1.25rem; }
        
        .user-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-primary);
            border-radius: 10px;
            margin-bottom: 0.5rem;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .modal-title { font-size: 1.25rem; font-weight: 700; }
        
        .modal-close {
            width: 32px; height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.25rem;
        }
        
        .pack-opening-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            flex-direction: column;
        }
        
        .pack-opening-overlay.active { display: flex; }
        
        .pack-reveal {
            text-align: center;
            animation: packReveal 0.5s ease-out;
        }
        
        @keyframes packReveal {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }
        
        .pack-reveal-emoji { font-size: 6rem; margin-bottom: 1rem; }
        .pack-reveal-rarity { font-size: 1.5rem; font-weight: 800; margin-bottom: 1rem; }
        
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
        }
        
        .toast {
            padding: 0.875rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            animation: toastIn 0.3s ease-out;
            pointer-events: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        @keyframes toastIn {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        .toast-success { background: var(--success); color: #fff; }
        .toast-error { background: var(--danger); color: #fff; }
        .toast-info { background: var(--purple); color: #fff; }
        .toast-warning { background: var(--warning); color: #000; }
        
        .confetti-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 1002;
            overflow: hidden;
        }
        
        .confetti {
            position: absolute;
            width: 10px; height: 10px;
            animation: confettiFall 3s ease-out forwards;
        }
        
        @keyframes confettiFall {
            0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        
        .loan-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 3px solid var(--purple);
        }
        
        .loan-amount { font-size: 1.25rem; font-weight: 700; color: var(--gold); }
        .loan-details { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }
        
        .credit-score {
            text-align: center;
            padding: 1rem;
            background: var(--bg-primary);
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        
        .credit-score-value { font-size: 2.5rem; font-weight: 800; }
        .credit-score-label { font-size: 0.75rem; color: var(--text-muted); }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        
        .empty-icon { font-size: 3rem; margin-bottom: 0.5rem; opacity: 0.5; }
        
        @media (max-width: 400px) {
            .packs-grid { grid-template-columns: 1fr 1fr; }
            .collection-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>
    
    <div class="app-container">
        <!-- Auth Screen -->
        <div class="auth-screen" id="authScreen">
            <div class="auth-logo">LINTORIA</div>
            <div class="auth-subtitle">Premium Gaming Hub</div>
            
            <div class="auth-card">
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                    <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
                </div>
                
                <div class="auth-form active" id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <button class="btn btn-primary" onclick="login()">Sign In</button>
                </div>
                
                <div class="auth-form" id="registerForm">
                    <div class="form-group">
                        <label class="form-label">Display Name</label>
                        <input type="text" class="form-input" id="registerName" placeholder="Choose a display name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="registerEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="registerPassword" placeholder="Create a password">
                    </div>
                    <button class="btn btn-primary" onclick="register()">Create Account</button>
                </div>
            </div>
        </div>
        
        <!-- Main App -->
        <div class="main-app" id="mainApp">
            <div class="header">
                <div class="header-top">
                    <div class="brand">LINTORIA</div>
                    <div class="header-actions">
                        <button class="icon-btn" onclick="showSettingsModal()">‚öôÔ∏è</button>
                        <button class="icon-btn" onclick="logout()">üö™</button>
                    </div>
                </div>
                <div class="balance-card">
                    <div class="balance-label">Total Balance</div>
                    <div class="balance-amount" id="balanceAmount">0</div>
                </div>
            </div>
            
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('dashboard')">üè† Home</button>
                <button class="nav-tab" onclick="switchTab('stocks')">üìà Stocks</button>
                <button class="nav-tab" onclick="switchTab('casino')">üé∞ Casino</button>
                <button class="nav-tab" onclick="switchTab('packs')">üéÅ Packs</button>
                <button class="nav-tab" onclick="switchTab('loans')">üè¶ Loans</button>
                <button class="nav-tab" onclick="switchTab('chat')">üí¨ Chat</button>
                <button class="nav-tab" onclick="switchTab('leaderboard')">üèÜ Leaders</button>
                <button class="nav-tab" id="adminTab" style="display: none;" onclick="switchTab('admin')">üëë Admin</button>
            </div>
            
            <!-- Dashboard Tab -->
            <div class="tab-content active" id="tab-dashboard">
                <div class="section">
                    <div class="section-title">üìä Dashboard</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statBalance">$0</div>
                            <div class="stat-label">Balance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statCredit">650</div>
                            <div class="stat-label">Credit Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statEmoji">0</div>
                            <div class="stat-label">Emoji Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statTx">0</div>
                            <div class="stat-label">Transactions</div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">üí∏ Send Money</div>
                    <div class="form-group">
                        <label class="form-label">Recipient Email</label>
                        <input type="email" class="form-input" id="transferEmail" placeholder="Enter recipient email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" class="form-input" id="transferAmount" placeholder="Enter amount">
                    </div>
                    <button class="btn btn-primary" onclick="sendMoney()">Send Money</button>
                </div>
                
                <div class="section">
                    <div class="section-title">üìú Recent Transactions</div>
                    <div id="transactionsList">
                        <div class="empty-state">
                            <div class="empty-icon">üìÑ</div>
                            <p>No transactions yet</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Stocks Tab -->
            <div class="tab-content" id="tab-stocks">
                <div class="section">
                    <div class="section-title">üìà Stock Market</div>
                    
                    <!-- Market Sentiment -->
                    <div class="market-sentiment" id="marketSentiment">
                        <div class="sentiment-indicator sentiment-neutral" id="sentimentIndicator"></div>
                        <div>
                            <div style="font-weight: 600;" id="sentimentText">üìä Market Neutral</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);" id="sentimentDesc">Prices are stable</div>
                        </div>
                    </div>
                    
                    <!-- Portfolio Summary -->
                    <div class="holding-card" style="background: var(--bg-card); margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Portfolio Value</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--gold);" id="portfolioValue">$0.00</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.75rem; color: var(--text-muted);">Total P/L</div>
                                <div style="font-size: 1rem; font-weight: 600;" id="portfolioPL">$0.00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="stocksList"></div>
                </div>
                
                <div class="section">
                    <div class="section-title">üíº Your Holdings</div>
                    <div id="holdingsList">
                        <div class="empty-state">
                            <div class="empty-icon">üìä</div>
                            <p>No holdings yet</p>
                        </div>
                    </div>
                </div>
                
                <div class="section" id="adminStockSection" style="display: none;">
                    <div class="section-title">üîß Admin: Create Stock</div>
                    <div class="form-group">
                        <input type="text" class="form-input" id="newStockSymbol" placeholder="Symbol (e.g., COIN)">
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-input" id="newStockName" placeholder="Company Name">
                    </div>
                    <div class="form-group">
                        <input type="number" class="form-input" id="newStockPrice" placeholder="Initial Price">
                    </div>
                    <button class="btn btn-primary" onclick="createNewStock()">Create Stock</button>
                </div>
            </div>
            
            <!-- Casino Tab -->
            <div class="tab-content" id="tab-casino">
                <!-- Plinko -->
                <div class="game-section">
                    <div class="game-title">üéØ Plinko</div>
                    <div class="plinko-container">
                        <div class="plinko-board" id="plinkoBoard"></div>
                        <div class="bet-input-group">
                            <input type="number" class="form-input" id="plinkoBet" value="100" min="10" placeholder="Bet amount">
                            <input type="number" class="form-input" id="plinkoBalls" value="1" min="1" max="10" style="width: 80px;" placeholder="Balls">
                        </div>
                        <button class="btn btn-primary" onclick="dropPlinkoBall()" id="plinkoDropBtn">Drop Ball</button>
                        <div class="plinko-stats" style="margin-top: 1rem;">
                            <div>Last Win: <span id="plinkoLastWin" style="color: var(--gold);">$0</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Roulette -->
                <div class="game-section">
                    <div class="game-title">üé° Roulette</div>
                    <div class="roulette-container">
                        <div class="roulette-wheel-container">
                            <div class="roulette-pointer"></div>
                            <div class="roulette-wheel" id="rouletteWheel"></div>
                        </div>
                        <div class="roulette-bets">
                            <button class="roulette-bet-btn" id="betRed" onclick="selectRouletteBet('red')">Red</button>
                            <button class="roulette-bet-btn" id="betBlack" onclick="selectRouletteBet('black')">Black</button>
                            <button class="roulette-bet-btn" id="betGreen" onclick="selectRouletteBet('green')">0</button>
                        </div>
                        <div class="bet-input-group">
                            <input type="number" class="form-input" id="rouletteBet" value="100" min="10" placeholder="Bet amount">
                            <button class="btn btn-primary" onclick="spinRoulette()">Spin</button>
                        </div>
                        <div id="rouletteResult" style="margin-top: 0.5rem; font-weight: 600;"></div>
                    </div>
                </div>
                
                <!-- Slots -->
                <div class="game-section">
                    <div class="game-title">üé∞ Slots</div>
                    <div class="slots-container">
                        <div class="slots-display">
                            <div class="slot-reel" id="slot1"><span class="slot-symbol">üçí</span></div>
                            <div class="slot-reel" id="slot2"><span class="slot-symbol">üçã</span></div>
                            <div class="slot-reel" id="slot3"><span class="slot-symbol">üçá</span></div>
                        </div>
                        <div class="bet-input-group">
                            <input type="number" class="form-input" id="slotsBet" value="100" min="10" placeholder="Bet amount">
                            <button class="btn btn-primary" onclick="spinSlots()">Spin</button>
                        </div>
                        <div id="slotsResult" style="margin-top: 0.5rem; font-weight: 600;"></div>
                    </div>
                </div>
                
                <!-- Coin Flip -->
                <div class="game-section">
                    <div class="game-title">ü™ô Coin Flip</div>
                    <div class="coin-container">
                        <div class="coin" id="coin">
                            <div class="coin-side coin-heads">H</div>
                            <div class="coin-side coin-tails">T</div>
                        </div>
                        <div class="bet-input-group">
                            <input type="number" class="form-input" id="coinBet" value="100" min="10" placeholder="Bet amount">
                        </div>
                        <div class="coin-btns">
                            <button class="btn btn-secondary" onclick="flipCoin('heads')">Heads</button>
                            <button class="btn btn-secondary" onclick="flipCoin('tails')">Tails</button>
                        </div>
                        <div id="coinResult" style="margin-top: 0.5rem; font-weight: 600;"></div>
                    </div>
                </div>
                
                <!-- Dice -->
                <div class="game-section">
                    <div class="game-title">üé≤ Dice (Roll 4+ to Win)</div>
                    <div class="dice-container">
                        <div class="dice" id="dice">
                            <div class="dice-cube">
                                <div class="dice-face front" id="diceFace">‚öÄ</div>
                            </div>
                        </div>
                        <div class="bet-input-group">
                            <input type="number" class="form-input" id="diceBet" value="100" min="10" placeholder="Bet amount">
                            <button class="btn btn-primary" onclick="rollDice()">Roll</button>
                        </div>
                        <div id="diceResult" style="margin-top: 0.5rem; font-weight: 600;"></div>
                    </div>
                </div>
                
                <!-- Crash -->
                <div class="game-section">
                    <div class="game-title">üìà Crash</div>
                    <div class="crash-container">
                        <div class="crash-display">
                            <div class="crash-multiplier" id="crashMultiplier">1.00x</div>
                            <div class="crash-status" id="crashStatus">Place your bet to start</div>
                        </div>
                        <div class="bet-input-group">
                            <input type="number" class="form-input" id="crashBet" value="100" min="10" placeholder="Bet amount">
                        </div>
                        <div class="crash-btns">
                            <button class="btn btn-primary" onclick="startCrash()" id="crashStartBtn">Start</button>
                            <button class="btn btn-success" onclick="cashoutCrash()" id="crashCashoutBtn" disabled>Cash Out</button>
                        </div>
                    </div>
                </div>
                
                <!-- Blackjack -->
                <div class="game-section">
                    <div class="game-title">üÉè Blackjack</div>
                    <div class="bj-container">
                        <div class="bj-hand">
                            <div class="bj-hand-label">Dealer's Hand</div>
                            <div class="bj-cards" id="dealerCards"></div>
                            <div class="bj-score" id="dealerScore"></div>
                        </div>
                        <div class="bj-hand">
                            <div class="bj-hand-label">Your Hand</div>
                            <div class="bj-cards" id="playerCards"></div>
                            <div class="bj-score" id="playerScore"></div>
                        </div>
                        <div class="bet-input-group" id="bjBetGroup">
                            <input type="number" class="form-input" id="bjBet" value="100" min="10" placeholder="Bet amount">
                            <button class="btn btn-primary" onclick="startBlackjack()">Deal</button>
                        </div>
                        <div class="bj-controls" id="bjControls">
                            <button class="btn btn-secondary" onclick="bjHit()">Hit</button>
                            <button class="btn btn-secondary" onclick="bjStand()">Stand</button>
                            <button class="btn btn-secondary" onclick="bjDouble()">Double</button>
                        </div>
                        <div id="bjResult" style="margin-top: 0.5rem; font-weight: 600;"></div>
                    </div>
                </div>
                
                <!-- Cheat Card Game -->
                <div class="game-section">
                    <div class="game-title">üé¥ Cheat (Multiplayer)</div>
                    <div class="cheat-container">
                        <div class="cheat-status" id="cheatStatus">
                            <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">üé¥ Cheat Lobby</div>
                            <div id="cheatStatusText" style="color: var(--text-muted);">Create or join a game</div>
                        </div>
                        
                        <!-- Lobby Controls -->
                        <div class="cheat-lobby-controls" id="cheatLobbyControls">
                            <div class="form-group">
                                <label class="form-label">Buy-In Amount (min $100)</label>
                                <input type="number" class="form-input" id="cheatBuyInAmount" value="100" min="100" placeholder="Buy-in amount">
                            </div>
                            <button class="btn btn-primary" onclick="createCheatLobby()">Create Lobby</button>
                            <button class="btn btn-secondary" onclick="joinCheatLobby()">Join Existing Lobby</button>
                        </div>
                        
                        <!-- Lobby Area -->
                        <div class="cheat-lobby" id="cheatLobbyArea" style="display: none;">
                            <div class="cheat-lobby-title">
                                üéÆ Lobby <span id="cheatLobbyId" style="font-size: 0.75rem; color: var(--text-muted);"></span>
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <span style="color: var(--text-muted);">Minimum Buy-In:</span>
                                <span style="color: var(--gold); font-weight: 700;" id="cheatLobbyBuyIn">$100</span>
                            </div>
                            
                            <div class="cheat-player-list" id="cheatPlayerList"></div>
                            
                            <div class="cheat-vote-section" id="cheatVoteSection">
                                <div class="cheat-vote-label">Vote for number of bots (1-5):</div>
                                <div class="cheat-vote-btns">
                                    <button class="cheat-vote-btn" onclick="voteForBots(1)">1</button>
                                    <button class="cheat-vote-btn" onclick="voteForBots(2)">2</button>
                                    <button class="cheat-vote-btn" onclick="voteForBots(3)">3</button>
                                    <button class="cheat-vote-btn" onclick="voteForBots(4)">4</button>
                                    <button class="cheat-vote-btn" onclick="voteForBots(5)">5</button>
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">
                                    Votes: <span id="cheatVoteCount">0</span>/<span id="cheatVoteTotal">0</span>
                                </div>
                            </div>
                            
                            <div class="cheat-waiting" id="cheatWaiting" style="display: none;">
                                <span class="cheat-waiting-dots">Waiting for all players to vote</span>
                            </div>
                            
                            <button class="btn btn-danger btn-sm" onclick="leaveLobby()" style="margin-top: 0.5rem;">Leave Lobby</button>
                        </div>
                        
                        <!-- Cards Container -->
                        <div class="cheat-cards-container" id="cheatCardsContainer">
                            <div class="cheat-cards-label">Your Cards (<span id="cheatCardCount">0</span>) - Selected: <span id="cheatSelectedCount">0</span></div>
                            <div class="cheat-cards" id="cheatCards"></div>
                        </div>
                        
                        <!-- Pile Area -->
                        <div class="cheat-pile-area" id="cheatPileArea">
                            <div class="cheat-pile-count" id="cheatPileCount">0</div>
                            <div class="cheat-pile-label">Cards in Pile</div>
                            <div class="cheat-current-claim">Current Claim: <span id="cheatCurrentClaim">-</span></div>
                        </div>
                        
                        <!-- Last Play Info -->
                        <div class="cheat-last-play" id="cheatLastPlayInfo">
                            <div id="cheatLastPlayDetails"></div>
                        </div>
                        
                        <!-- Game Controls -->
                        <div class="cheat-game-controls" id="cheatGameControls">
                            <div class="cheat-claim-row">
                                <label style="font-size: 0.8rem;">Claim:</label>
                                <select id="cheatClaimRank">
                                    <option value="A">A</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="J">J</option>
                                    <option value="Q">Q</option>
                                    <option value="K">K</option>
                                </select>
                                <label style="font-size: 0.8rem;">√ó</label>
                                <input type="number" id="cheatClaimCount" value="1" min="1" max="4">
                            </div>
                            <div class="cheat-action-btns">
                                <button class="btn btn-primary" onclick="cheatPlayCards()">Play Cards</button>
                                <button class="btn btn-danger" onclick="cheatCallBluff()">Call Bluff!</button>
                            </div>
                        </div>
                        
                        <div id="cheatResult" style="margin-top: 0.75rem; font-weight: 600; text-align: center;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Packs Tab -->
            <div class="tab-content" id="tab-packs">
                <div class="section">
                    <div class="section-title">üéÅ Emoji Packs - $7,500 each</div>
                    <div class="packs-grid" id="packsList"></div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="buySelectedPack()" id="buyPackBtn" disabled>Select a Pack</button>
                </div>
                
                <div class="section">
                    <div class="section-title">‚ú® Your Collection</div>
                    <div class="collection-grid" id="collectionGrid">
                        <div class="empty-state" style="grid-column: 1/-1;">
                            <div class="empty-icon">üé®</div>
                            <p>No emojis yet</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Loans Tab -->
            <div class="tab-content" id="tab-loans">
                <div class="section">
                    <div class="credit-score">
                        <div class="credit-score-value" id="creditScoreDisplay">650</div>
                        <div class="credit-score-label">Credit Score</div>
                    </div>
                    
                    <div class="section-title">üè¶ Take a Loan</div>
                    <div class="form-group">
                        <label class="form-label">Loan Amount</label>
                        <input type="number" class="form-input" id="loanAmount" placeholder="Enter amount" min="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Term (Days)</label>
                        <select class="form-input" id="loanTerm">
                            <option value="7">7 Days (5% Interest)</option>
                            <option value="14" selected>14 Days (10% Interest)</option>
                            <option value="30">30 Days (20% Interest)</option>
                        </select>
                    </div>
                    <div id="loanPreview" style="padding: 0.75rem; background: var(--bg-primary); border-radius: 10px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-muted);">Interest Rate:</span>
                            <span id="loanInterestRate">10%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-muted);">Total to Repay:</span>
                            <span style="color: var(--gold); font-weight: 700;" id="loanTotalRepay">$0</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="takeLoan()">Request Loan</button>
                </div>
                
                <div class="section">
                    <div class="section-title">üìã Active Loans</div>
                    <div id="loansList">
                        <div class="empty-state">
                            <div class="empty-icon">üí∞</div>
                            <p>No active loans</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Tab -->
            <div class="tab-content" id="tab-chat">
                <div class="section">
                    <div class="section-title">üí¨ Global Chat</div>
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="empty-state">
                                <div class="empty-icon">üí¨</div>
                                <p>No messages yet</p>
                            </div>
                        </div>
                        <div class="chat-input-row">
                            <input type="text" class="form-input" id="chatInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendChat()">
                            <button class="btn btn-primary" onclick="sendChat()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Leaderboard Tab -->
            <div class="tab-content" id="tab-leaderboard">
                <div class="section">
                    <div class="section-title">üí∞ Wealth Leaders</div>
                    <div id="wealthLeaderboard"></div>
                </div>
                
                <div class="section">
                    <div class="section-title">‚ú® Emoji Score Leaders</div>
                    <div id="emojiLeaderboard"></div>
                </div>
            </div>
            
            <!-- Admin Tab -->
            <div class="tab-content" id="tab-admin">
                <div class="admin-section">
                    <div class="section-title">üëë Admin Panel</div>
                    <div class="form-group">
                        <label class="form-label">Target Email</label>
                        <input type="email" class="form-input" id="adminTargetEmail" placeholder="User email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" class="form-input" id="adminAddAmount" placeholder="Amount to add">
                    </div>
                    <button class="btn btn-primary" onclick="adminAddMoney()">Add Money</button>
                    
                    <div style="margin-top: 1.5rem;">
                        <div class="section-title">üìã All Users</div>
                        <div id="adminUsersList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Settings</div>
                <button class="modal-close" onclick="closeSettingsModal()">√ó</button>
            </div>
            <div class="form-group">
                <label class="form-label">Account Email</label>
                <input type="email" class="form-input" id="settingsEmail" disabled>
            </div>
            <div class="form-group">
                <label class="form-label">Display Name</label>
                <input type="text" class="form-input" id="settingsName" disabled>
            </div>
            <button class="btn btn-danger" style="width: 100%; margin-top: 1rem;" onclick="confirmResetAccount()">Reset Account</button>
        </div>
    </div>
    
    <!-- Pack Opening Overlay -->
    <div class="pack-opening-overlay" id="packOpeningOverlay">
        <div class="pack-reveal">
            <div class="pack-reveal-emoji" id="revealEmoji">üéÅ</div>
            <div class="pack-reveal-rarity" id="revealRarity">Opening...</div>
            <div id="revealPoints" style="color: var(--gold); margin-bottom: 1rem;"></div>
            <button class="btn btn-primary" onclick="closePackOpening()">Continue</button>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Confetti Container -->
    <div class="confetti-container" id="confettiContainer"></div>
    <script>
        // =============================================
        // CONFIGURATION
        // =============================================
        
        const API_URL = 'https://script.google.com/macros/s/AKfycbzJH_jyOreJtTuAS7Aml4aivxkU2yuHfEnxrYXwSBxaqxL8hDhwMYKh4ACV2c4qjvvzKQ/exec';
        const MASTER_ADMIN = 'sheepishlyroyal@gmail.com';
        const STOCK_ADMINS = ['sheepishlyroyal@gmail.com'];
        
        // =============================================
        // STATE
        // =============================================
        
        let currentUser = null;
        let stocks = [];
        let holdings = [];
        let selectedPack = null;
        let marketSentiment = 'neutral';
        let marketTrend = 0;
        
        // Cheat Game State
        let cheatLobby = null;
        let cheatLobbyId = null;
        let cheatBuyIn = 0;
        let cheatGameActive = false;
        let cheatMyTurn = false;
        let cheatMyCards = [];
        let cheatSelectedCards = [];
        let cheatPile = [];
        let cheatCurrentClaim = null;
        let cheatLastPlay = null;
        let cheatTotalPot = 0;
        let cheatPlayers = [];
        let cheatPlayerHands = {};
        let cheatCurrentPlayerIndex = 0;
        let cheatBotCount = 0;
        let lobbyPollInterval = null;
        
        // Card Constants
        const SUITS = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
        const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        
        // Emoji Packs
        const EMOJI_PACKS = [
            { name: 'Animals', emojis: ['üê∂', 'üê±', 'üêº', 'ü¶ä', 'ü¶Å', 'üêØ', 'üê®', 'üê∏', 'ü¶ã', 'ü¶Ñ'] },
            { name: 'Food', emojis: ['üçï', 'üçî', 'üçü', 'üåÆ', 'üç£', 'üç©', 'üç™', 'üéÇ', 'üç¶', 'üç´'] },
            { name: 'Sports', emojis: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'üéæ', 'üèê', 'üé±', 'üèÜ', 'ü•á', 'üéØ'] },
            { name: 'Nature', emojis: ['üå∏', 'üå∫', 'üåª', 'üåπ', 'üå¥', 'üåä', '‚≠ê', 'üåô', '‚òÄÔ∏è', 'üåà'] },
            { name: 'Travel', emojis: ['‚úàÔ∏è', 'üöÄ', 'üöó', 'üö¢', 'üóΩ', 'üóº', 'üè∞', 'üé°', 'üèùÔ∏è', 'üåç'] },
            { name: 'Music', emojis: ['üéµ', 'üé∏', 'üéπ', 'ü•Å', 'üé∫', 'üéª', 'üé§', 'üéß', 'üéº', 'üé∑'] },
            { name: 'Faces', emojis: ['üòÄ', 'üòé', 'ü•≥', 'üòç', 'ü§©', 'üòá', 'ü§†', 'ü•∏', 'üòà', 'üëª'] },
            { name: 'Fantasy', emojis: ['üßô', 'üßö', 'üßú', 'üßù', 'ü¶∏', 'ü¶π', 'üë∏', 'ü§¥', 'üéÉ', 'üëΩ'] },
            { name: 'Ocean', emojis: ['üêã', 'üê¨', 'ü¶à', 'üêô', 'ü¶ë', 'ü¶Ä', 'ü¶û', 'üêö', 'üèÑ', '‚öì'] },
            { name: 'Space', emojis: ['üöÄ', 'üõ∏', 'üåå', 'ü™ê', '‚òÑÔ∏è', 'üå†', 'üë®‚ÄçüöÄ', 'üëæ', 'üõ∞Ô∏è', 'üåë'] },
            { name: 'Tech', emojis: ['üíª', 'üì±', 'ü§ñ', 'üéÆ', 'üíæ', 'üì°', 'üîã', 'üí°', '‚ö°', 'üîå'] },
            { name: 'Money', emojis: ['üí∞', 'üíµ', 'üíé', 'üëë', 'üè¶', 'üí≥', 'üìà', 'üé∞', 'üí∏', 'ü§ë'] },
            { name: 'Weather', emojis: ['‚òÄÔ∏è', 'üå§Ô∏è', '‚õàÔ∏è', '‚ùÑÔ∏è', 'üå™Ô∏è', 'üåä', 'üî•', 'üí®', 'üå´Ô∏è', '‚ö°'] },
            { name: 'Flags', emojis: ['üè≥Ô∏è‚Äçüåà', 'üè¥‚Äç‚ò†Ô∏è', 'üö©', 'üéå', 'üèÅ', 'üè≥Ô∏è', 'üè¥', '‚õ≥', 'üéè', 'ü™Å'] },
            { name: 'Hearts', emojis: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'üíñ', 'üíù'] },
            { name: 'Hands', emojis: ['üëç', 'üëé', 'üëä', '‚úä', 'ü§ù', 'üôè', 'üëè', 'ü§ü', '‚úåÔ∏è', 'ü§ô'] },
            { name: 'Magic', emojis: ['‚ú®', 'üí´', '‚ö°', 'üîÆ', 'ü™Ñ', 'üé≠', 'üé™', 'üé†', 'üåü', 'üí•'] },
            { name: 'Gems', emojis: ['üíé', 'üí†', 'üî∂', 'üî∑', 'üî¥', 'üü†', 'üü°', 'üü¢', 'üîµ', 'üü£'] },
            { name: 'Horror', emojis: ['üëª', 'üíÄ', '‚ò†Ô∏è', 'üßü', 'üßõ', 'üéÉ', 'ü¶á', 'üï∑Ô∏è', 'üï∏Ô∏è', '‚ö∞Ô∏è'] },
            { name: 'Luck', emojis: ['üçÄ', 'üé∞', 'üé≤', 'üéØ', 'üé±', 'üîÆ', 'üåà', '‚≠ê', 'üéä', 'üéâ'] }
        ];
        
        const RARITIES = [
            { name: 'Common', color: '#6b7280', chance: 0.40, multiplier: 1 },
            { name: 'Uncommon', color: '#22c55e', chance: 0.25, multiplier: 2 },
            { name: 'Rare', color: '#3b82f6', chance: 0.18, multiplier: 5 },
            { name: 'Epic', color: '#8b5cf6', chance: 0.10, multiplier: 10 },
            { name: 'Legendary', color: '#fbbf24', chance: 0.05, multiplier: 25 },
            { name: 'Mythic', color: '#ec4899', chance: 0.018, multiplier: 100 },
            { name: 'Divine', color: '#fff', chance: 0.002, multiplier: 500 }
        ];
        
        // =============================================
        // INITIALIZATION
        // =============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            initPlinkoBoard();
            initRouletteWheel();
            renderPacks();
            
            // Check for saved session
            const savedUser = localStorage.getItem('lintoriaUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
            
            // Loan preview updates
            document.getElementById('loanAmount').addEventListener('input', updateLoanPreview);
            document.getElementById('loanTerm').addEventListener('change', updateLoanPreview);
        });
        
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                container.appendChild(particle);
            }
        }
        
        // =============================================
        // API HELPER
        // =============================================
        
        async function apiCall(data) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    mode: 'cors'
                });
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return { success: false, message: 'Connection error. Please try again.' };
            }
        }
        
        // =============================================
        // UTILITY FUNCTIONS
        // =============================================
        
        function formatNumber(num) {
            if (num === undefined || num === null) return '0';
            return parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString();
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function createConfetti() {
            const container = document.getElementById('confettiContainer');
            const colors = ['#fbbf24', '#8b5cf6', '#22c55e', '#3b82f6', '#ef4444', '#ec4899'];
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                container.appendChild(confetti);
            }
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 3500);
        }
        
        // =============================================
        // AUTHENTICATION
        // =============================================
        
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Form').classList.add('active');
        }
        
        async function register() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim().toLowerCase();
            const password = document.getElementById('registerPassword').value;
            
            if (!name || !email || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            showToast('Creating account...', 'info');
            
            const data = await apiCall({ action: 'register', name, email, password });
            
            if (data.success) {
                currentUser = {
                    name,
                    email,
                    balance: data.balance || 100000,
                    creditScore: data.creditScore || 650,
                    emojiScore: 0
                };
                localStorage.setItem('lintoriaUser', JSON.stringify(currentUser));
                showToast('Account created! Welcome to Lintoria!', 'success');
                showMainApp();
            } else {
                showToast(data.message || 'Registration failed', 'error');
            }
        }
        
        async function login() {
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }
            
            showToast('Logging in...', 'info');
            
            const data = await apiCall({ action: 'login', email, password });
            
            if (data.success) {
                currentUser = {
                    name: data.name || data.user?.name || email.split('@')[0],
                    email,
                    balance: data.balance || data.user?.balance || 0,
                    creditScore: data.creditScore || data.user?.creditScore || 650,
                    emojiScore: data.user?.emojiScore || 0
                };
                localStorage.setItem('lintoriaUser', JSON.stringify(currentUser));
                showToast('Welcome back!', 'success');
                showMainApp();
            } else {
                showToast(data.message || 'Login failed', 'error');
            }
        }
        
        function logout() {
            currentUser = null;
            localStorage.removeItem('lintoriaUser');
            
            // Clear cheat lobby polling
            if (lobbyPollInterval) clearInterval(lobbyPollInterval);
            cheatLobby = null;
            cheatLobbyId = null;
            
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').classList.remove('active');
            showToast('Logged out', 'info');
        }
        
        function showMainApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
            
            // Show admin tab if admin
            if (currentUser.email.toLowerCase() === MASTER_ADMIN.toLowerCase()) {
                document.getElementById('adminTab').style.display = 'block';
            }
            
            // Show stock admin section
            if (STOCK_ADMINS.includes(currentUser.email.toLowerCase())) {
                document.getElementById('adminStockSection').style.display = 'block';
            }
            
            // Settings
            document.getElementById('settingsEmail').value = currentUser.email;
            document.getElementById('settingsName').value = currentUser.name;
            
            // Load initial data
            loadDashboard();
            loadStocks();
            loadChat();
            loadLeaderboard();
            
            if (currentUser.email.toLowerCase() === MASTER_ADMIN.toLowerCase()) {
                loadAdmin();
            }
        }
        
        function switchTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
            
            // Load tab-specific data
            if (tabId === 'stocks') loadStocks();
            if (tabId === 'loans') loadLoans();
            if (tabId === 'chat') loadChat();
            if (tabId === 'leaderboard') loadLeaderboard();
            if (tabId === 'packs') loadCollection();
        }
        
        // =============================================
        // DASHBOARD
        // =============================================
        
        async function loadDashboard() {
            document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
            
            const data = await apiCall({ action: 'getDashboard', email: currentUser.email });
            
            if (data.success) {
                currentUser.balance = data.balance || currentUser.balance;
                currentUser.creditScore = data.creditScore || currentUser.creditScore;
                currentUser.emojiScore = data.emojiScore || 0;
                
                document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
                document.getElementById('statBalance').textContent = '$' + formatNumber(currentUser.balance);
                document.getElementById('statCredit').textContent = currentUser.creditScore;
                document.getElementById('statEmoji').textContent = currentUser.emojiScore;
                document.getElementById('statTx').textContent = data.transactionCount || 0;
                document.getElementById('creditScoreDisplay').textContent = currentUser.creditScore;
                
                localStorage.setItem('lintoriaUser', JSON.stringify(currentUser));
            }
            
            loadTransactions();
        }
        
        async function loadTransactions() {
            const data = await apiCall({ action: 'getTransactions', email: currentUser.email });
            const container = document.getElementById('transactionsList');
            
            if (data.success && data.transactions && data.transactions.length > 0) {
                container.innerHTML = data.transactions.slice(0, 10).map(tx => `
                    <div class="holding-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">${escapeHtml(tx.type || tx.description || 'Transaction')}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">${formatDate(tx.timestamp)}</div>
                            </div>
                            <div style="font-weight: 700; color: ${tx.amount >= 0 || tx.direction === 'credit' ? 'var(--success)' : 'var(--danger)'};">
                                ${tx.amount >= 0 || tx.direction === 'credit' ? '+' : ''}$${formatNumber(Math.abs(tx.amount))}
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÑ</div><p>No transactions yet</p></div>';
            }
        }
        
        async function sendMoney() {
            const toEmail = document.getElementById('transferEmail').value.trim().toLowerCase();
            const amount = parseFloat(document.getElementById('transferAmount').value);
            
            if (!toEmail || !amount || amount <= 0) {
                showToast('Please enter valid recipient and amount', 'error');
                return;
            }
            
            if (amount > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            const data = await apiCall({
                action: 'transfer',
                fromEmail: currentUser.email,
                toEmail,
                amount
            });
            
            if (data.success) {
                currentUser.balance = data.newBalance;
                document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
                document.getElementById('transferEmail').value = '';
                document.getElementById('transferAmount').value = '';
                showToast(`Sent $${formatNumber(amount)} to ${toEmail}`, 'success');
                loadDashboard();
            } else {
                showToast(data.message || 'Transfer failed', 'error');
            }
        }
        
        // =============================================
        // STOCKS - WITH BACKEND INTEGRATION
        // =============================================
        
        async function loadStocks() {
            const data = await apiCall({ action: 'getStocks' });
            
            if (data.success && data.stocks) {
                stocks = data.stocks;
                marketSentiment = data.marketSentiment || 'neutral';
                marketTrend = data.marketTrend || 0;
                
                updateMarketSentimentUI();
                renderStocks();
            }
            
            loadPortfolio();
        }
        
        function updateMarketSentimentUI() {
            const indicator = document.getElementById('sentimentIndicator');
            const text = document.getElementById('sentimentText');
            const desc = document.getElementById('sentimentDesc');
            
            indicator.classList.remove('sentiment-bullish', 'sentiment-bearish', 'sentiment-neutral');
            
            if (marketSentiment === 'bullish') {
                indicator.classList.add('sentiment-bullish');
                text.textContent = 'üìà Market Bullish';
                desc.textContent = 'Prices trending upward';
            } else if (marketSentiment === 'bearish') {
                indicator.classList.add('sentiment-bearish');
                text.textContent = 'üìâ Market Bearish';
                desc.textContent = 'Prices trending downward';
            } else {
                indicator.classList.add('sentiment-neutral');
                text.textContent = 'üìä Market Neutral';
                desc.textContent = 'Prices are stable';
            }
        }
        
        function renderStocks() {
            const container = document.getElementById('stocksList');
            
            container.innerHTML = stocks.map(stock => {
                const change = parseFloat(stock.change) || 0;
                const isUp = change >= 0;
                const impact = parseFloat(stock.playerImpact) || 0;
                
                let impactText = '';
                if (impact > 10) {
                    impactText = 'üî• High buy pressure';
                } else if (impact < -10) {
                    impactText = '‚ùÑÔ∏è High sell pressure';
                }
                
                return `
                    <div class="stock-card ${isUp ? '' : 'down'}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div class="stock-symbol">${escapeHtml(stock.symbol)}</div>
                                <div class="stock-name">${escapeHtml(stock.name)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="stock-price">$${formatNumber(stock.price)}</div>
                                <div class="stock-change ${isUp ? 'up' : 'down'}">${isUp ? '+' : ''}${change.toFixed(2)}%</div>
                            </div>
                        </div>
                        ${impactText ? `<div class="stock-impact">${impactText}</div>` : ''}
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-muted);">
                            <span>Vol: ${formatNumber(stock.volume || 0)}</span>
                            <span>H: $${formatNumber(stock.dayHigh || stock.price)}</span>
                            <span>L: $${formatNumber(stock.dayLow || stock.price)}</span>
                        </div>
                        <div class="stock-actions">
                            <input type="number" class="form-input" id="shares-${stock.symbol}" value="1" min="1" placeholder="Shares">
                            <button class="btn btn-success btn-sm" onclick="buyStock('${stock.symbol}')">Buy</button>
                            <button class="btn btn-danger btn-sm" onclick="sellStock('${stock.symbol}')">Sell</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function buyStock(symbol) {
            const sharesInput = document.getElementById(`shares-${symbol}`);
            const shares = parseInt(sharesInput.value) || 1;
            
            const stock = stocks.find(s => s.symbol === symbol);
            if (!stock) return;
            
            const cost = stock.price * shares;
            
            if (cost > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            showToast('Processing purchase...', 'info');
            
            const data = await apiCall({
                action: 'buyStock',
                email: currentUser.email,
                symbol,
                shares,
                price: stock.price
            });
            
            if (data.success) {
                currentUser.balance = data.newBalance;
                document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
                
                // Update local stock price if returned
                if (data.stockPrice) {
                    const stockIndex = stocks.findIndex(s => s.symbol === symbol);
                    if (stockIndex >= 0) {
                        stocks[stockIndex].price = data.stockPrice;
                        stocks[stockIndex].change = data.priceChange || 0;
                    }
                }
                
                showToast(`Bought ${shares} ${symbol} shares!`, 'success');
                renderStocks();
                loadPortfolio();
            } else {
                showToast(data.message || 'Purchase failed', 'error');
            }
        }
        
        async function sellStock(symbol) {
            const sharesInput = document.getElementById(`shares-${symbol}`);
            const shares = parseInt(sharesInput.value) || 1;
            
            const stock = stocks.find(s => s.symbol === symbol);
            if (!stock) return;
            
            showToast('Processing sale...', 'info');
            
            const data = await apiCall({
                action: 'sellStock',
                email: currentUser.email,
                symbol,
                shares,
                price: stock.price
            });
            
            if (data.success) {
                currentUser.balance = data.newBalance;
                document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
                
                // Update local stock price if returned
                if (data.stockPrice) {
                    const stockIndex = stocks.findIndex(s => s.symbol === symbol);
                    if (stockIndex >= 0) {
                        stocks[stockIndex].price = data.stockPrice;
                        stocks[stockIndex].change = data.priceChange || 0;
                    }
                }
                
                const plText = data.profitLoss >= 0 ? `+$${formatNumber(data.profitLoss)}` : `-$${formatNumber(Math.abs(data.profitLoss))}`;
                showToast(`Sold ${shares} ${symbol} (${plText})`, 'success');
                renderStocks();
                loadPortfolio();
            } else {
                showToast(data.message || 'Sale failed', 'error');
            }
        }
        
        async function loadPortfolio() {
            const data = await apiCall({ action: 'getPortfolio', email: currentUser.email });
            
            if (data.success) {
                holdings = data.holdings || data.portfolio || data.stocks || [];
                renderHoldings();
            }
        }
        
        function renderHoldings() {
            const container = document.getElementById('holdingsList');
            
            if (!holdings || holdings.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><p>No holdings yet</p></div>';
                document.getElementById('portfolioValue').textContent = '$0.00';
                document.getElementById('portfolioPL').textContent = '$0.00';
                document.getElementById('portfolioPL').style.color = 'var(--text-muted)';
                return;
            }
            
            let totalValue = 0;
            let totalCost = 0;
            
            container.innerHTML = holdings.map(h => {
                const stock = stocks.find(s => s.symbol === h.symbol);
                const currentPrice = stock ? stock.price : (h.price || h.avgPrice || 0);
                const avgPrice = h.avgPrice || h.price || currentPrice;
                const shares = h.shares || h.quantity || 0;
                const value = currentPrice * shares;
                const cost = avgPrice * shares;
                const pl = value - cost;
                const plPercent = cost > 0 ? ((pl / cost) * 100).toFixed(2) : 0;
                
                totalValue += value;
                totalCost += cost;
                
                return `
                    <div class="holding-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 700; color: var(--gold);">${escapeHtml(h.symbol)}</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${shares} shares @ $${formatNumber(avgPrice)}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600;">$${formatNumber(value)}</div>
                                <div style="font-size: 0.8rem; color: ${pl >= 0 ? 'var(--success)' : 'var(--danger)'};">
                                    ${pl >= 0 ? '+' : ''}$${formatNumber(pl)} (${plPercent}%)
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const totalPL = totalValue - totalCost;
            document.getElementById('portfolioValue').textContent = '$' + formatNumber(totalValue);
            document.getElementById('portfolioPL').textContent = (totalPL >= 0 ? '+$' : '-$') + formatNumber(Math.abs(totalPL));
            document.getElementById('portfolioPL').style.color = totalPL >= 0 ? 'var(--success)' : 'var(--danger)';
        }
        
        async function createNewStock() {
            const symbol = document.getElementById('newStockSymbol').value.trim().toUpperCase();
            const name = document.getElementById('newStockName').value.trim();
            const price = parseFloat(document.getElementById('newStockPrice').value);
            
            if (!symbol || !name || !price || price <= 0) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            const data = await apiCall({
                action: 'createStock',
                adminEmail: currentUser.email,
                symbol,
                name,
                price,
                shares: 10000
            });
            
            if (data.success) {
                showToast(`Created stock ${symbol}!`, 'success');
                document.getElementById('newStockSymbol').value = '';
                document.getElementById('newStockName').value = '';
                document.getElementById('newStockPrice').value = '';
                loadStocks();
            } else {
                showToast(data.message || 'Failed to create stock', 'error');
            }
        }
        
        // Refresh stocks periodically
        setInterval(() => {
            if (currentUser && document.getElementById('tab-stocks').classList.contains('active')) {
                loadStocks();
            }
        }, 30000);
        // =============================================
        // PLINKO
        // =============================================
        
        const PLINKO_MULTIPLIERS = [10, 5, 2, 1.5, 1, 0.5, 0.3, 0.5, 1, 1.5, 2, 5, 10];
        let plinkoActiveBalls = 0;
        
        function initPlinkoBoard() {
            const board = document.getElementById('plinkoBoard');
            board.innerHTML = '';
            
            const rows = 12;
            const boardWidth = board.offsetWidth || 340;
            const startY = 30;
            const rowHeight = 25;
            
            for (let row = 0; row < rows; row++) {
                const pegsInRow = row + 3;
                const rowWidth = (pegsInRow - 1) * 25;
                const startX = (boardWidth - rowWidth) / 2;
                
                for (let peg = 0; peg < pegsInRow; peg++) {
                    const pegEl = document.createElement('div');
                    pegEl.className = 'plinko-peg';
                    pegEl.style.left = (startX + peg * 25 - 5) + 'px';
                    pegEl.style.top = (startY + row * rowHeight) + 'px';
                    board.appendChild(pegEl);
                }
            }
            
            // Create slots
            const slotsContainer = document.createElement('div');
            slotsContainer.className = 'plinko-slots';
            PLINKO_MULTIPLIERS.forEach((mult, i) => {
                const slot = document.createElement('div');
                slot.className = 'plinko-slot';
                slot.id = `plinko-slot-${i}`;
                slot.textContent = mult + 'x';
                if (mult >= 5) slot.style.background = 'linear-gradient(180deg, #fbbf24 0%, #d97706 100%)';
                else if (mult >= 2) slot.style.background = 'linear-gradient(180deg, #8b5cf6 0%, #6d28d9 100%)';
                slotsContainer.appendChild(slot);
            });
            board.appendChild(slotsContainer);
        }
        
        async function dropPlinkoBall() {
            const bet = parseFloat(document.getElementById('plinkoBet').value) || 100;
            const ballCount = parseInt(document.getElementById('plinkoBalls').value) || 1;
            
            if (bet * ballCount > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            if (plinkoActiveBalls > 0) {
                showToast('Wait for current balls to finish', 'warning');
                return;
            }
            
            const totalBet = bet * ballCount;
            currentUser.balance -= totalBet;
            document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
            
            plinkoActiveBalls = ballCount;
            const colors = ['ball-gold', 'ball-purple', 'ball-blue', 'ball-green', 'ball-red'];
            
            let totalWinnings = 0;
            
            for (let i = 0; i < ballCount; i++) {
                setTimeout(() => {
                    const winnings = animatePlinkoBall(bet, colors[i % colors.length]);
                    totalWinnings += winnings;
                }, i * 300);
            }
        }
        
        function animatePlinkoBall(bet, colorClass) {
            const board = document.getElementById('plinkoBoard');
            const boardWidth = board.offsetWidth || 340;
            
            const ball = document.createElement('div');
            ball.className = `plinko-ball ${colorClass}`;
            
            let x = boardWidth / 2 - 9 + (Math.random() - 0.5) * 40;
            let y = 5;
            ball.style.left = x + 'px';
            ball.style.top = y + 'px';
            board.appendChild(ball);
            
            const rows = 12;
            let currentRow = 0;
            let slotIndex = 6;
            
            const dropInterval = setInterval(() => {
                if (currentRow >= rows) {
                    clearInterval(dropInterval);
                    
                    // Calculate final slot
                    slotIndex = Math.max(0, Math.min(12, slotIndex));
                    const multiplier = PLINKO_MULTIPLIERS[slotIndex];
                    const winnings = bet * multiplier;
                    
                    // Highlight slot
                    const slot = document.getElementById(`plinko-slot-${slotIndex}`);
                    slot.classList.add('active');
                    setTimeout(() => slot.classList.remove('active'), 1000);
                    
                    // Update balance
                    currentUser.balance += winnings;
                    document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
                    document.getElementById('plinkoLastWin').textContent = '$' + formatNumber(winnings);
                    
                    // Record result
                    const profit = winnings - bet;
                    apiCall({
                        action: 'recordGambling',
                        email: currentUser.email,
                        game: 'plinko',
                        wagered: bet,
                        won: profit > 0 ? profit : 0,
                        lost: profit < 0 ? Math.abs(profit) : 0,
                        result: profit >= 0 ? 'win' : 'loss'
                    });
                    
                    if (multiplier >= 5) {
                        showToast(`üéâ ${multiplier}x! Won $${formatNumber(winnings)}!`, 'success');
                        createConfetti();
                    }
                    
                    // Remove ball
                    setTimeout(() => {
                        ball.remove();
                        plinkoActiveBalls--;
                    }, 500);
                    
                    return;
                }
                
                // Move ball
                const direction = Math.random() < 0.5 ? -1 : 1;
                slotIndex += direction > 0 ? 0 : 0;
                if (direction < 0 && slotIndex > 0) slotIndex--;
                if (direction > 0 && slotIndex < 12) slotIndex++;
                
                x += direction * 12 + (Math.random() - 0.5) * 5;
                y += 25;
                
                // Keep in bounds
                x = Math.max(20, Math.min(boardWidth - 30, x));
                
                ball.style.left = x + 'px';
                ball.style.top = y + 'px';
                ball.style.transition = 'all 0.1s ease-out';
                
                currentRow++;
            }, 100);
            
            return 0; // Actual winnings calculated in interval
        }
        
        // =============================================
        // ROULETTE
        // =============================================
        
        let selectedRouletteBet = null;
        
        function initRouletteWheel() {
            const wheel = document.getElementById('rouletteWheel');
            const numbers = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
            const colors = { 0: '#16a34a' };
            const red = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];
            
            red.forEach(n => colors[n] = '#dc2626');
            for (let i = 1; i <= 36; i++) {
                if (!colors[i]) colors[i] = '#1f2937';
            }
            
            let html = '';
            const segmentAngle = 360 / numbers.length;
            
            numbers.forEach((num, i) => {
                const angle = i * segmentAngle;
                const color = colors[num];
                html += `
                    <div style="position: absolute; width: 50%; height: 50%; 
                        transform-origin: 100% 100%; 
                        transform: rotate(${angle}deg) skewY(${90 - segmentAngle}deg);
                        background: ${color}; left: 0; top: 0;
                        display: flex; align-items: center; justify-content: flex-start; padding-left: 5px;">
                    </div>
                `;
            });
            
            wheel.innerHTML = html + `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    width: 40px; height: 40px; background: var(--gold); border-radius: 50%;
                    display: flex; align-items: center; justify-content: center; font-weight: 800; color: #000; font-size: 0.8rem;">
                    üé∞
                </div>
            `;
        }
        
        function selectRouletteBet(bet) {
            selectedRouletteBet = bet;
            document.querySelectorAll('.roulette-bet-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById(`bet${bet.charAt(0).toUpperCase() + bet.slice(1)}`).classList.add('selected');
        }
        
        async function spinRoulette() {
            if (!selectedRouletteBet) {
                showToast('Select Red, Black, or Green', 'error');
                return;
            }
            
            const bet = parseFloat(document.getElementById('rouletteBet').value) || 100;
            
            if (bet > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            currentUser.balance -= bet;
            document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
            
            const wheel = document.getElementById('rouletteWheel');
            const numbers = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
            const red = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];
            
            const resultIndex = Math.floor(Math.random() * numbers.length);
            const resultNumber = numbers[resultIndex];
            const resultColor = resultNumber === 0 ? 'green' : (red.includes(resultNumber) ? 'red' : 'black');
            
            const spins = 5 + Math.random() * 3;
            const finalAngle = spins * 360 + (resultIndex / numbers.length) * 360;
            
            wheel.style.transform = `rotate(${finalAngle}deg)`;
            
            setTimeout(async () => {
                let winnings = 0;
                let won = false;
                
                if (selectedRouletteBet === resultColor) {
                    won = true;
                    if (resultColor === 'green') {
                        winnings = bet * 35;
                    } else {
                        winnings = bet * 2;
                    }
                }
                
                if (won) {
                    currentUser.balance += winnings;
                    document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
                    document.getElementById('rouletteResult').innerHTML = `<span style="color: var(--success);">üéâ ${resultNumber} ${resultColor.toUpperCase()}! Won $${formatNumber(winnings)}!</span>`;
                    if (resultColor === 'green') createConfetti();
                } else {
                    document.getElementById('rouletteResult').innerHTML = `<span style="color: var(--danger);">üíî ${resultNumber} ${resultColor.toUpperCase()}. Lost $${formatNumber(bet)}</span>`;
                }
                
                await apiCall({
                    action: 'recordGambling',
                    email: currentUser.email,
                    game: 'roulette',
                    wagered: bet,
                    won: won ? (winnings - bet) : 0,
                    lost: won ? 0 : bet,
                    result: won ? 'win' : 'loss'
                });
                
                wheel.style.transition = 'none';
                wheel.style.transform = 'rotate(0deg)';
                setTimeout(() => {
                    wheel.style.transition = 'transform 5s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
                }, 100);
                
            }, 5000);
        }
        
        // =============================================
        // SLOTS
        // =============================================
        
        const SLOT_SYMBOLS = ['üçí', 'üçã', 'üçá', 'üçä', '‚≠ê', 'üíé', '7Ô∏è‚É£', 'üé∞'];
        
        async function spinSlots() {
            const bet = parseFloat(document.getElementById('slotsBet').value) || 100;
            
            if (bet > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            currentUser.balance -= bet;
            document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
            
            const reels = [
                document.getElementById('slot1'),
                document.getElementById('slot2'),
                document.getElementById('slot3')
            ];
            
            reels.forEach(reel => reel.classList.add('spinning'));
            document.getElementById('slotsResult').textContent = '';
            
            const results = [
                SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)],
                SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)],
                SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)]
            ];
            
            // Small chance for jackpot
            if (Math.random() < 0.02) {
                const jackpotSymbol = SLOT_SYMBOLS[Math.floor(Math.random() * SLOT_SYMBOLS.length)];
                results[0] = results[1] = results[2] = jackpotSymbol;
            }
            
            for (let i = 0; i < 3; i++) {
                await new Promise(resolve => setTimeout(resolve, 500 + i * 300));
                reels[i].classList.remove('spinning');
                reels[i].querySelector('.slot-symbol').textContent = results[i];
            }
            
            await new Promise(resolve => setTimeout(resolve, 300));
            
            let winnings = 0;
            let multiplier = 0;
            
            if (results[0] === results[1] && results[1] === results[2]) {
                // Three of a kind
                const symbolIndex = SLOT_SYMBOLS.indexOf(results[0]);
                multiplier = [3, 4, 5, 6, 8, 15, 20, 25][symbolIndex];
                winnings = bet * multiplier;
            } else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
                // Two of a kind
                multiplier = 1.5;
                winnings = bet * multiplier;
            }
            
            if (winnings > 0) {
                currentUser.balance += winnings;
                document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
                document.getElementById('slotsResult').innerHTML = `<span style="color: var(--success);">üéâ ${multiplier}x! Won $${formatNumber(winnings)}!</span>`;
                if (multiplier >= 10) createConfetti();
            } else {
                document.getElementById('slotsResult').innerHTML = `<span style="color: var(--danger);">No match. Lost $${formatNumber(bet)}</span>`;
            }
            
            await apiCall({
                action: 'recordGambling',
                email: currentUser.email,
                game: 'slots',
                wagered: bet,
                won: winnings > 0 ? (winnings - bet) : 0,
                lost: winnings > 0 ? 0 : bet,
                result: winnings > 0 ? 'win' : 'loss'
            });
        }
        
        // =============================================
        // COIN FLIP
        // =============================================
        
        async function flipCoin(choice) {
            const bet = parseFloat(document.getElementById('coinBet').value) || 100;
            
            if (bet > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            currentUser.balance -= bet;
            document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
            
            const coin = document.getElementById('coin');
            coin.classList.add('flipping');
            document.getElementById('coinResult').textContent = '';
            
            const result = Math.random() < 0.5 ? 'heads' : 'tails';
            
            setTimeout(async () => {
                coin.classList.remove('flipping');
                coin.style.transform = result === 'heads' ? 'rotateY(0deg)' : 'rotateY(180deg)';
                
                const won = choice === result;
                
                if (won) {
                    const winnings = bet * 1.9;
                    currentUser.balance += winnings;
                    document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
                    document.getElementById('coinResult').innerHTML = `<span style="color: var(--success);">üéâ ${result.toUpperCase()}! Won $${formatNumber(winnings)}!</span>`;
                } else {
                    document.getElementById('coinResult').innerHTML = `<span style="color: var(--danger);">üíî ${result.toUpperCase()}. Lost $${formatNumber(bet)}</span>`;
                }
                
                await apiCall({
                    action: 'recordGambling',
                    email: currentUser.email,
                    game: 'coinflip',
                    wagered: bet,
                    won: won ? (bet * 0.9) : 0,
                    lost: won ? 0 : bet,
                    result: won ? 'win' : 'loss'
                });
            }, 1500);
        }
        
        // =============================================
        // DICE
        // =============================================
        
        const DICE_FACES = ['‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
        
        async function rollDice() {
            const bet = parseFloat(document.getElementById('diceBet').value) || 100;
            
            if (bet > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            currentUser.balance -= bet;
            document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
            
            const dice = document.getElementById('dice');
            dice.classList.add('rolling');
            document.getElementById('diceResult').textContent = '';
            
            const result = Math.floor(Math.random() * 6) + 1;
            
            setTimeout(async () => {
                dice.classList.remove('rolling');
                document.getElementById('diceFace').textContent = DICE_FACES[result - 1];
                
                const won = result >= 4;
                
                if (won) {
                    const winnings = bet * 1.9;
                    currentUser.balance += winnings;
                    document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
                    document.getElementById('diceResult').innerHTML = `<span style="color: var(--success);">üéâ Rolled ${result}! Won $${formatNumber(winnings)}!</span>`;
                } else {
                    document.getElementById('diceResult').innerHTML = `<span style="color: var(--danger);">üíî Rolled ${result}. Lost $${formatNumber(bet)}</span>`;
                }
                
                await apiCall({
                    action: 'recordGambling',
                    email: currentUser.email,
                    game: 'dice',
                    wagered: bet,
                    won: won ? (bet * 0.9) : 0,
                    lost: won ? 0 : bet,
                    result: won ? 'win' : 'loss'
                });
            }, 1000);
        }
        
        // =============================================
        // CRASH
        // =============================================
        
        let crashInterval = null;
        let crashMultiplier = 1;
        let crashBet = 0;
        let crashActive = false;
        let crashCashedOut = false;
        
        async function startCrash() {
            const bet = parseFloat(document.getElementById('crashBet').value) || 100;
            
            if (bet > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            if (crashActive) return;
            
            currentUser.balance -= bet;
            document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
            crashBet = bet;
            crashActive = true;
            crashCashedOut = false;
            crashMultiplier = 1;
            
            document.getElementById('crashStartBtn').disabled = true;
            document.getElementById('crashCashoutBtn').disabled = false;
            document.getElementById('crashMultiplier').classList.remove('crashed');
            document.getElementById('crashStatus').textContent = 'Going up...';
            
            // Determine crash point
            const crashPoint = 1 + Math.random() * Math.random() * 10;
            
            crashInterval = setInterval(() => {
                crashMultiplier += 0.01 + (crashMultiplier * 0.005);
                document.getElementById('crashMultiplier').textContent = crashMultiplier.toFixed(2) + 'x';
                
                // Color based on multiplier
                if (crashMultiplier >= 5) {
                    document.getElementById('crashMultiplier').style.color = '#fbbf24';
                } else if (crashMultiplier >= 2) {
                    document.getElementById('crashMultiplier').style.color = '#22c55e';
                }
                
                if (crashMultiplier >= crashPoint && !crashCashedOut) {
                    clearInterval(crashInterval);
                    crashActive = false;
                    
                    document.getElementById('crashMultiplier').classList.add('crashed');
                    document.getElementById('crashMultiplier').style.color = '';
                    document.getElementById('crashStatus').textContent = `Crashed at ${crashMultiplier.toFixed(2)}x!`;
                    document.getElementById('crashStartBtn').disabled = false;
                    document.getElementById('crashCashoutBtn').disabled = true;
                    
                    apiCall({
                        action: 'recordGambling',
                        email: currentUser.email,
                        game: 'crash',
                        wagered: crashBet,
                        won: 0,
                        lost: crashBet,
                        result: 'loss'
                    });
                }
            }, 50);
        }
        
        async function cashoutCrash() {
            if (!crashActive || crashCashedOut) return;
            
            clearInterval(crashInterval);
            crashCashedOut = true;
            crashActive = false;
            
            const winnings = crashBet * crashMultiplier;
            currentUser.balance += winnings;
            document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
            
            document.getElementById('crashStatus').textContent = `Cashed out at ${crashMultiplier.toFixed(2)}x! Won $${formatNumber(winnings)}`;
            document.getElementById('crashStartBtn').disabled = false;
            document.getElementById('crashCashoutBtn').disabled = true;
            document.getElementById('crashMultiplier').style.color = '';
            
            if (crashMultiplier >= 3) createConfetti();
            
            await apiCall({
                action: 'recordGambling',
                email: currentUser.email,
                game: 'crash',
                wagered: crashBet,
                won: winnings - crashBet,
                lost: 0,
                result: 'win'
            });
        }
        
        // =============================================
        // BLACKJACK
        // =============================================
        
        let bjDeck = [];
        let bjPlayerHand = [];
        let bjDealerHand = [];
        let bjBet = 0;
        let bjGameActive = false;
        
        function createDeck() {
            const deck = [];
            for (const suit of SUITS) {
                for (const rank of RANKS) {
                    deck.push({ suit, rank });
                }
            }
            // Shuffle
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }
        
        function getCardValue(card) {
            if (['J', 'Q', 'K'].includes(card.rank)) return 10;
            if (card.rank === 'A') return 11;
            return parseInt(card.rank);
        }
        
        function getHandValue(hand) {
            let value = 0;
            let aces = 0;
            
            for (const card of hand) {
                value += getCardValue(card);
                if (card.rank === 'A') aces++;
            }
            
            while (value > 21 && aces > 0) {
                value -= 10;
                aces--;
            }
            
            return value;
        }
        
        function renderBjCard(card, hidden = false) {
            if (hidden) {
                return `<div class="bj-card hidden"></div>`;
            }
            const isRed = ['‚ô•', '‚ô¶'].includes(card.suit);
            return `<div class="bj-card ${isRed ? 'red' : 'black'}">
                <div>${card.rank}</div>
                <div>${card.suit}</div>
            </div>`;
        }
        
        function renderBjHands(hideDealer = true) {
            const dealerCards = document.getElementById('dealerCards');
            const playerCards = document.getElementById('playerCards');
            
            dealerCards.innerHTML = bjDealerHand.map((card, i) => 
                renderBjCard(card, hideDealer && i === 1)
            ).join('');
            
            playerCards.innerHTML = bjPlayerHand.map(card => renderBjCard(card)).join('');
            
            const playerValue = getHandValue(bjPlayerHand);
            document.getElementById('playerScore').textContent = `Value: ${playerValue}`;
            
            if (hideDealer) {
                document.getElementById('dealerScore').textContent = `Value: ${getCardValue(bjDealerHand[0])}+?`;
            } else {
                document.getElementById('dealerScore').textContent = `Value: ${getHandValue(bjDealerHand)}`;
            }
        }
        
        async function startBlackjack() {
            const bet = parseFloat(document.getElementById('bjBet').value) || 100;
            
            if (bet > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            currentUser.balance -= bet;
            document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
            bjBet = bet;
            bjGameActive = true;
            
            bjDeck = createDeck();
            bjPlayerHand = [bjDeck.pop(), bjDeck.pop()];
            bjDealerHand = [bjDeck.pop(), bjDeck.pop()];
            
            document.getElementById('bjBetGroup').style.display = 'none';
            document.getElementById('bjControls').style.display = 'grid';
            document.getElementById('bjResult').textContent = '';
            
            renderBjHands(true);
            
            // Check for blackjack
            if (getHandValue(bjPlayerHand) === 21) {
                await endBlackjack('blackjack');
            }
        }
        
        async function bjHit() {
            if (!bjGameActive) return;
            
            bjPlayerHand.push(bjDeck.pop());
            renderBjHands(true);
            
            if (getHandValue(bjPlayerHand) > 21) {
                await endBlackjack('bust');
            }
        }
        
        async function bjStand() {
            if (!bjGameActive) return;
            
            // Dealer plays
            renderBjHands(false);
            
            while (getHandValue(bjDealerHand) < 17) {
                await new Promise(r => setTimeout(r, 500));
                bjDealerHand.push(bjDeck.pop());
                renderBjHands(false);
            }
            
            const playerValue = getHandValue(bjPlayerHand);
            const dealerValue = getHandValue(bjDealerHand);
            
            if (dealerValue > 21) {
                await endBlackjack('dealer_bust');
            } else if (playerValue > dealerValue) {
                await endBlackjack('win');
            } else if (playerValue < dealerValue) {
                await endBlackjack('lose');
            } else {
                await endBlackjack('push');
            }
        }
        
        async function bjDouble() {
            if (!bjGameActive || bjPlayerHand.length !== 2) return;
            
            if (bjBet > currentUser.balance) {
                showToast('Insufficient balance to double', 'error');
                return;
            }
            
            currentUser.balance -= bjBet;
            document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
            bjBet *= 2;
            
            bjPlayerHand.push(bjDeck.pop());
            renderBjHands(true);
            
            if (getHandValue(bjPlayerHand) > 21) {
                await endBlackjack('bust');
            } else {
                await bjStand();
            }
        }
        
        async function endBlackjack(result) {
            bjGameActive = false;
            renderBjHands(false);
            
            let winnings = 0;
            let message = '';
            
            switch (result) {
                case 'blackjack':
                    winnings = bjBet * 2.5;
                    message = `<span style="color: var(--success);">üéâ BLACKJACK! Won $${formatNumber(winnings)}!</span>`;
                    createConfetti();
                    break;
                case 'win':
                case 'dealer_bust':
                    winnings = bjBet * 2;
                    message = `<span style="color: var(--success);">üéâ You win! +$${formatNumber(winnings)}</span>`;
                    break;
                case 'push':
                    winnings = bjBet;
                    message = `<span style="color: var(--warning);">Push - bet returned</span>`;
                    break;
                case 'bust':
                    message = `<span style="color: var(--danger);">üíî Bust! Lost $${formatNumber(bjBet)}</span>`;
                    break;
                case 'lose':
                    message = `<span style="color: var(--danger);">üíî Dealer wins. Lost $${formatNumber(bjBet)}</span>`;
                    break;
            }
            
            if (winnings > 0) {
                currentUser.balance += winnings;
                document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
            }
            
            document.getElementById('bjResult').innerHTML = message;
            document.getElementById('bjBetGroup').style.display = 'flex';
            document.getElementById('bjControls').style.display = 'none';
            
            await apiCall({
                action: 'recordGambling',
                email: currentUser.email,
                game: 'blackjack',
                wagered: bjBet,
                won: winnings > bjBet ? (winnings - bjBet) : 0,
                lost: winnings < bjBet ? (bjBet - winnings) : 0,
                result: winnings >= bjBet ? 'win' : 'loss'
            });
        }
        
        // =============================================
        // EMOJI PACKS
        // =============================================
        
        function renderPacks() {
            const container = document.getElementById('packsList');
            container.innerHTML = EMOJI_PACKS.map((pack, i) => `
                <div class="pack-card" onclick="selectPack(${i})" id="pack-${i}">
                    <div class="pack-emojis">${pack.emojis.slice(0, 3).join('')}</div>
                    <div class="pack-name">${pack.name}</div>
                    <div class="pack-price">$7,500</div>
                </div>
            `).join('');
        }
        
        function selectPack(index) {
            document.querySelectorAll('.pack-card').forEach(p => p.classList.remove('selected'));
            document.getElementById(`pack-${index}`).classList.add('selected');
            selectedPack = index;
            document.getElementById('buyPackBtn').disabled = false;
            document.getElementById('buyPackBtn').textContent = `Buy ${EMOJI_PACKS[index].name} Pack - $7,500`;
        }
        
        async function buySelectedPack() {
            if (selectedPack === null) {
                showToast('Select a pack first', 'error');
                return;
            }
            
            const price = 7500;
            
            if (currentUser.balance < price) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            currentUser.balance -= price;
            document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
            
            const pack = EMOJI_PACKS[selectedPack];
            const emoji = pack.emojis[Math.floor(Math.random() * pack.emojis.length)];
            
            // Determine rarity
            const roll = Math.random();
            let cumulativeChance = 0;
            let rarity = RARITIES[0];
            
            for (const r of RARITIES) {
                cumulativeChance += r.chance;
                if (roll <= cumulativeChance) {
                    rarity = r;
                    break;
                }
            }
            
            const points = 100 * rarity.multiplier;
            
            // Show opening animation
            const overlay = document.getElementById('packOpeningOverlay');
            overlay.classList.add('active');
            
            document.getElementById('revealEmoji').textContent = 'üéÅ';
            document.getElementById('revealRarity').textContent = 'Opening...';
            document.getElementById('revealPoints').textContent = '';
            
            await new Promise(r => setTimeout(r, 1500));
            
            document.getElementById('revealEmoji').textContent = emoji;
            document.getElementById('revealRarity').textContent = rarity.name;
            document.getElementById('revealRarity').style.color = rarity.color;
            document.getElementById('revealPoints').textContent = `+${points} Emoji Score`;
            
            if (rarity.multiplier >= 10) createConfetti();
            
            // Save to backend
            await apiCall({
                action: 'buyPack',
                email: currentUser.email,
                packName: pack.name,
                emoji,
                rarity: rarity.name,
                points
            });
            
            currentUser.emojiScore = (currentUser.emojiScore || 0) + points;
            document.getElementById('statEmoji').textContent = currentUser.emojiScore;
            
            loadCollection();
        }
        
        function closePackOpening() {
            document.getElementById('packOpeningOverlay').classList.remove('active');
        }
        
        async function loadCollection() {
            const data = await apiCall({ action: 'getCollection', email: currentUser.email });
            const container = document.getElementById('collectionGrid');
            
            if (data.success && data.collection && data.collection.length > 0) {
                container.innerHTML = data.collection.map(item => {
                    const rarity = RARITIES.find(r => r.name === item.rarity) || RARITIES[0];
                    return `
                        <div class="emoji-item" onclick="sellEmoji('${item.emoji}', '${item.rarity}', ${item.points})" style="cursor: pointer; border: 2px solid ${rarity.color};">
                            <div class="emoji-icon">${item.emoji}</div>
                            <div class="emoji-count">${item.count}x</div>
                            <div class="rarity-badge rarity-${item.rarity.toLowerCase()}">${item.rarity}</div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><div class="empty-icon">üé®</div><p>No emojis yet</p></div>';
            }
        }
        
        async function sellEmoji(emoji, rarity, points) {
            const rarityData = RARITIES.find(r => r.name === rarity) || RARITIES[0];
            const price = Math.floor(7500 * 0.3 * rarityData.multiplier);
            
            if (!confirm(`Sell ${emoji} (${rarity}) for $${formatNumber(price)}?`)) return;
            
            const data = await apiCall({
                action: 'sellEmoji',
                email: currentUser.email,
                emoji,
                rarity,
                price
            });
            
            if (data.success) {
                currentUser.balance = data.newBalance;
                document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
                showToast(`Sold ${emoji} for $${formatNumber(price)}!`, 'success');
                loadCollection();
                loadDashboard();
            } else {
                showToast(data.message || 'Failed to sell', 'error');
            }
        }
        // =============================================
        // CHEAT GAME - MULTIPLAYER LOBBY SYSTEM
        // =============================================

        async function createCheatLobby() {
            const buyIn = parseFloat(document.getElementById('cheatBuyInAmount').value) || 100;
            
            if (buyIn < 100) {
                showToast('Minimum buy-in is $100', 'error');
                return;
            }
            
            if (buyIn > currentUser.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            showToast('Creating lobby...', 'info');
            
            const data = await apiCall({
                action: 'createCheatLobby',
                email: currentUser.email,
                name: currentUser.name,
                buyIn: buyIn
            });
            
            if (data.success) {
                currentUser.balance = data.newBalance;
                document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
                
                cheatLobbyId = data.lobbyId;
                cheatBuyIn = buyIn;
                
                showToast('Lobby created! Waiting for players...', 'success');
                startLobbyPolling();
            } else {
                showToast(data.message || 'Failed to create lobby', 'error');
            }
        }

        async function joinCheatLobby() {
            showToast('Looking for lobby...', 'info');
            
            const data = await apiCall({
                action: 'joinCheatLobby',
                email: currentUser.email,
                name: currentUser.name
            });
            
            if (data.success) {
                currentUser.balance = data.newBalance;
                document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
                
                cheatLobbyId = data.lobbyId;
                cheatBuyIn = data.minBuyIn;
                
                showToast(`Joined lobby! Buy-in: $${formatNumber(data.minBuyIn)}`, 'success');
                startLobbyPolling();
            } else {
                showToast(data.message || 'No active lobby found. Create one!', 'warning');
            }
        }

        function startLobbyPolling() {
            // Clear any existing polling
            if (lobbyPollInterval) clearInterval(lobbyPollInterval);
            
            // Immediate first poll
            pollLobbyState();
            
            // Poll for updates every 2 seconds
            lobbyPollInterval = setInterval(() => {
                if (cheatGameActive) {
                    clearInterval(lobbyPollInterval);
                    return;
                }
                pollLobbyState();
            }, 2000);
        }

        async function pollLobbyState() {
            const data = await apiCall({
                action: 'getCheatLobby',
                email: currentUser.email,
                lobbyId: cheatLobbyId
            });
            
            if (!data.success || !data.inLobby) {
                // No longer in lobby
                if (lobbyPollInterval) clearInterval(lobbyPollInterval);
                resetCheatUI();
                return;
            }
            
            cheatLobby = data.lobby;
            cheatLobbyId = data.lobby.lobbyId;
            
            renderLobbyUI(data);
            
            // Check if game should start
            if (data.consensusReached && data.consensusBots) {
                showToast(`All players agreed on ${data.consensusBots} bots! Starting game...`, 'success');
                
                if (lobbyPollInterval) clearInterval(lobbyPollInterval);
                
                cheatBotCount = data.consensusBots;
                cheatTotalPot = data.lobby.totalPot;
                
                // Wait for backend to start game
                setTimeout(() => checkGameStart(), 1500);
            }
        }

        async function checkGameStart() {
            const data = await apiCall({
                action: 'getCheatLobby',
                email: currentUser.email,
                lobbyId: cheatLobbyId
            });
            
            if (data.success && data.lobby && data.lobby.status === 'playing') {
                startCheatGameFromLobby(data);
            } else if (data.consensusReached) {
                // Trigger game start
                await apiCall({
                    action: 'startCheatGame',
                    lobbyId: cheatLobbyId,
                    botCount: cheatBotCount
                });
                
                setTimeout(() => startCheatGameFromLobby(data), 500);
            }
        }

        function renderLobbyUI(data) {
            const players = data.players || [];
            const lobby = data.lobby || {};
            
            // Hide lobby controls, show lobby area
            document.getElementById('cheatLobbyControls').style.display = 'none';
            document.getElementById('cheatLobbyArea').style.display = 'block';
            document.getElementById('cheatCardsContainer').style.display = 'none';
            document.getElementById('cheatPileArea').style.display = 'none';
            document.getElementById('cheatGameControls').style.display = 'none';
            document.getElementById('cheatLastPlayInfo').style.display = 'none';
            
            // Update lobby info
            document.getElementById('cheatLobbyId').textContent = `(${lobby.lobbyId || ''})`;
            document.getElementById('cheatLobbyBuyIn').textContent = '$' + formatNumber(lobby.minBuyIn || 100);
            
            // Update status
            document.getElementById('cheatStatusText').textContent = `${players.length} player(s) in lobby`;
            
            // Render player list
            const playerListEl = document.getElementById('cheatPlayerList');
            playerListEl.innerHTML = players.map(player => {
                const hasVoted = player.vote !== null && player.vote !== undefined && player.vote !== '';
                const isMe = player.email.toLowerCase() === currentUser.email.toLowerCase();
                const isHost = player.isHost;
                
                return `
                    <div class="cheat-player-item" style="${isMe ? 'border: 1px solid var(--gold);' : ''}">
                        <div class="cheat-player-name">
                            ${isHost ? 'üëë ' : ''}${escapeHtml(player.name)}
                            ${isHost ? '<span class="cheat-player-host">HOST</span>' : ''}
                            ${isMe ? '<span style="font-size: 0.65rem; color: var(--gold); margin-left: 0.25rem;">(You)</span>' : ''}
                        </div>
                        <div class="cheat-player-vote ${hasVoted ? 'voted' : ''}">
                            ${hasVoted ? `‚úì Voted: ${player.vote} bot${player.vote > 1 ? 's' : ''}` : '‚è≥ Voting...'}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update vote count
            const totalPlayers = players.length;
            const votedPlayers = players.filter(p => p.vote !== null && p.vote !== undefined && p.vote !== '').length;
            document.getElementById('cheatVoteCount').textContent = votedPlayers;
            document.getElementById('cheatVoteTotal').textContent = totalPlayers;
            
            // Update vote buttons
            const myPlayer = players.find(p => p.email.toLowerCase() === currentUser.email.toLowerCase());
            const myVote = myPlayer ? myPlayer.vote : null;
            
            document.querySelectorAll('.cheat-vote-btn').forEach(btn => {
                const voteValue = parseInt(btn.textContent);
                btn.classList.remove('selected', 'locked');
                
                if (myVote !== null && myVote !== undefined && myVote !== '') {
                    if (parseInt(myVote) === voteValue) {
                        btn.classList.add('selected');
                    }
                    btn.classList.add('locked');
                }
            });
            
            // Show waiting message if player has voted
            if (myVote !== null && myVote !== undefined && myVote !== '') {
                document.getElementById('cheatWaiting').style.display = 'block';
                document.getElementById('cheatVoteSection').querySelector('.cheat-vote-btns').style.opacity = '0.5';
            } else {
                document.getElementById('cheatWaiting').style.display = 'none';
                document.getElementById('cheatVoteSection').querySelector('.cheat-vote-btns').style.opacity = '1';
            }
            
            // Show vote mismatch info if all voted but no consensus
            if (data.allVoted && !data.consensusReached && Object.keys(data.votes || {}).length > 0) {
                let voteBreakdown = Object.entries(data.votes)
                    .map(([bots, count]) => `${count} vote${count > 1 ? 's' : ''} for ${bots} bot${bots > 1 ? 's' : ''}`)
                    .join(', ');
                
                document.getElementById('cheatStatusText').innerHTML = `
                    Votes don't match! ${voteBreakdown}<br>
                    <span style="font-size: 0.75rem;">Votes will reset in a few seconds...</span>
                `;
            }
        }

        async function voteForBots(numBots) {
            if (!cheatLobbyId) {
                showToast('Not in a lobby', 'error');
                return;
            }
            
            showToast(`Voting for ${numBots} bot${numBots > 1 ? 's' : ''}...`, 'info');
            
            const data = await apiCall({
                action: 'voteCheatBots',
                email: currentUser.email,
                lobbyId: cheatLobbyId,
                botCount: numBots
            });
            
            if (data.success) {
                if (data.gameStarted) {
                    showToast('All players agreed! Starting game...', 'success');
                    cheatBotCount = numBots;
                    cheatTotalPot = data.totalPot || cheatTotalPot;
                    
                    if (lobbyPollInterval) clearInterval(lobbyPollInterval);
                    setTimeout(() => checkGameStart(), 1000);
                } else {
                    showToast(`Voted for ${numBots} bot${numBots > 1 ? 's' : ''}!`, 'success');
                    pollLobbyState(); // Immediate refresh
                }
            } else {
                showToast(data.message || 'Failed to vote', 'error');
            }
        }

        async function leaveLobby() {
            if (!cheatLobbyId) return;
            
            const data = await apiCall({
                action: 'leaveCheatLobby',
                email: currentUser.email,
                lobbyId: cheatLobbyId
            });
            
            if (data.success) {
                currentUser.balance = data.newBalance;
                document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
                showToast(`Refunded $${formatNumber(data.refund)}`, 'info');
            }
            
            // Clear state
            if (lobbyPollInterval) clearInterval(lobbyPollInterval);
            cheatLobby = null;
            cheatLobbyId = null;
            cheatBuyIn = 0;
            
            resetCheatUI();
        }

        function startCheatGameFromLobby(lobbyData) {
            cheatGameActive = true;
            cheatPile = [];
            cheatCurrentClaim = null;
            cheatSelectedCards = [];
            cheatLastPlay = null;
            cheatCurrentPlayerIndex = 0;
            cheatPlayerHands = {};
            
            const players = lobbyData.players || [];
            
            // Build players list: real players + bots
            cheatPlayers = players.map(p => ({
                id: p.email,
                name: p.name,
                isBot: false,
                isMe: p.email.toLowerCase() === currentUser.email.toLowerCase()
            }));
            
            // Add bots
            const botNames = ['ü§ñ Bot Alpha', 'ü§ñ Bot Beta', 'ü§ñ Bot Gamma', 'ü§ñ Bot Delta', 'ü§ñ Bot Epsilon'];
            for (let i = 0; i < cheatBotCount; i++) {
                cheatPlayers.push({
                    id: `bot_${i}`,
                    name: botNames[i],
                    isBot: true,
                    isMe: false
                });
            }
            
            // Create and shuffle deck
            const deck = createCheatDeck();
            const cardsPerPlayer = Math.floor(52 / cheatPlayers.length);
            
            // Deal cards
            cheatPlayers.forEach(player => {
                cheatPlayerHands[player.id] = deck.splice(0, cardsPerPlayer);
            });
            
            // Set my cards
            cheatMyCards = cheatPlayerHands[currentUser.email.toLowerCase()] || cheatPlayerHands[currentUser.email] || [];
            
            // If no cards found, try finding by matching
            if (cheatMyCards.length === 0) {
                for (const key in cheatPlayerHands) {
                    if (key.toLowerCase() === currentUser.email.toLowerCase()) {
                        cheatMyCards = cheatPlayerHands[key];
                        break;
                    }
                }
            }
            
            // Hide lobby, show game
            document.getElementById('cheatLobbyArea').style.display = 'none';
            document.getElementById('cheatCardsContainer').style.display = 'block';
            document.getElementById('cheatPileArea').style.display = 'block';
            document.getElementById('cheatGameControls').style.display = 'block';
            
            // Update status
            document.getElementById('cheatStatus').innerHTML = `
                <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">üé¥ Game Started!</div>
                <div style="color: var(--text-muted);">${cheatPlayers.length} players ‚Ä¢ Pot: $${formatNumber(cheatTotalPot)}</div>
            `;
            
            renderCheatCards();
            
            // Find who goes first (me or rotate)
            const myIndex = cheatPlayers.findIndex(p => p.isMe);
            cheatCurrentPlayerIndex = myIndex >= 0 ? myIndex : 0;
            
            // If it's not my turn, start bot turns
            if (!cheatPlayers[cheatCurrentPlayerIndex].isMe) {
                cheatMyTurn = false;
                setTimeout(() => processCheatTurn(), 1500);
            } else {
                cheatMyTurn = true;
                updateTurnIndicator();
            }
        }

        function createCheatDeck() {
            const deck = [];
            for (const suit of SUITS) {
                for (const rank of RANKS) {
                    deck.push({ suit, rank });
                }
            }
            // Shuffle
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        function updateTurnIndicator() {
            const currentPlayer = cheatPlayers[cheatCurrentPlayerIndex];
            const isMyTurn = currentPlayer.isMe;
            
            document.getElementById('cheatStatus').innerHTML = `
                <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">
                    ${isMyTurn ? 'üé¥ Your turn!' : `‚è≥ ${currentPlayer.name}'s turn`}
                </div>
                <div style="color: var(--text-muted);">Pot: $${formatNumber(cheatTotalPot)}</div>
            `;
        }

        function renderCheatCards() {
            const container = document.getElementById('cheatCards');
            container.innerHTML = cheatMyCards.map((card, idx) => {
                const isRed = ['‚ô•', '‚ô¶'].includes(card.suit);
                const isSelected = cheatSelectedCards.includes(idx);
                return `<div class="cheat-card ${isRed ? 'red' : 'black'} ${isSelected ? 'selected' : ''}" onclick="toggleCheatCard(${idx})">
                    <div>${card.rank}</div>
                    <div>${card.suit}</div>
                </div>`;
            }).join('');
            
            document.getElementById('cheatCardCount').textContent = cheatMyCards.length;
            document.getElementById('cheatSelectedCount').textContent = cheatSelectedCards.length;
            document.getElementById('cheatPileCount').textContent = cheatPile.length;
            document.getElementById('cheatCurrentClaim').textContent = cheatCurrentClaim ? `${cheatCurrentClaim.count}x ${cheatCurrentClaim.rank}` : '-';
        }

        function toggleCheatCard(idx) {
            if (!cheatMyTurn || !cheatGameActive) return;
            
            const pos = cheatSelectedCards.indexOf(idx);
            if (pos > -1) {
                cheatSelectedCards.splice(pos, 1);
            } else if (cheatSelectedCards.length < 4) {
                cheatSelectedCards.push(idx);
            }
            renderCheatCards();
        }

        function cheatPlayCards() {
            if (!cheatMyTurn || cheatSelectedCards.length === 0) {
                showToast('Select at least 1 card', 'error');
                return;
            }
            
            const claimRank = document.getElementById('cheatClaimRank').value;
            const claimCount = parseInt(document.getElementById('cheatClaimCount').value) || cheatSelectedCards.length;
            
            // Get selected cards
            const playedCards = cheatSelectedCards.map(i => cheatMyCards[i]);
            
            // Remove from hand (sort descending to avoid index issues)
            cheatSelectedCards.sort((a, b) => b - a).forEach(i => cheatMyCards.splice(i, 1));
            cheatSelectedCards = [];
            
            // Add to pile
            cheatPile.push(...playedCards);
            
            // Set claim
            cheatCurrentClaim = { rank: claimRank, count: claimCount, player: currentUser.name };
            cheatLastPlay = { 
                player: currentUser.name, 
                playerId: currentUser.email,
                count: playedCards.length, 
                claimedRank: claimRank, 
                actualCards: playedCards 
            };
            
            // Update last play info
            document.getElementById('cheatLastPlayInfo').style.display = 'block';
            document.getElementById('cheatLastPlayDetails').innerHTML = `
                <strong>${currentUser.name}</strong> played ${playedCards.length} card(s), claimed ${claimCount}x ${claimRank}
            `;
            
            renderCheatCards();
            
            // Check for win
            if (cheatMyCards.length === 0) {
                endCheatGame(true);
                return;
            }
            
            // Next turn
            cheatMyTurn = false;
            nextCheatTurn();
        }

        function nextCheatTurn() {
            cheatCurrentPlayerIndex = (cheatCurrentPlayerIndex + 1) % cheatPlayers.length;
            
            // Skip players with no cards
            let attempts = 0;
            while (attempts < cheatPlayers.length) {
                const player = cheatPlayers[cheatCurrentPlayerIndex];
                const hand = player.isMe ? cheatMyCards : cheatPlayerHands[player.id];
                
                if (hand && hand.length > 0) break;
                
                cheatCurrentPlayerIndex = (cheatCurrentPlayerIndex + 1) % cheatPlayers.length;
                attempts++;
            }
            
            updateTurnIndicator();
            
            setTimeout(() => processCheatTurn(), 1500);
        }

        function processCheatTurn() {
            if (!cheatGameActive) return;
            
            const currentPlayer = cheatPlayers[cheatCurrentPlayerIndex];
            
            if (currentPlayer.isMe) {
                cheatMyTurn = true;
                updateTurnIndicator();
                return;
            }
            
            // Bot or other player turn
            botCheatTurn(currentPlayer);
        }

        function botCheatTurn(player) {
            if (!cheatGameActive) return;
            
            const hand = cheatPlayerHands[player.id];
            if (!hand || hand.length === 0) {
                nextCheatTurn();
                return;
            }
            
            // 25% chance to call bluff if there was a previous play
            if (cheatLastPlay && cheatLastPlay.playerId !== player.id && Math.random() < 0.25) {
                // Call bluff
                document.getElementById('cheatLastPlayInfo').style.display = 'block';
                document.getElementById('cheatLastPlayDetails').innerHTML = `üö® <strong>${player.name}</strong> calls bluff on ${cheatLastPlay.player}!`;
                
                setTimeout(() => {
                    const actualRanks = cheatLastPlay.actualCards.map(c => c.rank);
                    const wasBluff = !actualRanks.every(r => r === cheatLastPlay.claimedRank);
                    
                    if (wasBluff) {
                        // Bluff was real - last player picks up pile
                        const lastPlayerId = cheatLastPlay.playerId;
                        if (lastPlayerId.toLowerCase() === currentUser.email.toLowerCase() || lastPlayerId === currentUser.email) {
                            cheatMyCards.push(...cheatPile);
                            document.getElementById('cheatResult').innerHTML = `<span style="color: var(--danger);">You were caught bluffing! +${cheatPile.length} cards</span>`;
                        } else {
                            cheatPlayerHands[lastPlayerId] = (cheatPlayerHands[lastPlayerId] || []).concat(cheatPile);
                        }
                        showToast(`${player.name} caught the bluff!`, 'info');
                    } else {
                        // Not a bluff - caller picks up pile
                        cheatPlayerHands[player.id] = hand.concat(cheatPile);
                        showToast(`${player.name} was wrong! They pick up the pile.`, 'info');
                    }
                    
                    cheatPile = [];
                    cheatLastPlay = null;
                    cheatCurrentClaim = null;
                    renderCheatCards();
                    
                    // Check for losses (too many cards)
                    checkCheatLoss();
                    
                    setTimeout(() => {
                        document.getElementById('cheatResult').innerHTML = '';
                        nextCheatTurn();
                    }, 2000);
                }, 1000);
                
                return;
            }
            
            // Play cards
            const cardsToPlay = Math.min(1 + Math.floor(Math.random() * 3), hand.length);
            const playedCards = hand.splice(0, cardsToPlay);
            cheatPile.push(...playedCards);
            
            const claimRank = RANKS[Math.floor(Math.random() * RANKS.length)];
            cheatCurrentClaim = { rank: claimRank, count: cardsToPlay, player: player.name };
            cheatLastPlay = {
                player: player.name,
                playerId: player.id,
                count: cardsToPlay,
                claimedRank: claimRank,
                actualCards: playedCards
            };
            
            document.getElementById('cheatLastPlayInfo').style.display = 'block';
            document.getElementById('cheatLastPlayDetails').innerHTML = `
                <strong>${player.name}</strong> played ${cardsToPlay} card(s), claimed ${cardsToPlay}x ${claimRank}
            `;
            
            renderCheatCards();
            
            // Check if bot won
            if (hand.length === 0) {
                setTimeout(() => {
                    showToast(`${player.name} got rid of all their cards!`, 'info');
                    endCheatGame(false, player.name);
                }, 1000);
                return;
            }
            
            nextCheatTurn();
        }

        function cheatCallBluff() {
            if (!cheatMyTurn || !cheatLastPlay || cheatLastPlay.playerId.toLowerCase() === currentUser.email.toLowerCase()) {
                showToast('Nothing to call bluff on!', 'error');
                return;
            }
            
            cheatMyTurn = false;
            
            document.getElementById('cheatLastPlayInfo').style.display = 'block';
            document.getElementById('cheatLastPlayDetails').innerHTML = `üö® <strong>You</strong> call bluff on ${cheatLastPlay.player}!`;
            
            setTimeout(() => {
                const actualRanks = cheatLastPlay.actualCards.map(c => c.rank);
                const wasBluff = !actualRanks.every(r => r === cheatLastPlay.claimedRank);
                
                // Show the actual cards
                const actualCardsHtml = cheatLastPlay.actualCards.map(c => {
                    const isRed = ['‚ô•', '‚ô¶'].includes(c.suit);
                    return `<span style="color: ${isRed ? '#dc2626' : '#1f2937'}; background: #fff; padding: 0.2rem 0.4rem; border-radius: 4px; margin: 0 0.1rem;">${c.rank}${c.suit}</span>`;
                }).join('');
                
                document.getElementById('cheatLastPlayDetails').innerHTML += `<br>Actual cards: ${actualCardsHtml}`;
                
                setTimeout(() => {
                    if (wasBluff) {
                        // You were right! Bluffer picks up pile
                        const blufferId = cheatLastPlay.playerId;
                        cheatPlayerHands[blufferId] = (cheatPlayerHands[blufferId] || []).concat(cheatPile);
                        document.getElementById('cheatResult').innerHTML = `<span style="color: var(--success);">Correct! ${cheatLastPlay.player} picks up ${cheatPile.length} cards!</span>`;
                    } else {
                        // You were wrong! You pick up pile
                        cheatMyCards.push(...cheatPile);
                        document.getElementById('cheatResult').innerHTML = `<span style="color: var(--danger);">Wrong! You pick up ${cheatPile.length} cards!</span>`;
                    }
                    
                    cheatPile = [];
                    cheatLastPlay = null;
                    cheatCurrentClaim = null;
                    renderCheatCards();
                    
                    // Check for loss
                    checkCheatLoss();
                    
                    setTimeout(() => {
                        document.getElementById('cheatResult').innerHTML = '';
                        nextCheatTurn();
                    }, 2000);
                }, 1500);
            }, 1000);
        }

        function checkCheatLoss() {
            // Player loses if they have too many cards (30+)
            if (cheatMyCards.length >= 30) {
                setTimeout(() => endCheatGame(false), 1000);
            }
        }

        async function endCheatGame(won, winnerName = null) {
            cheatGameActive = false;
            cheatMyTurn = false;
            
            if (lobbyPollInterval) clearInterval(lobbyPollInterval);
            
            let winnings = 0;
            
            if (won) {
                // Call backend to end game and get winnings
                const data = await apiCall({
                    action: 'endCheatGame',
                    lobbyId: cheatLobbyId,
                    winnerEmail: currentUser.email,
                    winnerName: currentUser.name
                });
                
                if (data.success) {
                    winnings = data.pot || cheatTotalPot;
                    currentUser.balance = data.newBalance || (currentUser.balance + winnings);
                }
                
                document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
                document.getElementById('cheatResult').innerHTML = `<span style="color: var(--success);">üéâ YOU WIN! +$${formatNumber(winnings - cheatBuyIn)}</span>`;
                createConfetti();
            } else {
                // Someone else won
                await apiCall({
                    action: 'endCheatGame',
                    lobbyId: cheatLobbyId,
                    winnerEmail: null,
                    winnerName: winnerName
                });
                
                const winner = winnerName || 'Another player';
                document.getElementById('cheatResult').innerHTML = `<span style="color: var(--danger);">üòî ${winner} wins! You lose $${formatNumber(cheatBuyIn)}</span>`;
            }
            
            document.getElementById('cheatStatus').innerHTML = `
                <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">üé¥ Game Over</div>
                <div style="color: var(--text-muted);">${won ? 'Congratulations!' : 'Better luck next time!'}</div>
            `;
            
            setTimeout(() => {
                resetCheatGame();
                resetCheatUI();
            }, 4000);
        }

        function resetCheatGame() {
            cheatGameActive = false;
            cheatMyTurn = false;
            cheatMyCards = [];
            cheatSelectedCards = [];
            cheatPile = [];
            cheatCurrentClaim = null;
            cheatLastPlay = null;
            cheatTotalPot = 0;
            cheatBuyIn = 0;
            cheatPlayers = [];
            cheatPlayerHands = {};
            cheatCurrentPlayerIndex = 0;
            cheatLobby = null;
            cheatLobbyId = null;
            cheatBotCount = 0;
            
            if (lobbyPollInterval) clearInterval(lobbyPollInterval);
        }

        function resetCheatUI() {
            document.getElementById('cheatCardsContainer').style.display = 'none';
            document.getElementById('cheatPileArea').style.display = 'none';
            document.getElementById('cheatGameControls').style.display = 'none';
            document.getElementById('cheatLastPlayInfo').style.display = 'none';
            document.getElementById('cheatLobbyArea').style.display = 'none';
            document.getElementById('cheatLobbyControls').style.display = 'flex';
            document.getElementById('cheatResult').innerHTML = '';
            document.getElementById('cheatBuyInAmount').value = '100';
            
            document.getElementById('cheatStatus').innerHTML = `
                <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">üé¥ Cheat Lobby</div>
                <div id="cheatStatusText" style="color: var(--text-muted);">Create or join a game</div>
            `;
        }

        // =============================================
        // LOANS
        // =============================================

        function updateLoanPreview() {
            const amount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const termDays = parseInt(document.getElementById('loanTerm').value);
            
            let rate = 10;
            if (termDays === 7) rate = 5;
            else if (termDays === 30) rate = 20;
            
            const interest = amount * (rate / 100);
            const total = amount + interest;
            
            document.getElementById('loanInterestRate').textContent = rate + '%';
            document.getElementById('loanTotalRepay').textContent = '$' + formatNumber(total);
        }

        async function takeLoan() {
            const amount = parseFloat(document.getElementById('loanAmount').value);
            const termDays = parseInt(document.getElementById('loanTerm').value);
            
            if (!amount || amount < 100) {
                showToast('Minimum loan amount is $100', 'error');
                return;
            }
            
            // Calculate based on credit score
            const maxLoan = currentUser.creditScore * 1000;
            if (amount > maxLoan) {
                showToast(`Max loan for your credit score: $${formatNumber(maxLoan)}`, 'error');
                return;
            }
            
            let rate = 10;
            if (termDays === 7) rate = 5;
            else if (termDays === 30) rate = 20;
            
            const interest = amount * (rate / 100);
            const totalOwed = amount + interest;
            
            showToast('Processing loan request...', 'info');
            
            const data = await apiCall({
                action: 'createLoan',
                email: currentUser.email,
                amount,
                interest,
                totalOwed,
                termDays,
                interestRate: rate
            });
            
            if (data.success || data.approved) {
                currentUser.balance = data.newBalance || (currentUser.balance + amount);
                document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
                document.getElementById('loanAmount').value = '';
                showToast(`Loan approved! +$${formatNumber(amount)}`, 'success');
                loadLoans();
                loadDashboard();
            } else {
                showToast(data.message || 'Loan denied', 'error');
            }
        }

        async function loadLoans() {
            const data = await apiCall({ action: 'getLoans', email: currentUser.email });
            const container = document.getElementById('loansList');
            
            if (data.success && data.loans && data.loans.length > 0) {
                container.innerHTML = data.loans.map((loan, i) => `
                    <div class="loan-card">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div class="loan-amount">$${formatNumber(loan.totalOwed)}</div>
                                <div class="loan-details">
                                    Original: $${formatNumber(loan.amount)} ‚Ä¢ ${loan.interestRate || 10}% interest
                                </div>
                                <div class="loan-details">
                                    Due: ${formatDate(loan.dueDate)}
                                </div>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="repayLoan(${i}, ${loan.totalOwed})">Repay</button>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üí∞</div><p>No active loans</p></div>';
            }
        }

        async function repayLoan(index, amount) {
            if (amount > currentUser.balance) {
                showToast('Insufficient balance to repay', 'error');
                return;
            }
            
            const data = await apiCall({
                action: 'repayLoan',
                email: currentUser.email,
                loanIndex: index,
                amount
            });
            
            if (data.success) {
                currentUser.balance = data.newBalance;
                currentUser.creditScore = data.newCreditScore || currentUser.creditScore;
                document.getElementById('balanceAmount').textContent = formatNumber(currentUser.balance);
                document.getElementById('creditScoreDisplay').textContent = currentUser.creditScore;
                showToast('Loan repaid! Credit score improved!', 'success');
                loadLoans();
                loadDashboard();
            } else {
                showToast(data.message || 'Failed to repay', 'error');
            }
        }

        // =============================================
        // CHAT
        // =============================================

        async function loadChat() {
            const data = await apiCall({ action: 'getChat' });
            const container = document.getElementById('chatMessages');
            const messages = data.messages || data.chat || [];
            
            if (messages.length > 0) {
                container.innerHTML = messages.map(m => `
                    <div class="chat-message">
                        <span class="chat-username">${escapeHtml(m.name || m.email || 'Anonymous')}</span>
                        <span class="chat-time">${formatDate(m.timestamp)}</span>
                        <div class="chat-text">${escapeHtml(m.message || m.text || '')}</div>
                    </div>
                `).join('');
                container.scrollTop = container.scrollHeight;
            } else {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üí¨</div><p>No messages yet</p></div>';
            }
        }

        async function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            input.value = '';
            
            await apiCall({ 
                action: 'sendChat', 
                email: currentUser.email, 
                name: currentUser.name, 
                message 
            });
            
            loadChat();
        }

        // Auto-refresh chat
        setInterval(() => {
            if (currentUser && document.getElementById('tab-chat').classList.contains('active')) {
                loadChat();
            }
        }, 5000);

        // =============================================
        // LEADERBOARD
        // =============================================

        async function loadLeaderboard() {
            const data = await apiCall({ action: 'getLeaderboard' });
            
            if (data.success) {
                renderLeaderboard('wealthLeaderboard', data.wealth, 'balance');
                renderLeaderboard('emojiLeaderboard', data.emoji, 'emojiScore');
            }
        }

        function renderLeaderboard(containerId, leaders, valueKey) {
            const container = document.getElementById(containerId);
            
            if (!leaders || leaders.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üèÜ</div><p>No data yet</p></div>';
                return;
            }
            
            container.innerHTML = leaders.map((user, i) => {
                const rank = i + 1;
                const value = user[valueKey] || 0;
                const isMe = user.email && user.email.toLowerCase() === currentUser.email.toLowerCase();
                
                return `
                    <div class="leaderboard-item" style="${isMe ? 'border: 1px solid var(--gold);' : ''}">
                        <div class="lb-rank ${rank <= 3 ? 'lb-rank-' + rank : ''}">${rank}</div>
                        <div class="lb-info">
                            <div class="lb-name">${escapeHtml(user.name || 'Anonymous')} ${isMe ? '(You)' : ''}</div>
                        </div>
                        <div class="lb-value">${valueKey === 'balance' ? '$' : ''}${formatNumber(value)}</div>
                    </div>
                `;
            }).join('');
        }

        // =============================================
        // ADMIN
        // =============================================

        async function loadAdmin() {
            if (currentUser.email.toLowerCase() !== MASTER_ADMIN.toLowerCase()) return;
            
            const data = await apiCall({ action: 'getAdminData', adminEmail: currentUser.email });
            
            if (data.success && data.users) {
                document.getElementById('adminUsersList').innerHTML = data.users.map(u => `
                    <div class="user-list-item">
                        <div>
                            <div style="font-weight: 600;">${escapeHtml(u.name || 'Unknown')}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${escapeHtml(u.email || '')}</div>
                        </div>
                        <div style="color: var(--gold); font-weight: 700;">$${formatNumber(u.balance || 0)}</div>
                    </div>
                `).join('');
            }
        }

        async function adminAddMoney() {
            if (currentUser.email.toLowerCase() !== MASTER_ADMIN.toLowerCase()) return;
            
            const targetEmail = document.getElementById('adminTargetEmail').value.trim().toLowerCase();
            const amount = parseFloat(document.getElementById('adminAddAmount').value);
            
            if (!targetEmail || !amount) {
                showToast('Fill in all fields', 'error');
                return;
            }
            
            const data = await apiCall({ 
                action: 'adminAddMoney', 
                adminEmail: currentUser.email, 
                targetEmail, 
                amount 
            });
            
            if (data.success) {
                showToast(`Added $${formatNumber(amount)} to ${targetEmail}`, 'success');
                document.getElementById('adminTargetEmail').value = '';
                document.getElementById('adminAddAmount').value = '';
                loadAdmin();
            } else {
                showToast(data.message || 'Failed', 'error');
            }
        }

        // =============================================
        // SETTINGS & MODALS
        // =============================================

        function showSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        async function confirmResetAccount() {
            if (!confirm('Are you SURE? All progress will be lost!')) return;
            
            const data = await apiCall({ action: 'resetAccount', email: currentUser.email });
            
            if (data.success) {
                currentUser.balance = 100000;
                currentUser.creditScore = 650;
                currentUser.emojiScore = 0;
                document.getElementById('balanceAmount').textContent = formatNumber(100000);
                showToast('Account reset!', 'success');
                closeSettingsModal();
                loadDashboard();
            } else {
                showToast('Reset failed', 'error');
            }
        }

        // =============================================
        // AUTO-REFRESH BALANCE
        // =============================================

        setInterval(async () => {
            if (currentUser) {
                const data = await apiCall({ action: 'getBalance', email: currentUser.email });
                if (data.success && data.balance !== undefined) {
                    currentUser.balance = data.balance;
                    document.getElementById('balanceAmount').textContent = formatNumber(data.balance);
                }
            }
        }, 30000);
    </script>
</body>
</html>
