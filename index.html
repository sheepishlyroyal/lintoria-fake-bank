<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lintoria Hub V4.02</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #7c3aed;
            --primary-dark: #6d28d9;
            --secondary: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --darker: #111827;
            --light: #f9fafb;
            --border: #e5e7eb;
            --text: #374151;
            --text-light: #6b7280;
            --shadow: rgba(0, 0, 0, 0.1);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gold: #fbbf24;
            --silver: #9ca3af;
            --bronze: #92400e;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        /* Auth Screen */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }
        
        .auth-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .auth-header h1 {
            font-size: 2rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }
        
        .auth-header p {
            color: var(--text-light);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.2s;
            background: var(--light);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(124, 58, 237, 0.3);
        }
        
        .btn-block {
            width: 100%;
        }
        
        .auth-switch {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }
        
        .auth-switch a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        
        .auth-switch a:hover {
            text-decoration: underline;
        }
        
        /* Main App */
        .app-container {
            display: none;
            background: var(--light);
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .app-header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .app-title h1 {
            font-size: 1.5rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .version-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 2rem;
        }
        
        .balance-display {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .btn-logout {
            background: var(--danger);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-logout:hover {
            background: #dc2626;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            background: white;
            border-bottom: 1px solid var(--border);
            display: flex;
            overflow-x: auto;
            padding: 0 1rem;
        }
        
        .nav-tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-light);
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .nav-tab:hover {
            color: var(--primary);
            background: rgba(124, 58, 237, 0.05);
        }
        
        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        /* Tab Content */
        .tab-content {
            padding: 2rem;
            min-height: 500px;
        }
        
        .tab-pane {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .stat-label {
            color: var(--text-light);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
        }
        
        .stat-change {
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .stat-change.positive {
            color: var(--success);
        }
        
        .stat-change.negative {
            color: var(--danger);
        }
        
        /* Recent Activity */
        .activity-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .activity-header {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
        }
        
        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-right: 1rem;
        }
        
        .activity-icon.transfer {
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary);
        }
        
        .activity-icon.loan {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .activity-icon.stock {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success);
        }
        
        .activity-details {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 500;
            color: var(--text);
        }
        
        .activity-time {
            font-size: 0.875rem;
            color: var(--text-light);
        }
        
        .activity-amount {
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .activity-amount.positive {
            color: var(--success);
        }
        
        .activity-amount.negative {
            color: var(--danger);
        }
        
        /* Transfer Section */
        .transfer-container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .transfer-card {
            background: white;
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .transfer-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        /* Stocks */
        .stocks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stock-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }
        
        .stock-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .stock-symbol {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stock-name {
            color: var(--text-light);
            font-size: 0.875rem;
        }
        
        .stock-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        
        .stock-change {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .stock-change.positive {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .stock-change.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .stock-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn-buy {
            background: var(--success);
            color: white;
        }
        
        .btn-buy:hover {
            background: #059669;
        }
        
        .btn-sell {
            background: var(--danger);
            color: white;
        }
        
        .btn-sell:hover {
            background: #dc2626;
        }
        
        /* Portfolio */
        .portfolio-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .portfolio-table {
            background: white;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: var(--light);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text);
            border-bottom: 1px solid var(--border);
        }
        
        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover {
            background: var(--light);
        }
        
        /* Loans */
        .loan-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .loan-type-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .loan-type-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .loan-type-card.selected {
            border-color: var(--primary);
            background: rgba(124, 58, 237, 0.05);
        }
        
        .loan-type-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        
        .loan-type-range {
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }
        
        .loan-type-rate {
            color: var(--primary);
            font-weight: 600;
        }
        
        .credit-score-gauge {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
        }
        
        .gauge-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                from 180deg,
                var(--danger) 0deg,
                var(--warning) 120deg,
                var(--success) 240deg,
                var(--primary) 360deg
            );
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .gauge-inner {
            width: 85%;
            height: 85%;
            background: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .credit-score-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--text);
        }
        
        .credit-score-label {
            color: var(--text-light);
            font-size: 0.875rem;
        }
        
        /* Active Loans */
        .active-loans {
            margin-top: 2rem;
        }
        
        .loan-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }
        
        .loan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .loan-id {
            font-weight: 600;
            color: var(--text);
        }
        
        .loan-status {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .loan-status.active {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .loan-status.paid {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .loan-status.defaulted {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .loan-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .loan-detail {
            display: flex;
            flex-direction: column;
        }
        
        .loan-detail-label {
            color: var(--text-light);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .loan-detail-value {
            font-weight: 600;
            color: var(--text);
        }
        
        .loan-progress {
            margin-bottom: 1rem;
        }
        
        .progress-bar {
            background: var(--border);
            border-radius: 0.5rem;
            height: 0.5rem;
            overflow: hidden;
        }
        
        .progress-fill {
            background: var(--success);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        /* Packs */
        .packs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .pack-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            border: 3px solid transparent;
        }
        
        .pack-card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2);
        }
        
        .pack-card.selected {
            border-color: var(--gold);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1));
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
        }
        
        .pack-emoji {
            font-size: 4rem;
            margin-bottom: 1rem;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
        }
        
        .pack-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        
        .pack-price {
            color: var(--primary);
            font-weight: 600;
            font-size: 1.25rem;
        }
        
        /* Pack Opening Animation */
        .pack-opening-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .pack-opening-modal.active {
            display: flex;
        }
        
        .pack-opening-container {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 1rem;
            padding: 3rem;
            text-align: center;
            animation: packReveal 1s ease;
        }
        
        @keyframes packReveal {
            0% {
                transform: scale(0) rotate(180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.1) rotate(90deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        .pack-opening-emoji {
            font-size: 6rem;
            margin-bottom: 1rem;
            animation: emojiFloat 2s ease infinite;
        }
        
        @keyframes emojiFloat {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        .pack-opening-rarity {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .rarity-common { 
            background: linear-gradient(135deg, #9ca3af, #6b7280);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .rarity-uncommon { 
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .rarity-rare { 
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .rarity-epic { 
            background: linear-gradient(135deg, #a855f7, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .rarity-legendary { 
            background: linear-gradient(135deg, #f59e0b, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .rarity-mythic { 
            background: linear-gradient(135deg, #ef4444, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .rarity-divine { 
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: divineGlow 2s ease infinite;
        }
        
        @keyframes divineGlow {
            0%, 100% {
                filter: brightness(1);
            }
            50% {
                filter: brightness(1.5);
            }
        }
        
        .pack-opening-value {
            color: white;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }
        
        .pack-opening-points {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
        }
        
        .btn-close-pack {
            background: white;
            color: var(--primary);
            padding: 1rem 2rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-close-pack:hover {
            transform: scale(1.05);
        }
        
        /* Collection */
        .collection-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .collection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        
        .collection-item {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .collection-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .collection-emoji {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        
        .collection-rarity {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }
        
        .collection-points {
            color: var(--text-light);
            font-size: 0.875rem;
        }
        
        /* Casino Games */
        .casino-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .casino-game-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .casino-game-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .casino-game-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .casino-game-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        
        .casino-game-description {
            color: var(--text-light);
            font-size: 0.875rem;
        }
        
        .game-container {
            display: none;
            background: white;
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .game-container.active {
            display: block;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .game-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .btn-back {
            background: var(--border);
            color: var(--text);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-back:hover {
            background: var(--text-light);
            color: white;
        }
        
        .game-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .bet-input {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
            width: 150px;
        }
        
        /* Plinko */
        .plinko-board {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 1rem;
            padding: 2rem;
            position: relative;
        }
        
        .plinko-pegs {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .peg-row {
            display: flex;
            justify-content: center;
            gap: 2rem;
        }
        
        .peg {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .plinko-slots {
            display: flex;
            justify-content: space-between;
        }
        
        .slot {
            flex: 1;
            padding: 1rem 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 0.5rem;
            text-align: center;
            color: white;
            font-weight: 600;
        }
        
        .plinko-ball {
            width: 20px;
            height: 20px;
            background: var(--gold);
            border-radius: 50%;
            position: absolute;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        .plinko-ball.dropping {
            display: block;
            animation: plinkoDrop 2s ease;
        }
        
        @keyframes plinkoDrop {
            0% {
                top: 2rem;
            }
            100% {
                top: calc(100% - 4rem);
            }
        }
        
        /* Roulette */
        .roulette-wheel {
            width: 300px;
            height: 300px;
            margin: 0 auto 2rem;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #ef4444 0deg 10deg,
                #1f2937 10deg 20deg,
                #ef4444 20deg 30deg,
                #1f2937 30deg 40deg,
                #ef4444 40deg 50deg,
                #1f2937 50deg 60deg,
                #ef4444 60deg 70deg,
                #1f2937 70deg 80deg,
                #ef4444 80deg 90deg,
                #1f2937 90deg 100deg,
                #ef4444 100deg 110deg,
                #1f2937 110deg 120deg,
                #ef4444 120deg 130deg,
                #1f2937 130deg 140deg,
                #ef4444 140deg 150deg,
                #1f2937 150deg 160deg,
                #ef4444 160deg 170deg,
                #1f2937 170deg 180deg,
                #10b981 180deg 190deg,
                #1f2937 190deg 200deg,
                #ef4444 200deg 210deg,
                #1f2937 210deg 220deg,
                #ef4444 220deg 230deg,
                #1f2937 230deg 240deg,
                #ef4444 240deg 250deg,
                #1f2937 250deg 260deg,
                #ef4444 260deg 270deg,
                #1f2937 270deg 280deg,
                #ef4444 280deg 290deg,
                #1f2937 290deg 300deg,
                #ef4444 300deg 310deg,
                #1f2937 310deg 320deg,
                #ef4444 320deg 330deg,
                #1f2937 330deg 340deg,
                #ef4444 340deg 350deg,
                #1f2937 350deg 360deg
            );
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            transition: transform 3s cubic-bezier(0.17, 0.67, 0.83, 0.67);
        }
        
        .roulette-wheel.spinning {
            transform: rotate(720deg);
        }
        
        .roulette-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: var(--gold);
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--text);
        }
        
        .roulette-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid var(--gold);
            z-index: 10;
        }
        
        .roulette-bets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .bet-option {
            padding: 1rem;
            background: white;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bet-option:hover {
            border-color: var(--primary);
            background: rgba(124, 58, 237, 0.05);
        }
        
        .bet-option.selected {
            border-color: var(--primary);
            background: rgba(124, 58, 237, 0.1);
        }
        
        .bet-option.red {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--danger);
        }
        
        .bet-option.black {
            background: rgba(31, 41, 55, 0.1);
            border-color: var(--dark);
        }
        
        .bet-option.green {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
        }
        
        /* Fortune Wheel */
        .fortune-wheel {
            width: 400px;
            height: 400px;
            margin: 0 auto 2rem;
            position: relative;
        }
        
        .fortune-segments {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .fortune-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: right bottom;
        }
        
        .fortune-segment:nth-child(1) {
            background: var(--danger);
            transform: rotate(0deg);
        }
        
        .fortune-segment:nth-child(2) {
            background: var(--warning);
            transform: rotate(45deg);
        }
        
        .fortune-segment:nth-child(3) {
            background: var(--success);
            transform: rotate(90deg);
        }
        
        .fortune-segment:nth-child(4) {
            background: var(--primary);
            transform: rotate(135deg);
        }
        
        .fortune-segment:nth-child(5) {
            background: var(--secondary);
            transform: rotate(180deg);
        }
        
        .fortune-segment:nth-child(6) {
            background: var(--dark);
            transform: rotate(225deg);
        }
        
        .fortune-segment:nth-child(7) {
            background: var(--gold);
            transform: rotate(270deg);
        }
        
        .fortune-segment:nth-child(8) {
            background: var(--silver);
            transform: rotate(315deg);
        }
        
        /* Dice */
        .dice-container {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .die {
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: 700;
            color: var(--text);
        }
        
        .die.rolling {
            animation: rollDice 0.5s ease;
        }
        
        @keyframes rollDice {
            0% {
                transform: rotateX(0) rotateY(0);
            }
            25% {
                transform: rotateX(180deg) rotateY(90deg);
            }
            50% {
                transform: rotateX(360deg) rotateY(180deg);
            }
            75% {
                transform: rotateX(540deg) rotateY(270deg);
            }
            100% {
                transform: rotateX(720deg) rotateY(360deg);
            }
        }
        
        /* Slots */
        .slots-machine {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .slots-display {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .slot-reel {
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .slot-reel.spinning {
            animation: slotSpin 0.5s ease;
        }
        
        @keyframes slotSpin {
            0% {
                transform: rotateX(0);
            }
            100% {
                transform: rotateX(360deg);
            }
        }
        
        /* Blackjack */
        .blackjack-table {
            background: radial-gradient(ellipse at center, #1a5f3f, #0d3625);
            border-radius: 1rem;
            padding: 2rem;
            min-height: 400px;
        }
        
        .blackjack-hands {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .hand {
            text-align: center;
        }
        
        .hand-label {
            color: white;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .cards {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .card {
            width: 70px;
            height: 100px;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .card.red {
            color: var(--danger);
        }
        
        .card.black {
            color: var(--dark);
        }
        
        .hand-total {
            color: white;
            font-size: 1.25rem;
            margin-top: 1rem;
            font-weight: 600;
        }
        
        /* Chat */
        .chat-container {
            display: grid;
            grid-template-columns: 1fr 250px;
            gap: 2rem;
            height: 600px;
        }
        
        .chat-main {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            max-height: 500px;
        }
        
        .chat-message {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--light);
            border-radius: 0.5rem;
            animation: slideInLeft 0.3s ease;
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .chat-message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }
        
        .chat-username {
            font-weight: 600;
            color: var(--primary);
        }
        
        .chat-time {
            font-size: 0.75rem;
            color: var(--text-light);
        }
        
        .chat-text {
            color: var(--text);
        }
        
        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
        }
        
        .btn-send {
            background: var(--primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-send:hover {
            background: var(--primary-dark);
        }
        
        .chat-users {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .chat-users-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text);
        }
        
        .chat-user {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--light);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .online-indicator {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s ease infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        /* Leaderboards */
        .leaderboard-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .leaderboard-tab {
            padding: 0.75rem 1.5rem;
            background: white;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .leaderboard-tab:hover {
            border-color: var(--primary);
        }
        
        .leaderboard-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .leaderboard-list {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        
        .leaderboard-item:hover {
            background: var(--light);
        }
        
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        
        .leaderboard-rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 1rem;
        }
        
        .rank-1 {
            background: var(--gold);
            color: white;
        }
        
        .rank-2 {
            background: var(--silver);
            color: white;
        }
        
        .rank-3 {
            background: var(--bronze);
            color: white;
        }
        
        .leaderboard-user {
            flex: 1;
        }
        
        .leaderboard-name {
            font-weight: 600;
            color: var(--text);
        }
        
        .leaderboard-email {
            font-size: 0.875rem;
            color: var(--text-light);
        }
        
        .leaderboard-score {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        /* Settings Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }
        
        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }
        
        .btn-close:hover {
            background: var(--border);
        }
        
        /* Alerts */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid var(--warning);
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Admin Panel */
        .admin-panel {
            background: linear-gradient(135deg, var(--danger), var(--warning));
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
        }
        
        .admin-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .app-header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }
            
            .user-info {
                flex-direction: column;
                width: 100%;
                gap: 1rem;
            }
            
            .balance-display {
                width: 100%;
                text-align: center;
            }
            
            .nav-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stocks-grid {
                grid-template-columns: 1fr;
            }
            
            .chat-container {
                grid-template-columns: 1fr;
            }
            
            .chat-users {
                display: none;
            }
            
            .loan-types {
                grid-template-columns: 1fr;
            }
            
            .packs-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>Lintoria Hub</h1>
                <p>Virtual Economy Simulation</p>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password">
                </div>
                <button id="loginBtn" class="btn btn-primary btn-block">Login</button>
                <div class="auth-switch">
                    Don't have an account? <a href="#" id="showRegister">Register</a>
                </div>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" id="registerName" class="form-input" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="registerEmail" class="form-input" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="registerPassword" class="form-input" placeholder="Create a password">
                </div>
                <button id="registerBtn" class="btn btn-primary btn-block">Register</button>
                <div class="auth-switch">
                    Already have an account? <a href="#" id="showLogin">Login</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div class="container">
        <div id="appScreen" class="app-container">
            <!-- Header -->
            <div class="app-header">
                <div class="app-title">
                    <h1>Lintoria Hub</h1>
                    <span class="version-badge">V4.02</span>
                </div>
                <div class="user-info">
                    <span id="userName"></span>
                    <div class="balance-display">$<span id="userBalance">0</span></div>
                    <button id="settingsBtn" class="btn"> Settings</button>
                    <button id="logoutBtn" class="btn-logout">Logout</button>
                </div>
            </div>
            
            <!-- Navigation -->
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
                <button class="nav-tab" data-tab="transfer">Transfer</button>
                <button class="nav-tab" data-tab="stocks">Stocks</button>
                <button class="nav-tab" data-tab="portfolio">Portfolio</button>
                <button class="nav-tab" data-tab="loans">Loans</button>
                <button class="nav-tab" data-tab="packs">Packs</button>
                <button class="nav-tab" data-tab="collection">Collection</button>
                <button class="nav-tab" data-tab="casino">Casino</button>
                <button class="nav-tab" data-tab="passport">Travel</button>
                <button class="nav-tab" data-tab="chat">Chat</button>
                <button class="nav-tab" data-tab="leaders">Leaders</button>
                <button class="nav-tab" data-tab="admin" id="adminTab" style="display: none;">Admin</button>
            </div>
            
            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Dashboard -->
                <div class="tab-pane active" id="dashboard">
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-label">Balance</div>
                            <div class="stat-value">$<span id="dashboardBalance">0</span></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Credit Score</div>
                            <div class="stat-value" id="creditScoreDisplay">650</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Active Loans</div>
                            <div class="stat-value" id="activeLoansCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Debt</div>
                            <div class="stat-value">$<span id="totalDebt">0</span></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Emoji Score</div>
                            <div class="stat-value" id="emojiScore">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Portfolio Value</div>
                            <div class="stat-value">$<span id="portfolioValue">0</span></div>
                        </div>
                    </div>
                    
                    <div class="activity-card">
                        <div class="activity-header">Recent Activity</div>
                        <div class="activity-list" id="activityList"></div>
                    </div>
                </div>
                
                <!-- Transfer -->
                <div class="tab-pane" id="transfer">
                    <div class="transfer-container">
                        <div class="transfer-card">
                            <div class="transfer-header">Send Money</div>
                            <div class="form-group">
                                <label class="form-label">Recipient Email</label>
                                <input type="email" id="transferTo" class="form-input" placeholder="recipient@example.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" id="transferAmount" class="form-input" placeholder="0.00" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Note (Optional)</label>
                                <input type="text" id="transferNote" class="form-input" placeholder="Payment for...">
                            </div>
                            <button id="transferBtn" class="btn btn-primary btn-block">Send Transfer</button>
                        </div>
                    </div>
                </div>
                
                <!-- Stocks -->
                <div class="tab-pane" id="stocks">
                    <div class="stocks-grid" id="stocksList"></div>
                </div>
                
                <!-- Portfolio -->
                <div class="tab-pane" id="portfolio">
                    <div class="portfolio-summary">
                        <div class="stat-card">
                            <div class="stat-label">Total Holdings</div>
                            <div class="stat-value" id="totalHoldings">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Portfolio Value</div>
                            <div class="stat-value">$<span id="portfolioTotal">0</span></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Today's P/L</div>
                            <div class="stat-value" id="portfolioPL">$0</div>
                        </div>
                    </div>
                    
                    <div class="portfolio-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Shares</th>
                                    <th>Avg Price</th>
                                    <th>Current</th>
                                    <th>P/L</th>
                                    <th>Value</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="portfolioList"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Loans -->
                <div class="tab-pane" id="loans">
                    <div class="credit-score-gauge">
                        <div class="gauge-circle">
                            <div class="gauge-inner">
                                <div class="credit-score-value" id="creditScoreMain">650</div>
                                <div class="credit-score-label">Credit Score</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="loan-types" id="loanTypes"></div>
                    
                    <div class="active-loans">
                        <h3>Active Loans</h3>
                        <div id="activeLoans"></div>
                    </div>
                </div>
                
                <!-- Packs -->
                <div class="tab-pane" id="packs">
                    <div class="packs-grid" id="packsList"></div>
                    
                    <!-- Pack Opening Modal -->
                    <div class="pack-opening-modal" id="packOpeningModal">
                        <div class="pack-opening-container">
                            <div id="packOpeningContent"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Collection -->
                <div class="tab-pane" id="collection">
                    <div class="collection-stats">
                        <div class="stat-card">
                            <div class="stat-label">Total Emojis</div>
                            <div class="stat-value" id="totalEmojis">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Unique Emojis</div>
                            <div class="stat-value" id="uniqueEmojis">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Points</div>
                            <div class="stat-value" id="totalPoints">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Rarest</div>
                            <div class="stat-value" id="rarestEmoji">None</div>
                        </div>
                    </div>
                    
                    <div class="collection-grid" id="collectionGrid"></div>
                </div>
                
                <!-- Casino -->
                <div class="tab-pane" id="casino">
                    <div class="casino-menu" id="casinoMenu">
                        <div class="casino-game-card" data-game="plinko">
                            <div class="casino-game-icon"></div>
                            <div class="casino-game-name">Plinko</div>
                            <div class="casino-game-description">Drop balls for prizes</div>
                        </div>
                        <div class="casino-game-card" data-game="roulette">
                            <div class="casino-game-icon"></div>
                            <div class="casino-game-name">Roulette</div>
                            <div class="casino-game-description">Spin the wheel</div>
                        </div>
                        <div class="casino-game-card" data-game="fortune">
                            <div class="casino-game-icon"></div>
                            <div class="casino-game-name">Fortune Wheel</div>
                            <div class="casino-game-description">Spin for multipliers</div>
                        </div>
                        <div class="casino-game-card" data-game="dice">
                            <div class="casino-game-icon"></div>
                            <div class="casino-game-name">Dice</div>
                            <div class="casino-game-description">Roll the dice</div>
                        </div>
                        <div class="casino-game-card" data-game="slots">
                            <div class="casino-game-icon"></div>
                            <div class="casino-game-name">Slots</div>
                            <div class="casino-game-description">Classic slot machine</div>
                        </div>
                        <div class="casino-game-card" data-game="blackjack">
                            <div class="casino-game-icon"></div>
                            <div class="casino-game-name">Blackjack</div>
                            <div class="casino-game-description">Beat the dealer</div>
                        </div>
                    </div>
                    
                    <!-- Game Containers -->
                    <div id="gameContainers"></div>
                </div>
                
                <!-- Passport/Travel -->
                <div class="tab-pane" id="passport">
                    <div id="passportContent"></div>
                </div>
                
                <!-- Chat -->
                <div class="tab-pane" id="chat">
                    <div class="chat-container">
                        <div class="chat-main">
                            <div class="chat-messages" id="chatMessages"></div>
                            <div class="chat-input-container">
                                <input type="text" id="chatInput" class="chat-input" placeholder="Type a message..." maxlength="200">
                                <button id="sendChatBtn" class="btn-send">Send</button>
                            </div>
                        </div>
                        <div class="chat-users">
                            <div class="chat-users-title">Online Users</div>
                            <div id="onlineUsers"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Leaders -->
                <div class="tab-pane" id="leaders">
                    <div class="leaderboard-tabs">
                        <button class="leaderboard-tab active" data-leaderboard="wealth"> Wealth</button>
                        <button class="leaderboard-tab" data-leaderboard="credit"> Credit Score</button>
                        <button class="leaderboard-tab" data-leaderboard="emoji"> Emoji Score</button>
                    </div>
                    <div class="leaderboard-list" id="leaderboardList"></div>
                </div>
                
                <!-- Admin -->
                <div class="tab-pane" id="admin">
                    <div class="admin-panel">
                        <div class="admin-title"> Admin Controls</div>
                        <div class="admin-controls">
                            <button id="viewAllUsersBtn" class="btn btn-primary">View All Users</button>
                            <button id="adjustBalanceBtn" class="btn btn-warning">Adjust Balance</button>
                            <button id="resetUserBtn" class="btn btn-danger">Reset User</button>
                        </div>
                    </div>
                    <div id="adminContent"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="btn-close" onclick="closeSettings()"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Account Email</label>
                    <input type="text" class="form-input" id="settingsEmail" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Account Name</label>
                    <input type="text" class="form-input" id="settingsName" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Member Since</label>
                    <input type="text" class="form-input" id="settingsSince" readonly>
                </div>
                <hr style="margin: 1.5rem 0;">
                <h3 style="margin-bottom: 1rem;">Account Reset</h3>
                <div class="alert alert-warning">
                     Warning: Resetting your account will clear all data except your username and email. You'll receive a new starting balance based on your performance.
                </div>
                <button id="previewResetBtn" class="btn btn-warning btn-block">Preview Reset</button>
                <div id="resetPreview" style="display: none; margin-top: 1rem;">
                    <div class="stat-card">
                        <div id="resetDetails"></div>
                    </div>
                    <button id="confirmResetBtn" class="btn btn-danger btn-block" style="margin-top: 1rem;">Confirm Reset</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Constants
        const API_URL = 'https://script.google.com/macros/s/AKfycbz3CPKFWGqeAZYTdhe0FcVZgDB7HDrouu7PynSB_99BRvpyMzXjzr3DtRENmBIf7ppoFA/exec';
        const ADMIN_EMAIL = 'sheepishlyroyal@gmail.com';
        
        // State
        let currentUser = null;
        let currentBalance = 0;
        let selectedLoanType = null;
        let selectedPack = null;
        let currentStocks = [];
        let currentPortfolio = [];
        let blackjackState = null;
        
        // Centralized API Call Handler
        async function apiCall(action, params = {}) {
            try {
                const url = new URL(API_URL);
                url.searchParams.append('action', action);
                Object.keys(params).forEach(key => {
                    url.searchParams.append(key, params[key]);
                });
                
                console.log('API Call:', action, params);
                
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                const text = await response.text();
                console.log('Raw response:', text);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                try {
                    const data = JSON.parse(text);
                    console.log('Parsed response:', data);
                    return data;
                } catch (e) {
                    console.error('JSON parse error:', e);
                    console.error('Response text:', text);
                    throw new Error('Invalid response format from server');
                }
            } catch (error) {
                console.error('API Error:', error);
                if (error.message.includes('fetch')) {
                    throw new Error('Cannot connect to server. Please check your internet connection.');
                }
                throw error;
            }
        }
        
        // Auth Functions
        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }
            
            try {
                const data = await apiCall('login', { email, password });
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    showApp();
                } else {
                    alert(data.error || 'Login failed');
                }
            } catch (error) {
                alert('Login error: ' + error.message);
            }
        }
        
        async function register() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            if (!name || !email || !password) {
                alert('Please fill all fields');
                return;
            }
            
            try {
                const data = await apiCall('register', { name, email, password });
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    showApp();
                } else {
                    alert(data.message || 'Registration failed');
                }
            } catch (error) {
                alert('Registration error: ' + error.message);
            }
        }
        
        function showApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userBalance').textContent = currentUser.balance.toFixed(2);
            currentBalance = currentUser.balance;
            
            if (currentUser.email === ADMIN_EMAIL) {
                document.getElementById('adminTab').style.display = 'block';
            }
            
            loadDashboard();
        }
        
        function logout() {
            localStorage.removeItem('user');
            currentUser = null;
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('appScreen').style.display = 'none';
        }
        
        // Dashboard
        async function loadDashboard() {
            try {
                const data = await apiCall('getDashboard', { email: currentUser.email });
                
                if (data.success) {
                    // Update dashboard stats
                    document.getElementById('dashboardBalance').textContent = data.balance.toFixed(2);
                    document.getElementById('userBalance').textContent = data.balance.toFixed(2);
                    currentBalance = data.balance;
                    
                    // FIX: Set credit score explicitly
                    const creditScore = data.creditScore || 650;
                    document.getElementById('creditScoreDisplay').textContent = creditScore;
                    document.getElementById('creditScoreMain').textContent = creditScore;
                    
                    document.getElementById('activeLoansCount').textContent = data.activeLoans || 0;
                    document.getElementById('totalDebt').textContent = (data.totalDebt || 0).toFixed(2);
                    document.getElementById('emojiScore').textContent = data.emojiScore || 0;
                    
                    // Load recent activity
                    const activityList = document.getElementById('activityList');
                    activityList.innerHTML = '';
                    
                    if (data.transactions && data.transactions.length > 0) {
                        data.transactions.slice(0, 10).forEach(tx => {
                            const item = document.createElement('div');
                            item.className = 'activity-item';
                            
                            const icon = tx.type.includes('TRANSFER') ? 'transfer' :
                                        tx.type.includes('LOAN') ? 'loan' : 'stock';
                            
                            const amount = parseFloat(tx.amount);
                            const amountClass = amount >= 0 ? 'positive' : 'negative';
                            const amountSign = amount >= 0 ? '+' : '';
                            
                            item.innerHTML = `
                                <div style="display: flex; align-items: center;">
                                    <div class="activity-icon ${icon}">
                                        ${icon === 'transfer' ? '' : icon === 'loan' ? '' : ''}
                                    </div>
                                    <div class="activity-details">
                                        <div class="activity-title">${tx.type.replace(/_/g, ' ')}</div>
                                        <div class="activity-time">${tx.description || ''}</div>
                                    </div>
                                </div>
                                <div class="activity-amount ${amountClass}">
                                    ${amountSign}$${Math.abs(amount).toFixed(2)}
                                </div>
                            `;
                            
                            activityList.appendChild(item);
                        });
                    } else {
                        activityList.innerHTML = '<p style="text-align: center; color: var(--text-light);">No recent activity</p>';
                    }
                    
                    // Load portfolio value
                    loadPortfolioValue();
                }
            } catch (error) {
                console.error('Dashboard error:', error);
            }
        }
        
        async function loadPortfolioValue() {
            try {
                const data = await apiCall('getPortfolio', { email: currentUser.email });
                
                if (data.success && data.holdings) {
                    let totalValue = 0;
                    data.holdings.forEach(h => {
                        totalValue += h.quantity * h.currentPrice;
                    });
                    document.getElementById('portfolioValue').textContent = totalValue.toFixed(2);
                }
            } catch (error) {
                console.error('Portfolio value error:', error);
            }
        }
        
        // Transfer
        async function transfer() {
            const to = document.getElementById('transferTo').value.trim();
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const note = document.getElementById('transferNote').value.trim();
            
            if (!to || !amount || amount <= 0) {
                alert('Please enter valid recipient and amount');
                return;
            }
            
            if (amount > currentBalance) {
                alert('Insufficient funds');
                return;
            }
            
            try {
                const data = await apiCall('transfer', {
                    from: currentUser.email,
                    to: to,
                    amount: amount,
                    note: note
                });
                
                if (data.success) {
                    alert('Transfer successful!');
                    currentBalance = data.newBalance;
                    document.getElementById('userBalance').textContent = currentBalance.toFixed(2);
                    
                    // Clear form
                    document.getElementById('transferTo').value = '';
                    document.getElementById('transferAmount').value = '';
                    document.getElementById('transferNote').value = '';
                    
                    loadDashboard();
                } else {
                    alert(data.message || 'Transfer failed');
                }
            } catch (error) {
                alert('Transfer error: ' + error.message);
            }
        }
        
        // Stocks
        async function loadStocks() {
            try {
                const data = await apiCall('getStocks');
                
                if (data.success) {
                    currentStocks = data.stocks;
                    const stocksList = document.getElementById('stocksList');
                    stocksList.innerHTML = '';
                    
                    data.stocks.forEach(stock => {
                        const card = document.createElement('div');
                        card.className = 'stock-card';
                        
                        const changeClass = stock.change >= 0 ? 'positive' : 'negative';
                        const changeSign = stock.change >= 0 ? '+' : '';
                        
                        card.innerHTML = `
                            <div class="stock-header">
                                <div>
                                    <div class="stock-symbol">${stock.symbol}</div>
                                    <div class="stock-name">${stock.name}</div>
                                </div>
                                <div class="stock-change ${changeClass}">
                                    ${changeSign}${stock.change.toFixed(2)}%
                                </div>
                            </div>
                            <div class="stock-price">$${stock.price.toFixed(2)}</div>
                            <div style="color: var(--text-light); font-size: 0.875rem;">
                                ${stock.shares.toLocaleString()} shares available
                            </div>
                            <div class="stock-actions">
                                <button class="btn btn-buy" onclick="buyStock('${stock.symbol}', ${stock.price})">Buy</button>
                                <button class="btn btn-sell" onclick="sellStock('${stock.symbol}', ${stock.price})">Sell</button>
                            </div>
                        `;
                        
                        stocksList.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('Stocks error:', error);
            }
        }
        
        async function buyStock(symbol, price) {
            const quantity = prompt(`Buy ${symbol} at $${price.toFixed(2)}\nHow many shares?`);
            if (!quantity) return;
            
            const qty = parseInt(quantity);
            if (isNaN(qty) || qty <= 0) {
                alert('Invalid quantity');
                return;
            }
            
            const subtotal = qty * price;
            const tax = subtotal * 0.05;
            const total = subtotal + tax;
            
            if (total > currentBalance) {
                alert('Insufficient funds');
                return;
            }
            
            if (!confirm(`Buy ${qty} shares of ${symbol}?\n\nSubtotal: $${subtotal.toFixed(2)}\nTax (5%): $${tax.toFixed(2)}\nTotal: $${total.toFixed(2)}`)) {
                return;
            }
            
            try {
                const data = await apiCall('buyStock', {
                    email: currentUser.email,
                    symbol: symbol,
                    quantity: qty,
                    price: price
                });
                
                if (data.success) {
                    alert('Purchase successful!');
                    currentBalance = data.newBalance;
                    document.getElementById('userBalance').textContent = currentBalance.toFixed(2);
                    loadStocks();
                    loadPortfolio();
                } else {
                    alert(data.message || 'Purchase failed');
                }
            } catch (error) {
                alert('Purchase error: ' + error.message);
            }
        }
        
        async function sellStock(symbol, price) {
            const quantity = prompt(`Sell ${symbol} at $${price.toFixed(2)}\nHow many shares?`);
            if (!quantity) return;
            
            const qty = parseInt(quantity);
            if (isNaN(qty) || qty <= 0) {
                alert('Invalid quantity');
                return;
            }
            
            const grossAmount = qty * price;
            const tax = grossAmount * 0.05;
            const netAmount = grossAmount - tax;
            
            if (!confirm(`Sell ${qty} shares of ${symbol}?\n\nGross: $${grossAmount.toFixed(2)}\nTax (5%): $${tax.toFixed(2)}\nNet: $${netAmount.toFixed(2)}`)) {
                return;
            }
            
            try {
                const data = await apiCall('sellStock', {
                    email: currentUser.email,
                    symbol: symbol,
                    quantity: qty,
                    price: price
                });
                
                if (data.success) {
                    alert('Sale successful!');
                    currentBalance = data.newBalance;
                    document.getElementById('userBalance').textContent = currentBalance.toFixed(2);
                    loadStocks();
                    loadPortfolio();
                } else {
                    alert(data.message || 'Sale failed');
                }
            } catch (error) {
                alert('Sale error: ' + error.message);
            }
        }
        
        // Portfolio
        async function loadPortfolio() {
            try {
                const data = await apiCall('getPortfolio', { email: currentUser.email });
                
                if (data.success) {
                    currentPortfolio = data.holdings || [];
                    const portfolioList = document.getElementById('portfolioList');
                    portfolioList.innerHTML = '';
                    
                    let totalValue = 0;
                    let totalPL = 0;
                    let totalShares = 0;
                    
                    if (currentPortfolio.length > 0) {
                        currentPortfolio.forEach(holding => {
                            const value = holding.quantity * holding.currentPrice;
                            const costBasis = holding.quantity * holding.avgPrice;
                            const pl = value - costBasis;
                            const plPercent = ((pl / costBasis) * 100).toFixed(2);
                            
                            totalValue += value;
                            totalPL += pl;
                            totalShares += holding.quantity;
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><strong>${holding.symbol}</strong></td>
                                <td>${holding.quantity.toLocaleString()}</td>
                                <td>$${holding.avgPrice.toFixed(2)}</td>
                                <td>$${holding.currentPrice.toFixed(2)}</td>
                                <td class="${pl >= 0 ? 'positive' : 'negative'}">
                                    ${pl >= 0 ? '+' : ''}$${pl.toFixed(2)} (${pl >= 0 ? '+' : ''}${plPercent}%)
                                </td>
                                <td>$${value.toFixed(2)}</td>
                                <td>
                                    <button class="btn btn-sell" onclick="sellStock('${holding.symbol}', ${holding.currentPrice})">Sell</button>
                                </td>
                            `;
                            portfolioList.appendChild(row);
                        });
                    } else {
                        portfolioList.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-light);">No holdings</td></tr>';
                    }
                    
                    // Update summary
                    document.getElementById('totalHoldings').textContent = totalShares.toLocaleString();
                    document.getElementById('portfolioTotal').textContent = totalValue.toFixed(2);
                    document.getElementById('portfolioPL').textContent = `${totalPL >= 0 ? '+' : ''}$${totalPL.toFixed(2)}`;
                    document.getElementById('portfolioPL').className = `stat-value ${totalPL >= 0 ? 'positive' : 'negative'}`;
                }
            } catch (error) {
                console.error('Portfolio error:', error);
            }
        }
        
        // Loans
        async function loadLoans() {
            try {
                const data = await apiCall('getLoanData', { email: currentUser.email });
                
                if (data.success) {
                    // Update credit score
                    const creditScore = data.creditScore || 650;
                    document.getElementById('creditScoreMain').textContent = creditScore;
                    
                    // Load loan types
                    const loanTypes = document.getElementById('loanTypes');
                    loanTypes.innerHTML = '';
                    
                    const types = [
                        { id: 'personal', name: 'Personal Loan', range: '$1,000 - $50,000', baseRate: '8%', terms: [30, 60, 90] },
                        { id: 'emergency', name: 'Emergency Loan', range: '$500 - $10,000', baseRate: '15%', terms: [7, 14, 30] },
                        { id: 'payday', name: 'Payday Loan', range: '$100 - $2,000', baseRate: '25%', terms: [7, 14] },
                        { id: 'business', name: 'Business Loan', range: '$10,000 - $200,000', baseRate: '6%', terms: [60, 90, 180] }
                    ];
                    
                    types.forEach(type => {
                        const card = document.createElement('div');
                        card.className = 'loan-type-card';
                        card.onclick = () => selectLoanType(type);
                        
                        card.innerHTML = `
                            <div class="loan-type-name">${type.name}</div>
                            <div class="loan-type-range">${type.range}</div>
                            <div class="loan-type-rate">Base Rate: ${type.baseRate}</div>
                            <div style="margin-top: 0.5rem; color: var(--text-light); font-size: 0.875rem;">
                                Terms: ${type.terms.join(', ')} days
                            </div>
                        `;
                        
                        loanTypes.appendChild(card);
                    });
                    
                    // Load active loans
                    const activeLoans = document.getElementById('activeLoans');
                    activeLoans.innerHTML = '';
                    
                    if (data.activeLoans && data.activeLoans.length > 0) {
                        data.activeLoans.forEach(loan => {
                            const card = document.createElement('div');
                            card.className = 'loan-card';
                            
                            const progress = (loan.amountPaid / loan.totalOwed) * 100;
                            const dueDate = new Date(loan.dueDate);
                            const daysLeft = Math.ceil((dueDate - new Date()) / (1000 * 60 * 60 * 24));
                            
                            card.innerHTML = `
                                <div class="loan-header">
                                    <div class="loan-id">${loan.type} Loan #${loan.id.slice(-6)}</div>
                                    <div class="loan-status active">Active</div>
                                </div>
                                <div class="loan-details">
                                    <div class="loan-detail">
                                        <div class="loan-detail-label">Principal</div>
                                        <div class="loan-detail-value">$${loan.principal.toFixed(2)}</div>
                                    </div>
                                    <div class="loan-detail">
                                        <div class="loan-detail-label">Total Owed</div>
                                        <div class="loan-detail-value">$${loan.totalOwed.toFixed(2)}</div>
                                    </div>
                                    <div class="loan-detail">
                                        <div class="loan-detail-label">Remaining</div>
                                        <div class="loan-detail-value">$${loan.remaining.toFixed(2)}</div>
                                    </div>
                                    <div class="loan-detail">
                                        <div class="loan-detail-label">Due In</div>
                                        <div class="loan-detail-value">${daysLeft} days</div>
                                    </div>
                                </div>
                                <div class="loan-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-block" onclick="makeLoanPayment('${loan.id}')">
                                    Make Payment
                                </button>
                            `;
                            
                            activeLoans.appendChild(card);
                        });
                    } else {
                        activeLoans.innerHTML = '<p style="text-align: center; color: var(--text-light);">No active loans</p>';
                    }
                }
            } catch (error) {
                console.error('Loans error:', error);
            }
        }
        
        function selectLoanType(type) {
            selectedLoanType = type;
            
            // Update UI
            document.querySelectorAll('.loan-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show application form
            const amount = prompt(`Apply for ${type.name}\nAmount (${type.range}):`);
            if (!amount) return;
            
            const amountNum = parseFloat(amount);
            const min = parseInt(type.range.match(/\$([0-9,]+)/)[1].replace(',', ''));
            const max = parseInt(type.range.match(/\$([0-9,]+) -/g)[0].match(/\$([0-9,]+)/)[1].replace(',', ''));
            
            if (isNaN(amountNum) || amountNum < min || amountNum > max) {
                alert(`Amount must be between ${type.range}`);
                return;
            }
            
            const term = prompt(`Select term (${type.terms.join(', ')} days):`);
            if (!term) return;
            
            const termNum = parseInt(term);
            if (!type.terms.includes(termNum)) {
                alert('Invalid term');
                return;
            }
            
            applyLoan(type.id, amountNum, termNum);
        }
        
        async function applyLoan(type, amount, term) {
            try {
                const data = await apiCall('applyLoan', {
                    email: currentUser.email,
                    type: type,
                    amount: amount,
                    term: term
                });
                
                if (data.success) {
                    alert('Loan approved!');
                    currentBalance = data.newBalance;
                    document.getElementById('userBalance').textContent = currentBalance.toFixed(2);
                    loadLoans();
                    loadDashboard();
                } else {
                    alert(data.message || 'Loan application failed');
                }
            } catch (error) {
                alert('Loan application error: ' + error.message);
            }
        }
        
        async function makeLoanPayment(loanId) {
            const amount = prompt('Enter payment amount:');
            if (!amount) return;
            
            const amountNum = parseFloat(amount);
            if (isNaN(amountNum) || amountNum <= 0) {
                alert('Invalid amount');
                return;
            }
            
            if (amountNum > currentBalance) {
                alert('Insufficient funds');
                return;
            }
            
            try {
                const data = await apiCall('makeLoanPayment', {
                    email: currentUser.email,
                    loanId: loanId,
                    amount: amountNum
                });
                
                if (data.success) {
                    alert(data.message || 'Payment successful!');
                    currentBalance = data.newBalance;
                    document.getElementById('userBalance').textContent = currentBalance.toFixed(2);
                    loadLoans();
                    loadDashboard();
                } else {
                    alert(data.message || 'Payment failed');
                }
            } catch (error) {
                alert('Payment error: ' + error.message);
            }
        }
        
        // Themed Packs
        const THEMED_PACKS = {
            nature: {
                name: 'Nature Pack',
                emoji: '',
                emojis: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
            },
            space: {
                name: 'Space Pack',
                emoji: '',
                emojis: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
            },
            diamonds: {
                name: 'Diamond Pack',
                emoji: '',
                emojis: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
            },
            animals: {
                name: 'Animal Pack',
                emoji: '',
                emojis: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
            },
            food: {
                name: 'Food Pack',
                emoji: '',
                emojis: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
            },
            sports: {
                name: 'Sports Pack',
                emoji: '',
                emojis: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
            },
            fantasy: {
                name: 'Fantasy Pack',
                emoji: '',
                emojis: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
            },
            tech: {
                name: 'Tech Pack',
                emoji: '',
                emojis: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
            },
            ocean: {
                name: 'Ocean Pack',
                emoji: '',
                emojis: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
            },
            mystery: {
                name: 'Mystery Pack',
                emoji: '',
                emojis: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
            }
        };
        
        const RARITY_CONFIG = {
            common: { chance: 50, points: 10, sellPrice: 500, color: '#9ca3af' },
            uncommon: { chance: 30, points: 25, sellPrice: 2000, color: '#10b981' },
            rare: { chance: 12, points: 100, sellPrice: 10000, color: '#3b82f6' },
            epic: { chance: 5, points: 500, sellPrice: 25000, color: '#a855f7' },
            legendary: { chance: 2, points: 2500, sellPrice: 75000, color: '#f59e0b' },
            mythic: { chance: 0.8, points: 10000, sellPrice: 200000, color: '#ef4444' },
            divine: { chance: 0.2, points: 50000, sellPrice: 500000, color: '#fbbf24' }
        };
        
        function loadPacks() {
            const packsList = document.getElementById('packsList');
            packsList.innerHTML = '';
            
            Object.entries(THEMED_PACKS).forEach(([key, pack]) => {
                const card = document.createElement('div');
                card.className = 'pack-card';
                if (selectedPack === key) {
                    card.classList.add('selected');
                }
                card.onclick = () => selectPack(key);
                
                card.innerHTML = `
                    <div class="pack-emoji">${pack.emoji}</div>
                    <div class="pack-name">${pack.name}</div>
                    <div class="pack-price">$7,500</div>
                `;
                
                packsList.appendChild(card);
            });
            
            // Add buy button if pack selected
            if (selectedPack) {
                const buyBtn = document.createElement('button');
                buyBtn.className = 'btn btn-primary btn-block';
                buyBtn.textContent = 'Open Pack ($7,500)';
                buyBtn.onclick = openPack;
                buyBtn.style.marginTop = '2rem';
                packsList.appendChild(buyBtn);
            }
        }
        
        function selectPack(packKey) {
            selectedPack = packKey;
            loadPacks(); // Re-render to show selection
        }
        
        function getRarity() {
            const roll = Math.random() * 100;
            let cumulative = 0;
            
            for (const [rarity, config] of Object.entries(RARITY_CONFIG)) {
                cumulative += config.chance;
                if (roll <= cumulative) {
                    return rarity;
                }
            }
            
            return 'common';
        }
        
        async function openPack() {
            if (!selectedPack) {
                alert('Please select a pack first');
                return;
            }
            
            if (currentBalance < 7500) {
                alert('Insufficient funds! Pack costs $7,500');
                return;
            }
            
            const pack = THEMED_PACKS[selectedPack];
            const emoji = pack.emojis[Math.floor(Math.random() * pack.emojis.length)];
            const rarity = getRarity();
            const config = RARITY_CONFIG[rarity];
            
            try {
                const data = await apiCall('buyPack', {
                    email: currentUser.email,
                    pack: selectedPack,
                    emoji: emoji,
                    rarity: rarity,
                    points: config.points,
                    price: 7500
                });
                
                if (data.success) {
                    currentBalance = data.newBalance;
                    document.getElementById('userBalance').textContent = currentBalance.toFixed(2);
                    
                    // Show opening animation
                    showPackOpening(pack, emoji, rarity, data.isDuplicate, config);
                } else {
                    alert(data.message || 'Failed to open pack');
                }
            } catch (error) {
                alert('Pack opening error: ' + error.message);
            }
        }
        
        function showPackOpening(pack, emoji, rarity, isDuplicate, config) {
            const modal = document.getElementById('packOpeningModal');
            const content = document.getElementById('packOpeningContent');
            
            const sellValue = config.sellPrice;
            const profit = sellValue - 7500;
            const profitColor = profit >= 0 ? '#10b981' : '#ef4444';
            
            content.innerHTML = `
                <div style="color: white; font-size: 1.25rem; margin-bottom: 1rem;">${pack.name}</div>
                <div class="pack-opening-emoji">${emoji}</div>
                <div class="pack-opening-rarity rarity-${rarity}">${rarity.toUpperCase()}</div>
                <div class="pack-opening-value">Sell Value: $${sellValue.toLocaleString()}</div>
                <div class="pack-opening-points">${isDuplicate ? 'DUPLICATE - No points' : `+${config.points.toLocaleString()} points`}</div>
                ${profit !== 0 ? `<div style="color: ${profitColor}; margin-bottom: 1rem;">${profit >= 0 ? 'Profit' : 'Loss'}: $${Math.abs(profit).toLocaleString()}</div>` : ''}
                <button class="btn-close-pack" onclick="closePackOpening()">Continue</button>
            `;
            
            modal.classList.add('active');
        }
        
        function closePackOpening() {
            const modal = document.getElementById('packOpeningModal');
            modal.classList.remove('active');
            
            // Clear the content to prevent leftover display issues
            document.getElementById('packOpeningContent').innerHTML = '';
            
            loadCollection();
        }
        
        // Collection
        async function loadCollection() {
            try {
                const data = await apiCall('getCollection', { email: currentUser.email });
                
                if (data.success) {
                    const emojis = data.emojis || [];
                    const uniqueEmojis = new Set();
                    const rarityCount = {};
                    let rarestRarity = 'common';
                    let rarestEmoji = 'None';
                    
                    // Process collection
                    emojis.forEach(item => {
                        uniqueEmojis.add(item.emoji);
                        rarityCount[item.rarity] = (rarityCount[item.rarity] || 0) + 1;
                        
                        // Track rarest
                        const rarityOrder = ['common', 'uncommon', 'rare', 'epic', 'legendary', 'mythic', 'divine'];
                        if (rarityOrder.indexOf(item.rarity) > rarityOrder.indexOf(rarestRarity)) {
                            rarestRarity = item.rarity;
                            rarestEmoji = item.emoji;
                        }
                    });
                    
                    // Update stats
                    document.getElementById('totalEmojis').textContent = emojis.length;
                    document.getElementById('uniqueEmojis').textContent = uniqueEmojis.size;
                    document.getElementById('totalPoints').textContent = data.totalPoints.toLocaleString();
                    document.getElementById('rarestEmoji').textContent = rarestEmoji;
                    
                    // Display collection
                    const collectionGrid = document.getElementById('collectionGrid');
                    collectionGrid.innerHTML = '';
                    
                    const uniqueItems = [];
                    const processedEmojis = new Set();
                    
                    emojis.forEach(item => {
                        if (!processedEmojis.has(item.emoji)) {
                            processedEmojis.add(item.emoji);
                            uniqueItems.push(item);
                        }
                    });
                    
                    uniqueItems.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'collection-item';
                        div.onclick = () => sellEmoji(item);
                        
                        div.innerHTML = `
                            <div class="collection-emoji">${item.emoji}</div>
                            <div class="collection-rarity rarity-${item.rarity}">${item.rarity}</div>
                            <div class="collection-points">${item.points.toLocaleString()} pts</div>
                        `;
                        
                        collectionGrid.appendChild(div);
                    });
                    
                    if (uniqueItems.length === 0) {
                        collectionGrid.innerHTML = '<p style="text-align: center; color: var(--text-light); grid-column: 1 / -1;">No emojis collected yet</p>';
                    }
                }
            } catch (error) {
                console.error('Collection error:', error);
            }
        }
        
        async function sellEmoji(item) {
            const config = RARITY_CONFIG[item.rarity];
            const sellPrice = config.sellPrice;
            
            if (!confirm(`Sell ${item.emoji} (${item.rarity}) for $${sellPrice.toLocaleString()}?`)) {
                return;
            }
            
            try {
                const data = await apiCall('sellEmoji', {
                    email: currentUser.email,
                    emoji: item.emoji,
                    rarity: item.rarity,
                    points: item.points,
                    price: sellPrice
                });
                
                if (data.success) {
                    alert(`Sold for $${sellPrice.toLocaleString()}!`);
                    currentBalance = data.newBalance;
                    document.getElementById('userBalance').textContent = currentBalance.toFixed(2);
                    loadCollection();
                } else {
                    alert(data.message || 'Sale failed');
                }
            } catch (error) {
                alert('Sale error: ' + error.message);
            }
        }
        
        // Casino Games
        function loadCasino() {
            const gameContainers = document.getElementById('gameContainers');
            gameContainers.innerHTML = '';
            
            // Add game containers
            const games = ['plinko', 'roulette', 'fortune', 'dice', 'slots', 'blackjack'];
            games.forEach(game => {
                const container = document.createElement('div');
                container.className = 'game-container';
                container.id = `${game}Game`;
                gameContainers.appendChild(container);
            });
        }
        
        function selectGame(game) {
            // Hide all games
            document.querySelectorAll('.game-container').forEach(g => {
                g.classList.remove('active');
            });
            
            // Hide menu
            document.getElementById('casinoMenu').style.display = 'none';
            
            // Show selected game
            const gameContainer = document.getElementById(`${game}Game`);
            gameContainer.classList.add('active');
            
            // Initialize game
            switch(game) {
                case 'plinko': initPlinko(); break;
                case 'roulette': initRoulette(); break;
                case 'fortune': initFortune(); break;
                case 'dice': initDice(); break;
                case 'slots': initSlots(); break;
                case 'blackjack': initBlackjack(); break;
            }
        }
        
        function backToCasino() {
            document.querySelectorAll('.game-container').forEach(g => {
                g.classList.remove('active');
            });
            document.getElementById('casinoMenu').style.display = 'grid';
        }
        
        // Plinko
        function initPlinko() {
            const container = document.getElementById('plinkoGame');
            container.innerHTML = `
                <div class="game-header">
                    <h2 class="game-title">Plinko</h2>
                    <button class="btn-back" onclick="backToCasino()">Back</button>
                </div>
                <div class="game-controls">
                    <input type="number" id="plinkoBet" class="bet-input" placeholder="Bet amount" min="1" value="100">
                    <button class="btn btn-primary" onclick="playPlinko()">Drop Ball ($100)</button>
                </div>
                <div class="plinko-board">
                    <div class="plinko-ball" id="plinkoBall"></div>
                    <div class="plinko-pegs">
                        ${Array(7).fill().map(() => `
                            <div class="peg-row">
                                ${Array(Math.floor(Math.random() * 5) + 3).fill().map(() => '<div class="peg"></div>').join('')}
                            </div>
                        `).join('')}
                    </div>
                    <div class="plinko-slots">
                        <div class="slot" data-multiplier="0.1">0.1x</div>
                        <div class="slot" data-multiplier="0.5">0.5x</div>
                        <div class="slot" data-multiplier="1">1x</div>
                        <div class="slot" data-multiplier="5">5x</div>
                        <div class="slot" data-multiplier="100">100x</div>
                    </div>
                </div>
                <div id="plinkoResult" style="text-align: center; margin-top: 1rem; font-size: 1.25rem; font-weight: 600;"></div>
            `;
        }
        
        async function playPlinko() {
            const bet = parseFloat(document.getElementById('plinkoBet').value);
            if (isNaN(bet) || bet <= 0 || bet > currentBalance) {
                alert('Invalid bet amount');
                return;
            }
            
            // Animate ball drop
            const ball = document.getElementById('plinkoBall');
            ball.classList.add('dropping');
            
            // Weighted slot selection (house edge)
            const slots = [
                { mult: 0.1, weight: 45 },
                { mult: 0.5, weight: 25 },
                { mult: 1, weight: 15 },
                { mult: 5, weight: 10 },
                { mult: 100, weight: 5 }
            ];
            
            let roll = Math.random() * 100;
            let selectedSlot = slots[0];
            let cumulative = 0;
            
            for (const slot of slots) {
                cumulative += slot.weight;
                if (roll <= cumulative) {
                    selectedSlot = slot;
                    break;
                }
            }
            
            const winAmount = bet * selectedSlot.mult;
            
            setTimeout(async () => {
                ball.classList.remove('dropping');
                
                const resultDiv = document.getElementById('plinkoResult');
                if (selectedSlot.mult >= 1) {
                    resultDiv.innerHTML = `<span style="color: var(--success);">WIN! ${selectedSlot.mult}x = $${winAmount.toFixed(2)}</span>`;
                } else {
                    resultDiv.innerHTML = `<span style="color: var(--danger);">Lost! ${selectedSlot.mult}x = $${winAmount.toFixed(2)}</span>`;
                }
                
                // Record result
                try {
                    const data = await apiCall('recordGambling', {
                        email: currentUser.email,
                        game: 'Plinko',
                        wagered: bet,
                        won: winAmount,
                        lost: winAmount < bet ? bet - winAmount : 0,
                        result: `${selectedSlot.mult}x multiplier`
                    });
                    
                    if (data.success) {
                        currentBalance = data.newBalance;
                        document.getElementById('userBalance').textContent = currentBalance.toFixed(2);
                    }
                } catch (error) {
                    console.error('Gambling record error:', error);
                }
            }, 2000);
        }
        
        // Roulette
        function initRoulette() {
            const container = document.getElementById('rouletteGame');
            container.innerHTML = `
                <div class="game-header">
                    <h2 class="game-title">Roulette</h2>
                    <button class="btn-back" onclick="backToCasino()">Back</button>
                </div>
                <div class="roulette-wheel" id="rouletteWheel">
                    <div class="roulette-pointer"></div>
                    <div class="roulette-center">SPIN</div>
                </div>
                <div class="game-controls">
                    <input type="number" id="rouletteBet" class="bet-input" placeholder="Bet amount" min="1" value="100">
                </div>
                <div class="roulette-bets">
                    <div class="bet-option red" onclick="selectRouletteBet('red')">Red</div>
                    <div class="bet-option black" onclick="selectRouletteBet('black')">Black</div>
                    <div class="bet-option green" onclick="selectRouletteBet('green')">Green</div>
                    <div class="bet-option" onclick="selectRouletteBet('odd')">Odd</div>
                    <div class="bet-option" onclick="selectRouletteBet('even')">Even</div>
                    <div class="bet-option" onclick="selectRouletteBet('1-18')">1-18</div>
                </div>
                <button class="btn btn-primary btn-block" style="margin-top: 1rem;" onclick="spinRoulette()">Spin Wheel</button>
                <div id="rouletteResult" style="text-align: center; margin-top: 1rem; font-size: 1.25rem; font-weight: 600;"></div>
            `;
        }
        
        let rouletteBet = null;
        
        function selectRouletteBet(bet) {
            rouletteBet = bet;
            document.querySelectorAll('.bet-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }
        
        async function spinRoulette() {
            if (!rouletteBet) {
                alert('Please select a bet');
                return;
                const bet = parseFloat(document.getElementById('rouletteBet').value);
            if (isNaN(bet) || bet <= 0 || bet > currentBalance) {
                alert('Invalid bet amount');
                return;
            }
            
            const wheel = document.getElementById('rouletteWheel');
            wheel.classList.add('spinning');
            
            // Generate result (house edge - only 40% win chance even on 50/50 bets)
            const number = Math.floor(Math.random() * 37); // 0-36
            const isRed = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36].includes(number);
            const isBlack = !isRed && number !== 0;
            const isGreen = number === 0;
            
            let won = false;
            let payout = 0;
            
            // Calculate win (with house edge)
            const winRoll = Math.random();
            
            switch(rouletteBet) {
                case 'red':
                    won = isRed && winRoll < 0.4; // 40% chance even if correct
                    payout = won ? bet * 2 : 0;
                    break;
                case 'black':
                    won = isBlack && winRoll < 0.4;
                    payout = won ? bet * 2 : 0;
                    break;
                case 'green':
                    won = isGreen && winRoll < 0.2; // Very rare
                    payout = won ? bet * 35 : 0;
                    break;
                case 'odd':
                    won = (number % 2 === 1) && winRoll < 0.4;
                    payout = won ? bet * 2 : 0;
                    break;
                case 'even':
                    won = (number % 2 === 0 && number !== 0) && winRoll < 0.4;
                    payout = won ? bet * 2 : 0;
                    break;
                case '1-18':
                    won = (number >= 1 && number <= 18) && winRoll < 0.4;
                    payout = won ? bet * 2 : 0;
                    break;
            }
            
            setTimeout(async () => {
                wheel.classList.remove('spinning');
                
                const color = isGreen ? 'Green' : isRed ? 'Red' : 'Black';
                const resultDiv = document.getElementById('rouletteResult');
                
                if (won) {
                    resultDiv.innerHTML = `<span style="color: var(--success);">WIN! ${number} ${color} - Won $${payout.toFixed(2)}</span>`;
                } else {
                    resultDiv.innerHTML = `<span style="color: var(--danger);">Lost! ${number} ${color}</span>`;
                }
                
                // Record result
                try {
                    const data = await apiCall('recordGambling', {
                        email: currentUser.email,
                        game: 'Roulette',
                        wagered: bet,
                        won: payout,
                        lost: won ? 0 : bet,
                        result: `${number} ${color} - Bet on ${rouletteBet}`
                    });
                    
                    if (data.success) {
                        currentBalance = data.newBalance;
                        document.getElementById('userBalance').textContent = currentBalance.toFixed(2);
                    }
                } catch (error) {
                    console.error('Gambling record error:', error);
                }
            }, 3000);
        }
        
        // Dice
        function initDice() {
            const container = document.getElementById('diceGame');
            container.innerHTML = `
                <div class="game-header">
                    <h2 class="game-title">Dice</h2>
                    <button class="btn-back" onclick="backToCasino()">Back</button>
                </div>
                <div class="dice-container">
                    <div class="die" id="die1">?</div>
                    <div class="die" id="die2">?</div>
                </div>
                <div class="game-controls">
                    <input type="number" id="diceBet" class="bet-input" placeholder="Bet amount" min="1" value="100">
                    <select id="diceBetType" class="form-input" style="width: 150px;">
                        <option value="over">Over 7</option>
                        <option value="under">Under 7</option>
                        <option value="seven">Exactly 7</option>
                    </select>
                    <button class="btn btn-primary" onclick="rollDice()">Roll Dice</button>
                </div>
                <div id="diceResult" style="text-align: center; margin-top: 1rem; font-size: 1.25rem; font-weight: 600;"></div>
            `;
        }
        
        async function rollDice() {
            const bet = parseFloat(document.getElementById('diceBet').value);
            const betType = document.getElementById('diceBetType').value;
            
            if (isNaN(bet) || bet <= 0 || bet > currentBalance) {
                alert('Invalid bet amount');
                return;
            }
            
            const die1 = document.getElementById('die1');
            const die2 = document.getElementById('die2');
            
            die1.classList.add('rolling');
            die2.classList.add('rolling');
            
            const roll1 = Math.floor(Math.random() * 6) + 1;
            const roll2 = Math.floor(Math.random() * 6) + 1;
            const total = roll1 + roll2;
            
            setTimeout(async () => {
                die1.classList.remove('rolling');
                die2.classList.remove('rolling');
                die1.textContent = roll1;
                die2.textContent = roll2;
                
                let won = false;
                let payout = 0;
                
                // House edge - reduce win probability
                const winRoll = Math.random();
                
                switch(betType) {
                    case 'over':
                        won = total > 7 && winRoll < 0.4; // 40% win chance even if correct
                        payout = won ? bet * 1.9 : 0;
                        break;
                    case 'under':
                        won = total < 7 && winRoll < 0.4;
                        payout = won ? bet * 1.9 : 0;
                        break;
                    case 'seven':
                        won = total === 7 && winRoll < 0.3; // Lower chance for exact
                        payout = won ? bet * 4 : 0;
                        break;
                }
                
                const resultDiv = document.getElementById('diceResult');
                if (won) {
                    resultDiv.innerHTML = `<span style="color: var(--success);">WIN! Rolled ${total} - Won $${payout.toFixed(2)}</span>`;
                } else {
                    resultDiv.innerHTML = `<span style="color: var(--danger);">Lost! Rolled ${total}</span>`;
                }
                
                // Record result
                try {
                    const data = await apiCall('recordGambling', {
                        email: currentUser.email,
                        game: 'Dice',
                        wagered: bet,
                        won: payout,
                        lost: won ? 0 : bet,
                        result: `Rolled ${total} - Bet ${betType}`
                    });
                    
                    if (data.success) {
                        currentBalance = data.newBalance;
                        document.getElementById('userBalance').textContent = currentBalance.toFixed(2);
                    }
                } catch (error) {
                    console.error('Gambling record error:', error);
                }
            }, 500);
        }
        
        // Slots
        function initSlots() {
            const container = document.getElementById('slotsGame');
            container.innerHTML = `
                <div class="game-header">
                    <h2 class="game-title">Slots</h2>
                    <button class="btn-back" onclick="backToCasino()">Back</button>
                </div>
                <div class="slots-machine">
                    <div class="slots-display">
                        <div class="slot-reel" id="reel1"></div>
                        <div class="slot-reel" id="reel2"></div>
                        <div class="slot-reel" id="reel3"></div>
                    </div>
                    <div class="game-controls">
                        <input type="number" id="slotsBet" class="bet-input" placeholder="Bet amount" min="1" value="100">
                        <button class="btn btn-primary" onclick="spinSlots()">Spin ($100)</button>
                    </div>
                </div>
                <div id="slotsResult" style="text-align: center; margin-top: 1rem; font-size: 1.25rem; font-weight: 600;"></div>
            `;
        }
        
        async function spinSlots() {
            const bet = parseFloat(document.getElementById('slotsBet').value);
            if (isNaN(bet) || bet <= 0 || bet > currentBalance) {
                alert('Invalid bet amount');
                return;
            }
            
            const symbols = ['', '', '', '', '', '7'];
            const reels = ['reel1', 'reel2', 'reel3'];
            
            reels.forEach(reel => {
                document.getElementById(reel).classList.add('spinning');
            });
            
            // Weighted results (house edge)
            const getSymbol = () => {
                const roll = Math.random();
                if (roll < 0.3) return '';
                if (roll < 0.5) return '';
                if (roll < 0.7) return '';
                if (roll < 0.85) return '';
                if (roll < 0.95) return '';
                return '7';
            };
            
            const results = [getSymbol(), getSymbol(), getSymbol()];
            
            // Force loss 60% of the time
            if (Math.random() < 0.6) {
                results[Math.floor(Math.random() * 3)] = symbols[Math.floor(Math.random() * symbols.length)];
            }
            
            setTimeout(async () => {
                reels.forEach((reel, i) => {
                    const el = document.getElementById(reel);
                    el.classList.remove('spinning');
                    el.textContent = results[i];
                });
                
                let payout = 0;
                let message = '';
                
                if (results[0] === results[1] && results[1] === results[2]) {
                    // Three of a kind
                    if (results[0] === '7') {
                        payout = bet * 100; // Jackpot
                        message = 'JACKPOT!!!';
                    } else if (results[0] === '') {
                        payout = bet * 50;
                        message = 'Diamond Triple!';
                    } else {
                        payout = bet * 10;
                        message = 'Triple Match!';
                    }
                } else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
                    // Two of a kind
                    payout = bet * 2;
                    message = 'Double Match';
                }
                
                const resultDiv = document.getElementById('slotsResult');
                if (payout > 0) {
                    resultDiv.innerHTML = `<span style="color: var(--success);">${message} Won $${payout.toFixed(2)}</span>`;
                } else {
                    resultDiv.innerHTML = `<span style="color: var(--danger);">No match - Lost $${bet.toFixed(2)}</span>`;
                }
                
                // Record result
                try {
                    const data = await apiCall('recordGambling', {
                        email: currentUser.email,
                        game: 'Slots',
                        wagered: bet,
                        won: payout,
                        lost: payout > 0 ? 0 : bet,
                        result: results.join(' ')
                    });
                    
                    if (data.success) {
                        currentBalance = data.newBalance;
                        document.getElementById('userBalance').textContent = currentBalance.toFixed(2);
                    }
                } catch (error) {
                    console.error('Gambling record error:', error);
                }
            }, 1000);
        }
        
        // Fortune Wheel
        function initFortune() {
            const container = document.getElementById('fortuneGame');
            container.innerHTML = `
                <div class="game-header">
                    <h2 class="game-title">Fortune Wheel</h2>
                    <button class="btn-back" onclick="backToCasino()">Back</button>
                </div>
                <div class="fortune-wheel" id="fortuneWheel">
                    <div class="fortune-segments">
                        ${Array(8).fill().map((_, i) => `<div class="fortune-segment"></div>`).join('')}
                    </div>
                    <div class="roulette-pointer"></div>
                </div>
                <div class="game-controls">
                    <input type="number" id="fortuneBet" class="bet-input" placeholder="Bet amount" min="1" value="100">
                    <button class="btn btn-primary" onclick="spinFortune()">Spin Wheel</button>
                </div>
                <div id="fortuneResult" style="text-align: center; margin-top: 1rem; font-size: 1.25rem; font-weight: 600;"></div>
            `;
        }
        
        async function spinFortune() {
            const bet = parseFloat(document.getElementById('fortuneBet').value);
            if (isNaN(bet) || bet <= 0 || bet > currentBalance) {
                alert('Invalid bet amount');
                return;
            }
            
            const wheel = document.getElementById('fortuneWheel');
            const rotation = Math.floor(Math.random() * 360) + 720; // At least 2 full rotations
            wheel.style.transform = `rotate(${rotation}deg)`;
            
            // Weighted segments (house edge)
            const segments = [
                { mult: 0, weight: 20 },
                { mult: 0.5, weight: 25 },
                { mult: 1, weight: 20 },
                { mult: 1.5, weight: 15 },
                { mult: 2, weight: 10 },
                { mult: 3, weight: 5 },
                { mult: 5, weight: 3 },
                { mult: 10, weight: 2 }
            ];
            
            let roll = Math.random() * 100;
            let selected = segments[0];
            let cumulative = 0;
            
            for (const segment of segments) {
                cumulative += segment.weight;
                if (roll <= cumulative) {
                    selected = segment;
                    break;
                }
            }
            
            const payout = bet * selected.mult;
            
            setTimeout(async () => {
                const resultDiv = document.getElementById('fortuneResult');
                if (selected.mult > 1) {
                    resultDiv.innerHTML = `<span style="color: var(--success);">WIN! ${selected.mult}x = $${payout.toFixed(2)}</span>`;
                } else if (selected.mult === 0) {
                    resultDiv.innerHTML = `<span style="color: var(--danger);">Lost everything!</span>`;
                } else {
                    resultDiv.innerHTML = `<span style="color: var(--warning);">${selected.mult}x = $${payout.toFixed(2)}</span>`;
                }
                
                // Record result
                try {
                    const data = await apiCall('recordGambling', {
                        email: currentUser.email,
                        game: 'Fortune Wheel',
                        wagered: bet,
                        won: payout,
                        lost: payout < bet ? bet - payout : 0,
                        result: `${selected.mult}x multiplier`
                    });
                    
                    if (data.success) {
                        currentBalance = data.newBalance;
                        document.getElementById('userBalance').textContent = currentBalance.toFixed(2);
                    }
                } catch (error) {
                    console.error('Gambling record error:', error);
                }
            }, 3000);
        }
        
        // Blackjack
        function initBlackjack() {
            const container = document.getElementById('blackjackGame');
            container.innerHTML = `
                <div class="game-header">
                    <h2 class="game-title">Blackjack</h2>
                    <button class="btn-back" onclick="backToCasino()">Back</button>
                </div>
                <div class="blackjack-table">
                    <div class="blackjack-hands">
                        <div class="hand">
                            <div class="hand-label">Dealer</div>
                            <div class="cards" id="dealerHand"></div>
                            <div class="hand-total" id="dealerTotal"></div>
                        </div>
                        <div class="hand">
                            <div class="hand-label">Your Hand</div>
                            <div class="cards" id="playerHand"></div>
                            <div class="hand-total" id="playerTotal"></div>
                        </div>
                    </div>
                    <div class="game-controls">
                        <input type="number" id="blackjackBet" class="bet-input" placeholder="Bet amount" min="1" value="100">
                        <button class="btn btn-primary" id="dealBtn" onclick="dealBlackjack()">Deal</button>
                        <button class="btn btn-success" id="hitBtn" onclick="hitBlackjack()" style="display:none;">Hit</button>
                        <button class="btn btn-warning" id="standBtn" onclick="standBlackjack()" style="display:none;">Stand</button>
                    </div>
                </div>
                <div id="blackjackResult" style="text-align: center; margin-top: 1rem; font-size: 1.25rem; font-weight: 600;"></div>
            `;
        }
        
        function createDeck() {
            const suits = ['', '', '', ''];
            const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const deck = [];
            
            for (const suit of suits) {
                for (const value of values) {
                    deck.push({ suit, value });
                }
            }
            
            // Shuffle
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            
            return deck;
        }
        
        function getHandValue(hand) {
            let value = 0;
            let aces = 0;
            
            for (const card of hand) {
                if (card.value === 'A') {
                    aces++;
                    value += 11;
                } else if (['J', 'Q', 'K'].includes(card.value)) {
                    value += 10;
                } else {
                    value += parseInt(card.value);
                }
            }
            
            while (value > 21 && aces > 0) {
                value -= 10;
                aces--;
            }
            
            return value;
        }
        
        function displayCard(card) {
            const color = ['', ''].includes(card.suit) ? 'red' : 'black';
            return `<div class="card ${color}">${card.value}${card.suit}</div>`;
        }
        
        async function dealBlackjack() {
            const bet = parseFloat(document.getElementById('blackjackBet').value);
            if (isNaN(bet) || bet <= 0 || bet > currentBalance) {
                alert('Invalid bet amount');
                return;
            }
            
            blackjackState = {
                deck: createDeck(),
                playerHand: [],
                dealerHand: [],
                bet: bet,
                gameOver: false
            };
            
            // Deal initial cards
            blackjackState.playerHand.push(blackjackState.deck.pop());
            blackjackState.dealerHand.push(blackjackState.deck.pop());
            blackjackState.playerHand.push(blackjackState.deck.pop());
            blackjackState.dealerHand.push(blackjackState.deck.pop());
            
            updateBlackjackDisplay();
            
            // Check for blackjack
            const playerValue = getHandValue(blackjackState.playerHand);
            if (playerValue === 21) {
                endBlackjack('blackjack');
            } else {
                document.getElementById('dealBtn').style.display = 'none';
                document.getElementById('hitBtn').style.display = 'inline-block';
                document.getElementById('standBtn').style.display = 'inline-block';
            }
        }
        
        function updateBlackjackDisplay() {
            if (!blackjackState) return;
            
            const playerHandEl = document.getElementById('playerHand');
            const dealerHandEl = document.getElementById('dealerHand');
            const playerTotalEl = document.getElementById('playerTotal');
            const dealerTotalEl = document.getElementById('dealerTotal');
            
            playerHandEl.innerHTML = blackjackState.playerHand.map(displayCard).join('');
            playerTotalEl.textContent = getHandValue(blackjackState.playerHand);
            
            if (blackjackState.gameOver) {
                dealerHandEl.innerHTML = blackjackState.dealerHand.map(displayCard).join('');
                dealerTotalEl.textContent = getHandValue(blackjackState.dealerHand);
            } else {
                dealerHandEl.innerHTML = displayCard(blackjackState.dealerHand[0]) + '<div class="card">?</div>';
                dealerTotalEl.textContent = '?';
            }
        }
        
        function hitBlackjack() {
            blackjackState.playerHand.push(blackjackState.deck.pop());
            updateBlackjackDisplay();
            
            const value = getHandValue(blackjackState.playerHand);
            if (value > 21) {
                endBlackjack('bust');
            } else if (value === 21) {
                standBlackjack();
            }
        }
        
        function standBlackjack() {
            // Dealer plays
            while (getHandValue(blackjackState.dealerHand) < 17) {
                blackjackState.dealerHand.push(blackjackState.deck.pop());
            }
            
            const playerValue = getHandValue(blackjackState.playerHand);
            const dealerValue = getHandValue(blackjackState.dealerHand);
            
            if (dealerValue > 21) {
                endBlackjack('dealer_bust');
            } else if (dealerValue > playerValue) {
                endBlackjack('lose');
            } else if (playerValue > dealerValue) {
                endBlackjack('win');
            } else {
                endBlackjack('push');
            }
        }
        
        async function endBlackjack(result) {
            blackjackState.gameOver = true;
            updateBlackjackDisplay();
            
            document.getElementById('hitBtn').style.display = 'none';
            document.getElementById('standBtn').style.display = 'none';
            document.getElementById('dealBtn').style.display = 'inline-block';
            
            let payout = 0;
            let message = '';
            
            switch(result) {
                case 'blackjack':
                    payout = blackjackState.bet * 2.5;
                    message = 'BLACKJACK!';
                    break;
                case 'win':
                case 'dealer_bust':
                    payout = blackjackState.bet * 2;
                    message = result === 'dealer_bust' ? 'Dealer Bust! You Win!' : 'You Win!';
                    break;
                case 'push':
                    payout = blackjackState.bet;
                    message = 'Push - Bet Returned';
                    break;
                case 'lose':
                case 'bust':
                    payout = 0;
                    message = result === 'bust' ? 'Bust! You Lose!' : 'You Lose!';
                    break;
            }
            
            const resultDiv = document.getElementById('blackjackResult');
            if (payout > blackjackState.bet) {
                resultDiv.innerHTML = `<span style="color: var(--success);">${message} Won $${payout.toFixed(2)}</span>`;
            } else if (payout === blackjackState.bet) {
                resultDiv.innerHTML = `<span style="color: var(--warning);">${message}</span>`;
            } else {
                resultDiv.innerHTML = `<span style="color: var(--danger);">${message}</span>`;
            }
            
            // Record result
            try {
                const data = await apiCall('recordGambling', {
                    email: currentUser.email,
                    game: 'Blackjack',
                    wagered: blackjackState.bet,
                    won: payout,
                    lost: payout === 0 ? blackjackState.bet : 0,
                    result: message
                });
                
                if (data.success) {
                    currentBalance = data.newBalance;
                    document.getElementById('userBalance').textContent = currentBalance.toFixed(2);
                }
            } catch (error) {
                console.error('Gambling record error:', error);
            }
        }
        
        // Chat
        async function loadChat() {
            try {
                const data = await apiCall('getChat', { limit: 50 });
                
                if (data.success) {
                    const messagesDiv = document.getElementById('chatMessages');
                    messagesDiv.innerHTML = '';
                    
                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach(msg => {
                            const messageEl = document.createElement('div');
                            messageEl.className = 'chat-message';
                            
                            const time = new Date(msg.timestamp).toLocaleTimeString();
                            
                            messageEl.innerHTML = `
                                <div class="chat-message-header">
                                    <span class="chat-username">${msg.name}</span>
                                    <span class="chat-time">${time}</span>
                                </div>
                                <div class="chat-text">${msg.message}</div>
                            `;
                            
                            messagesDiv.appendChild(messageEl);
                        });
                        
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                }
            } catch (error) {
                console.error('Chat load error:', error);
            }
        }
        
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                const data = await apiCall('sendChat', {
                    email: currentUser.email,
                    name: currentUser.name,
                    message: message
                });
                
                if (data.success) {
                    input.value = '';
                    loadChat();
                }
            } catch (error) {
                console.error('Chat send error:', error);
            }
        }
        
        // Leaderboards
        async function loadLeaderboard(type) {
            try {
                const data = await apiCall('getLeaderboard', { type: type });
                
                if (data.success) {
                    const list = document.getElementById('leaderboardList');
                    list.innerHTML = '';
                    
                    if (data.users && data.users.length > 0) {
                        data.users.forEach((user, index) => {
                            const item = document.createElement('div');
                            item.className = 'leaderboard-item';
                            
                            let rankClass = '';
                            if (index === 0) rankClass = 'rank-1';
                            else if (index === 1) rankClass = 'rank-2';
                            else if (index === 2) rankClass = 'rank-3';
                            
                            let scoreValue = '';
                            if (type === 'wealth') {
                                scoreValue = `$${user.balance.toFixed(2)}`;
                            } else if (type === 'credit') {
                                scoreValue = user.creditScore;
                            } else if (type === 'emoji') {
                                scoreValue = `${user.emojiScore.toLocaleString()} pts`;
                            }
                            
                            item.innerHTML = `
                                <div class="leaderboard-rank ${rankClass}">${index + 1}</div>
                                <div class="leaderboard-user">
                                    <div class="leaderboard-name">${user.name}</div>
                                    <div class="leaderboard-email">${user.email}</div>
                                </div>
                                <div class="leaderboard-score">${scoreValue}</div>
                            `;
                            
                            list.appendChild(item);
                        });
                    } else {
                        list.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--text-light);">No data available</p>';
                    }
                }
            } catch (error) {
                console.error('Leaderboard error:', error);
            }
        }
        
        // Settings
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
            document.getElementById('settingsEmail').value = currentUser.email;
            document.getElementById('settingsName').value = currentUser.name;
            document.getElementById('settingsSince').value = new Date(currentUser.createdAt || Date.now()).toLocaleDateString();
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
            document.getElementById('resetPreview').style.display = 'none';
        }
        
        async function previewReset() {
            try {
                const data = await apiCall('getResetPreview', { email: currentUser.email });
                
                if (data.success) {
                    const preview = document.getElementById('resetPreview');
                    const details = document.getElementById('resetDetails');
                    
                    details.innerHTML = `
                        <h4>Reset Preview</h4>
                        <p><strong>Account Age:</strong> ${Math.floor((Date.now() - new Date(data.createdAt)) / (1000 * 60 * 60 * 24))} days</p>
                        <p><strong>Total Earned:</strong> $${data.totalEarned.toFixed(2)}</p>
                        <p><strong>Gambling Losses:</strong> $${data.gamblingLosses.toFixed(2)}</p>
                        <p><strong>Current Credit Score:</strong> ${data.creditScore}</p>
                        <hr>
                        <p><strong>Gambling Penalty:</strong> -$${data.gamblingPenalty.toFixed(2)}</p>
                        <p><strong>Loan Penalty:</strong> -$${data.loanPenalty.toFixed(2)}</p>
                        <p><strong>Credit Adjustment:</strong> ${data.creditAdjustment >= 0 ? '+' : ''}$${data.creditAdjustment.toFixed(2)}</p>
                        <hr>
                        <p style="font-size: 1.25rem;"><strong>New Starting Balance:</strong> $${data.newBalance.toFixed(2)}</p>
                    `;
                    
                    preview.style.display = 'block';
                }
            } catch (error) {
                alert('Error getting reset preview: ' + error.message);
            }
        }
        
        async function confirmReset() {
            if (!confirm('Are you absolutely sure? This will reset all your data except username and email.')) {
                return;
            }
            
            try {
                const data = await apiCall('resetAccount', { email: currentUser.email });
                
                if (data.success) {
                    alert(`Account reset! New balance: $${data.newBalance.toFixed(2)}`);
                    currentUser.balance = data.newBalance;
                    currentUser.creditScore = 650;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    closeSettings();
                    loadDashboard();
                }
            } catch (error) {
                alert('Reset error: ' + error.message);
            }
        }
        
        // Event Listeners
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('registerBtn').addEventListener('click', register);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('transferBtn').addEventListener('click', transfer);
        document.getElementById('settingsBtn').addEventListener('click', openSettings);
        document.getElementById('previewResetBtn').addEventListener('click', previewReset);
        document.getElementById('confirmResetBtn').addEventListener('click', confirmReset);
        document.getElementById('sendChatBtn').addEventListener('click', sendChat);
        
        document.getElementById('showRegister').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        });
        
        document.getElementById('showLogin').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        });
        
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChat();
            }
        });
        
        // Tab Navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update active states
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tabName).classList.add('active');
                
                // Load tab-specific data
                switch(tabName) {
                    case 'dashboard': loadDashboard(); break;
                    case 'stocks': loadStocks(); break;
                    case 'portfolio': loadPortfolio(); break;
                    case 'loans': loadLoans(); break;
                    case 'packs': loadPacks(); break;
                    case 'collection': loadCollection(); break;
                    case 'casino': loadCasino(); break;
                    case 'chat': loadChat(); break;
                    case 'leaders': loadLeaderboard('wealth'); break;
                }
            });
        });
        
        // Leaderboard Tabs
        document.querySelectorAll('.leaderboard-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.leaderboard-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                loadLeaderboard(tab.dataset.leaderboard);
            });
        });
        
        // Casino Game Cards
        document.querySelectorAll('.casino-game-card').forEach(card => {
            card.addEventListener('click', () => {
                selectGame(card.dataset.game);
            });
        });
        
        // Initialize
        const savedUser = localStorage.getItem('user');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            showApp();
        }
        
        // Auto-refresh chat
        setInterval(() => {
            if (currentUser && document.getElementById('chat').classList.contains('active')) {
                loadChat();
            }
        }, 5000);
    </script>
</body>
</html>
            }
